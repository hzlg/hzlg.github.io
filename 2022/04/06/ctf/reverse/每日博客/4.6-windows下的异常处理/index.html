<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="re," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="加密与解密 : windows下的异常处理，SEH+VEH[栈展开，TopLevel和SEHOP没写](第8章：Windows 下的异常处理-SEH - Rev_omi - 博客园 (cnblogs.com))">
<meta property="og:type" content="article">
<meta property="og:title" content="4.6-windows下的异常处理">
<meta property="og:url" content="https://hzlg.github.ioz/2022/04/06/ctf/reverse/%E6%AF%8F%E6%97%A5%E5%8D%9A%E5%AE%A2/4.6-windows%E4%B8%8B%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/index.html">
<meta property="og:site_name" content="hzlg&#39;s blog">
<meta property="og:description" content="加密与解密 : windows下的异常处理，SEH+VEH[栈展开，TopLevel和SEHOP没写](第8章：Windows 下的异常处理-SEH - Rev_omi - 博客园 (cnblogs.com))">
<meta property="og:locale">
<meta property="og:image" content="https://hzlg.github.ioz/2022/04/06/ctf/reverse/%E6%AF%8F%E6%97%A5%E5%8D%9A%E5%AE%A2/4.6-windows%E4%B8%8B%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/image-20220413110029465.png">
<meta property="og:image" content="https://hzlg.github.ioz/2022/04/06/ctf/reverse/%E6%AF%8F%E6%97%A5%E5%8D%9A%E5%AE%A2/4.6-windows%E4%B8%8B%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/image-20220413105406038.png">
<meta property="og:image" content="https://hzlg.github.ioz/2022/04/06/ctf/reverse/%E6%AF%8F%E6%97%A5%E5%8D%9A%E5%AE%A2/4.6-windows%E4%B8%8B%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/image-20220413142237880.png">
<meta property="og:image" content="https://hzlg.github.ioz/2022/04/06/ctf/reverse/%E6%AF%8F%E6%97%A5%E5%8D%9A%E5%AE%A2/4.6-windows%E4%B8%8B%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/image-20220413152817882.png">
<meta property="og:image" content="https://hzlg.github.ioz/2022/04/06/ctf/reverse/%E6%AF%8F%E6%97%A5%E5%8D%9A%E5%AE%A2/4.6-windows%E4%B8%8B%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/image-20220413162017434.png">
<meta property="og:image" content="https://hzlg.github.ioz/2022/04/06/ctf/reverse/%E6%AF%8F%E6%97%A5%E5%8D%9A%E5%AE%A2/4.6-windows%E4%B8%8B%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/image-20220412183133529.png">
<meta property="og:image" content="https://hzlg.github.ioz/2022/04/06/ctf/reverse/%E6%AF%8F%E6%97%A5%E5%8D%9A%E5%AE%A2/4.6-windows%E4%B8%8B%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/image-20220412174913915.png">
<meta property="article:published_time" content="2022-04-05T16:00:00.000Z">
<meta property="article:modified_time" content="2022-04-20T04:09:20.000Z">
<meta property="article:author" content="hzlg">
<meta property="article:tag" content="re">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hzlg.github.ioz/2022/04/06/ctf/reverse/%E6%AF%8F%E6%97%A5%E5%8D%9A%E5%AE%A2/4.6-windows%E4%B8%8B%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/image-20220413110029465.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://hzlg.github.ioz/2022/04/06/ctf/reverse/每日博客/4.6-windows下的异常处理/"/>





  <title>4.6-windows下的异常处理 | hzlg's blog</title>
  














<meta name="generator" content="Hexo 5.4.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">hzlg's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">笔记、日常</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hzlg.github.ioz/2022/04/06/ctf/reverse/%E6%AF%8F%E6%97%A5%E5%8D%9A%E5%AE%A2/4.6-windows%E4%B8%8B%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hzlg's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">4.6-windows下的异常处理</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2022-04-06T00:00:00+08:00">
                2022-04-06
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2022-04-20T12:09:20+08:00">
                2022-04-20
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>加密与解密 : windows下的异常处理，SEH+VEH[栈展开，TopLevel和SEHOP没写](<a target="_blank" rel="noopener" href="https://www.cnblogs.com/Rev-omi/p/13893547.html">第8章：Windows 下的异常处理-SEH - Rev_omi - 博客园 (cnblogs.com)</a>)</p>
<span id="more"></span>

<p><a href="%5B(2%E6%9D%A1%E6%B6%88%E6%81%AF">SEH,VEH</a> VEH和SEH_鬼手56的博客-CSDN博客_seh和veh](<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_38474570/article/details/104346421">https://blog.csdn.net/qq_38474570/article/details/104346421</a>))</p>
<p>加密与解密</p>
<p>[云之君讲SEH](<a target="_blank" rel="noopener" href="https://bbs.xdsec.org/d/808-windows-seh">Windows异常处理-SEH学习 - XDSEC BBS</a>)</p>
<h1 id="windows下的异常处理"><a href="#windows下的异常处理" class="headerlink" title="windows下的异常处理"></a>windows下的异常处理</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>中断是由外部硬件或异步事件产生的(CPU启动外部硬件后转去做其他事。外部硬件完成输入输出后，向CPU发送中断报告I/O结果,由CPU决定如何处理)</p>
<p>异常是由内部事件产生的,包括故障,陷阱,和终止(溢出,除零等)</p>
<ul>
<li>由CPU引起的异常称为硬件异常(访问无效内存地址),由操作系统或应用程序引发的异常称为软件异常</li>
</ul>
<p><img src="/2022/04/06/ctf/reverse/%E6%AF%8F%E6%97%A5%E5%8D%9A%E5%AE%A2/4.6-windows%E4%B8%8B%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/image-20220413110029465.png" alt="image-20220413110029465"> </p>
<blockquote>
<p>常见异常列表</p>
<img src="/2022/04/06/ctf/reverse/%E6%AF%8F%E6%97%A5%E5%8D%9A%E5%AE%A2/4.6-windows%E4%B8%8B%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/image-20220413105406038.png" alt="image-20220413105406038" style="zoom: 25%;"> 
</blockquote>
<p>在代码中可以主动引发软件异常,调用RaiseExeception()函数即可 P314</p>
<h2 id="过程："><a href="#过程：" class="headerlink" title="过程："></a>过程：</h2><h2 id="CPU与操作系统交接-IDT表转移"><a href="#CPU与操作系统交接-IDT表转移" class="headerlink" title="CPU与操作系统交接: IDT表转移"></a>CPU与操作系统交接: IDT表转移</h2><p>有中断或异常发生时,CPU通过中断描述符表(Interrrupt Descriptor Table)<code>IDT表</code>来寻找处理函数,如nt!KiTrap03(对应上面的断点异常)</p>
<h2 id="信息封装-异常分发函数"><a href="#信息封装-异常分发函数" class="headerlink" title="信息封装+异常分发函数:"></a>信息封装+异常分发函数:</h2><p>CPU根据中断类型号(此时异常也被视作中断)执行对应的处理程序</p>
<p>异常处理程序(如nt!KiTrap03)将异常信息进行<strong>封装</strong>并且对异常进行<strong>处理</strong></p>
<p>封装的信息包括<code>EXCEPTION_RECORD</code>(异常代码,标志,地址等异常<code>基本信息</code>)与<code>陷阱帧</code>(保存发生异常时<code>线程的状态</code>,EBP,EIP,是否有参数,参数,寄存器状态等)</p>
<h3 id="EXCEPTION-RECORD-异常信息"><a href="#EXCEPTION-RECORD-异常信息" class="headerlink" title="EXCEPTION_RECORD 异常信息"></a>EXCEPTION_RECORD 异常信息</h3><p>异常处理函数<code>nt!KiDispatchException()</code>接受的第一个参数是一个指向EXCEPTION_RECORD结构体的指针。<br>EXCEPTION_RECORD定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_RECORD</span> &#123;</span></span><br><span class="line">  DWORD                    ExceptionCode;<span class="comment">//异常代码</span></span><br><span class="line">  DWORD                    ExceptionFlags;<span class="comment">//异常标志</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_RECORD</span> *<span class="title">ExceptionRecord</span>;</span><span class="comment">//指向另一个EXCEPTION_RECORD的指针</span></span><br><span class="line">  PVOID                    ExceptionAddress;<span class="comment">//异常发生地址</span></span><br><span class="line">  DWORD                    NumberParameters;<span class="comment">//下面的ExceptionInformation含有的元素个数</span></span><br><span class="line">  ULONG_PTR                ExceptionInformation[EXCEPTION_MAXIMUM_PARAMETERS];<span class="comment">//附加信息</span></span><br><span class="line">&#125; EXCEPTION_RECORD;</span><br></pre></td></tr></table></figure>

<p>ExceptionCode字段定义了异常的产生原因,常见的ExceptionCode如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">EXCEPTION_ACCESS_VIOLATION         0xC0000005     </span><br><span class="line">程序企图读写一个不可访问的地址时引发的异常。例如企图读取0地址处的内存。</span><br><span class="line"></span><br><span class="line">EXCEPTION_ARRAY_BOUNDS_EXCEEDED    0xC000008C     </span><br><span class="line">数组访问越界时引发的异常。</span><br><span class="line"></span><br><span class="line">EXCEPTION_BREAKPOINT               0x80000003     </span><br><span class="line">触发断点时引发的异常。</span><br><span class="line"></span><br><span class="line">EXCEPTION_DATATYPE_MISALIGNMENT    0x80000002     </span><br><span class="line">程序读取一个未经对齐的数据时引发的异常。</span><br><span class="line"></span><br><span class="line">EXCEPTION_FLT_DENORMAL_OPERAND     0xC000008D     </span><br><span class="line">如果浮点数操作的操作数是非正常的，则引发该异常。所谓非正常，即它的值太小以至于不能用标准格式表示出来。</span><br><span class="line"></span><br><span class="line">EXCEPTION_FLT_DIVIDE_BY_ZERO       0xC000008E     </span><br><span class="line">浮点数除法的除数是0时引发该异常。</span><br><span class="line"></span><br><span class="line">EXCEPTION_FLT_INEXACT_RESULT       0xC000008F     </span><br><span class="line">浮点数操作的结果不能精确表示成小数时引发该异常。</span><br><span class="line"></span><br><span class="line">EXCEPTION_FLT_INVALID_OPERATION    0xC0000090     </span><br><span class="line">该异常表示不包括在这个表内的其它浮点数异常。</span><br><span class="line"></span><br><span class="line">EXCEPTION_FLT_OVERFLOW             0xC0000091     </span><br><span class="line">浮点数的指数超过所能表示的最大值时引发该异常。</span><br><span class="line"></span><br><span class="line">EXCEPTION_FLT_STACK_CHECK          0xC0000092     </span><br><span class="line">进行浮点数运算时栈发生溢出或下溢时引发该异常。</span><br><span class="line"></span><br><span class="line">EXCEPTION_FLT_UNDERFLOW            0xC0000093     </span><br><span class="line">浮点数的指数小于所能表示的最小值时引发该异常。</span><br><span class="line"></span><br><span class="line">EXCEPTION_ILLEGAL_INSTRUCTION      0xC000001D     </span><br><span class="line">程序企图执行一个无效的指令时引发该异常。</span><br><span class="line"></span><br><span class="line">EXCEPTION_IN_PAGE_ERROR            0xC0000006     </span><br><span class="line">程序要访问的内存页不在物理内存中时引发的异常。</span><br><span class="line"></span><br><span class="line">EXCEPTION_INT_DIVIDE_BY_ZERO       0xC0000094     </span><br><span class="line">整数除法的除数是0时引发该异常。</span><br><span class="line"></span><br><span class="line">EXCEPTION_INT_OVERFLOW             0xC0000095     </span><br><span class="line">整数操作的结果溢出时引发该异常。</span><br><span class="line"></span><br><span class="line">EXCEPTION_INVALID_DISPOSITION      0xC0000026     </span><br><span class="line">异常处理器返回一个无效的处理的时引发该异常。</span><br><span class="line"></span><br><span class="line">EXCEPTION_NONCONTINUABLE_EXCEPTION 0xC0000025     </span><br><span class="line">发生一个不可继续执行的异常时，如果程序继续执行，则会引发该异常。</span><br><span class="line"></span><br><span class="line">EXCEPTION_PRIV_INSTRUCTION         0xC0000096     </span><br><span class="line">程序企图执行一条当前CPU模式不允许的指令时引发该异常。</span><br><span class="line"></span><br><span class="line">EXCEPTION_SINGLE_STEP              0x80000004     </span><br><span class="line">标志寄存器的TF位为1时，每执行一条指令就会引发该异常。主要用于单步调试。</span><br><span class="line"></span><br><span class="line">EXCEPTION_STACK_OVERFLOW           0xC00000FD     </span><br><span class="line">栈溢出时引发该异常。</span><br></pre></td></tr></table></figure>



<h3 id="陷阱帧-CONTEXT-异常现场"><a href="#陷阱帧-CONTEXT-异常现场" class="headerlink" title="陷阱帧/CONTEXT 异常现场"></a>陷阱帧/CONTEXT 异常现场</h3><p>陷阱帧结构仅供系统内核自身或者调试系统使用,控制权交给用户注册的异常处理程序时,会将陷阱帧转换为CONTEXT结构</p>
<p>异常处理函数<code>nt!KiDispatchException()</code>接受的第三个参数是指向CONTEXT结构体的指针，它用来备份CPU的值。<br>多线程环境下，每个线程内部都有一个CONTEXT结构体。CPU离开当前线程转而运行其他线程时，CPU寄存器的值被保存到当前线程的CONTEXT结构体中，当CPU返回该线程时，使用保存在CONTEXT结构体中的值来覆盖CPU各寄存器的值，以此来保证多线程安全。<br>CONTEXT结构体的定义如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">CONTEXT</span> &#123;</span></span><br><span class="line">    <span class="comment">//标志位,表示整个结构中哪些部分是有效的</span></span><br><span class="line">    DWORD ContextFlags;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//当ContextFlags包含CONTEXT_DEBUG_REGISTERS时以下部分有效,调试寄存器</span></span><br><span class="line">    DWORD   Dr0;                <span class="comment">//0x04</span></span><br><span class="line">    DWORD   Dr1;                <span class="comment">//0x08</span></span><br><span class="line">    DWORD   Dr2;                <span class="comment">//0x0c</span></span><br><span class="line">    DWORD   Dr3;                <span class="comment">//0x10</span></span><br><span class="line">    DWORD   Dr6;                <span class="comment">//0x14</span></span><br><span class="line">    DWORD   Dr7;                <span class="comment">//0x18</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//当ContextFlags包含CONTEXT_FLOATING_POINT时以下部分有效,浮点寄存器</span></span><br><span class="line">    FLOATING_SAVE_AREA FloatSave;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当ContextFlags包含CONTEXT_SEGMENTS时以下部分有效,段寄存器</span></span><br><span class="line">    DWORD   SegGs;              <span class="comment">//0x88</span></span><br><span class="line">    DWORD   SegFs;              <span class="comment">//0x90</span></span><br><span class="line">    DWORD   SegEs;              <span class="comment">//0x94</span></span><br><span class="line">    DWORD   SegDs;              <span class="comment">//0x98</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//当ContextFlags包含CONTEXT_INTEGER时以下部分有效,(整数)通用寄存器</span></span><br><span class="line">    DWORD   Edi;                <span class="comment">//0x9c</span></span><br><span class="line">    DWORD   Esi;                <span class="comment">//0xa0</span></span><br><span class="line">    DWORD   Ebx;                <span class="comment">//0xa4</span></span><br><span class="line">    DWORD   Edx;                <span class="comment">//0xa8</span></span><br><span class="line">    DWORD   Ecx;                <span class="comment">//0xac</span></span><br><span class="line">    DWORD   Eax;                <span class="comment">//0xb0</span></span><br><span class="line">    DWORD   Ebp;                <span class="comment">//0xb4</span></span><br><span class="line">    DWORD   Eip;                <span class="comment">//0xb8</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//当ContextFlags包含CONTEXT_CONTROL时以下部分有效,控制寄存器</span></span><br><span class="line">    DWORD   SegCs;              <span class="comment">//0xbc MUST BE SANITIZED</span></span><br><span class="line">    DWORD   EFlags;             <span class="comment">//0xc0 MUST BE SANITIZED</span></span><br><span class="line">    DWORD   Esp;                <span class="comment">//0xc4</span></span><br><span class="line">    DWORD   SegSs;              <span class="comment">//0xc8</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//当ContextFlags包含CONTEXT_EXTENED_REGISTERS时以下部分有效,扩展寄存器</span></span><br><span class="line">    BYTE    ExtendedRegisters[MAXIMUM_SUPPORTED_EXTENSION];</span><br><span class="line">&#125; CONTEXT;</span><br></pre></td></tr></table></figure>

<p>注意里面的Eip成员（偏移为0xb8），一般来讲Eip成员应该存储<code>触发异常后的代码地址</code>，即触发异常时的Eip值。<br>具体而言，<strong>当某一句代码触发异常，那么Eip的值应该指向这句代码的结束地址。</strong>这样当SEH处理完毕异常后，程序可以回到原来的地方，继续执行正常的代码。<br>但是， <strong>在异常处理函数中可能将参数传递过来的CONTEXT.Eip设置为其他地址，然后返回处理函数。</strong> 这样之前暂停的线程会执行新的EIP地址处的代码（反调试中经常使用这个技术）。</p>
<h3 id="nt-KiDispatchException-异常分发函数"><a href="#nt-KiDispatchException-异常分发函数" class="headerlink" title="nt!KiDispatchException() 异常分发函数"></a>nt!KiDispatchException() 异常分发函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">KiDispatchException</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PEXCEPTION_RECORD ExceptionRecord, <span class="comment">//异常结构信息</span></span></span></span><br><span class="line"><span class="params"><span class="function">    IN PKEXCEPTION_FRAME ExceptionFrame, <span class="comment">//对NT386系统总是为NULL,未使用</span></span></span></span><br><span class="line"><span class="params"><span class="function">    IN PKTRAP_FRAME TrapFrame, <span class="comment">//发生异常时的陷阱帧</span></span></span></span><br><span class="line"><span class="params"><span class="function">    IN KPROCESSOR_MODE PreviousMode, <span class="comment">//发生异常时的CPU模式是内核模式还是用户模式</span></span></span></span><br><span class="line"><span class="params"><span class="function">    IN BOOLEAN FirstChance <span class="comment">//是否第一次处理该异常</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br></pre></td></tr></table></figure>

<p>第一个和第三个参数就是刚刚封装的结构</p>
<h2 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h2><p>nt!KiDispatchException()根据是否存在内核调试器,用户态调试器完成不同的处理过程 </p>
 <img src="/2022/04/06/ctf/reverse/%E6%AF%8F%E6%97%A5%E5%8D%9A%E5%AE%A2/4.6-windows%E4%B8%8B%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/image-20220413142237880.png" alt="image-20220413142237880" style="zoom: 50%;">

<blockquote>
<p>当<strong>用户</strong>异常产生后，内核函数<code>KiDispatchException</code>并不是像处理内核异常那样在0环直接处理(调用<code>nt！RtlDispatchException（）</code>函数)，而是修正3环EIP为<code>KiUserExceptionDispatcher</code>函数后就结束了</p>
<p>这样，当线程再次回到3环时，将会从<code>ntdll!KiUserExceptionDispatcher</code>函数开始执行,以调用<code>ntdll!RtlDispatchException（）</code></p>
</blockquote>
<p>以用户态举例 : </p>
<ol>
<li><p><strong>交给调试器</strong>(进程必须被调试)</p>
</li>
<li><p><strong>执行VEH</strong></p>
</li>
<li><p><strong>执行SEH</strong></p>
</li>
<li><p><strong>TopLevelEH</strong>(进程被调试时不会被执行)</p>
</li>
<li><p><strong>交给调试器</strong>(上面的异常处理都说处理不了，就再次交给调试器)</p>
</li>
<li><p><strong>调用异常端口通知csrss.exe</strong></p>
</li>
</ol>
<p>用户态的<code>KiUserExceptionDispatcher()</code>和<code>RtlDispatchException（）</code>的具体实现在SEH部分</p>
<h1 id="SEH"><a href="#SEH" class="headerlink" title="SEH"></a>SEH</h1><p>无调试器参与时,系统靠SEH机制和VEH机制来进行异常处理</p>
<p>SEH告诉告诉系统当程序运行出现异常时<code>由谁来处理</code>,给了应用程序一个改正错误的机会(<code>系统在终结程序之前给程序提供的一个执行其预先设定的回调函数的机会</code>)</p>
<h2 id="SEH相关数据结构"><a href="#SEH相关数据结构" class="headerlink" title="SEH相关数据结构"></a>SEH相关数据结构</h2><h3 id="TIB-保存线程信息-指向处理链表"><a href="#TIB-保存线程信息-指向处理链表" class="headerlink" title="TIB 保存线程信息,指向处理链表"></a>TIB 保存线程信息,指向处理链表</h3><p>Thread Information Block,线程信息块,是保存线程基本信息的数据结构</p>
<p>位于内核中数据结构<code>TEB</code>的头部,<code>TEB</code>是操作系统为了保存每个线程的私有数据创建的,每个线程都有自己的TEB(包含了系统频繁使用的一些与线程相关的数据)<br>_NT_TIB结构体定义如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span>	_<span class="title">NT_TIB</span>&#123;</span> </span><br><span class="line">	 <span class="class"><span class="keyword">struct</span>	_<span class="title">EXCEPTION_REGISTRATION_RECORD</span> *<span class="title">ExceptionList</span>;</span> <span class="comment">//指向异常处理链表</span></span><br><span class="line">	 PVOID StackBase; <span class="comment">//当前线程所使用的的栈的栈底</span></span><br><span class="line">	 PVOID StackLimit; <span class="comment">//当前线程所使用的的栈的栈顶</span></span><br><span class="line">	 PVOID SubSystemTib; </span><br><span class="line">	 <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		PVOID FiberData; </span><br><span class="line">		DWORD Version;</span><br><span class="line">	 &#125;; </span><br><span class="line">	 PVOID ArbitraryUserPointer;</span><br><span class="line"> 	 <span class="class"><span class="keyword">struct</span>	_<span class="title">NT_TIB</span> *<span class="title">Self</span>;</span> <span class="comment">//指向TIB结构自身</span></span><br><span class="line">&#125; NT_TIB;</span><br><span class="line"><span class="keyword">typedef</span> NT_TIB *PNT_TIB;</span><br></pre></td></tr></table></figure>

<p>FS段寄存器指向TEB结构,fs:[0]即TEB头部,即TIB头部,即*ExceptionList</p>
<h3 id="SEH链-包含处理程序地址"><a href="#SEH链-包含处理程序地址" class="headerlink" title="SEH链 包含处理程序地址"></a>SEH链 包含处理程序地址</h3><p>SEH以链的形式存在。第一个异常处理中未处理相关异常，它就会被传递到下一个异常处理器，直到得到处理。<br>SEH链是由<code>_EXCEPTION_REGISTRATION_RECORD</code>结构体组成的链表，此结构体定义如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_REGISTRATION_RECORD</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_REGISTRATION_RECORD</span> *<span class="title">Next</span>;</span>  <span class="comment">//指向下一个 EXCEPTION_REGISTRATION_RECORD</span></span><br><span class="line">    PEXCEPTION_DISPOSITION Handler;  <span class="comment">//当前异常处理回调函数的地址</span></span><br><span class="line">&#125; EXCEPTION_REGISTRATION_RECORD,*PEXCEPTION_REGISTRATION_RECORD;</span><br></pre></td></tr></table></figure>

<p>如果你有一丢丢数据结构知识，你会发现这是一个最简单的链表结构：一个是元素值，一个是下一个元素的地址。而这里的元素值Handler就存储了当前节点的异常处理函数的地址，Next则指向下一个节点。若Next成员的值为FFFFFFFF，则表示它是链表最后一个结点。</p>
<img src="/2022/04/06/ctf/reverse/%E6%AF%8F%E6%97%A5%E5%8D%9A%E5%AE%A2/4.6-windows%E4%B8%8B%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/image-20220413152817882.png" alt="image-20220413152817882" style="zoom: 50%;"> 



<h3 id="EXCEPTION-POINTERS-索引到封装的信息"><a href="#EXCEPTION-POINTERS-索引到封装的信息" class="headerlink" title="_EXCEPTION_POINTERS 索引到封装的信息"></a>_EXCEPTION_POINTERS 索引到封装的信息</h3><p>操作系统会将异常信息转交给用户态的异常处理过程</p>
<p>实际上由于同一个线程能够在用户态和内核态使用的是两个不同的栈,为了让用户态的异常处理程序能够访问与异常相关的数据,操作系统需要把Exception_Record和CONTEXT(刚刚封装的信息)放到用户栈中。同时设置_EXCEPTION_POINTERS结构来索引</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_POINTERS</span> &#123;</span></span><br><span class="line">  PEXCEPTION_RECORD ExceptionRecord;</span><br><span class="line">  PCONTEXT          ContextRecord;</span><br><span class="line">&#125; EXCEPTION_POINTERS, *PEXCEPTION_POINTERS;</span><br></pre></td></tr></table></figure>

<p>这样用户态的异常处理程序就能够取得异常的具体信息和发生异常时线程的状态信息</p>
<p>SEH提供了两个可用于 <code>try-except</code> 语句的内部函数：</p>
<ul>
<li><code>GetExceptionCode</code><br>返回 (一个32位整数) 的代码，也就是上文提到过的异常原因相对应的异常值。</li>
<li><code>GetExceptionInformation</code><br>返回一个指向 EXCEPTION_POINTERS 结构的指针，该结构包含有关异常的其他信息。</li>
</ul>
<h2 id="SEH处理程序的安装和卸载"><a href="#SEH处理程序的安装和卸载" class="headerlink" title="SEH处理程序的安装和卸载"></a>SEH处理程序的安装和卸载</h2><p>要安装新的SEH处理程序时，填写新的ERR结构（SEH链中的结构体），插入表头即可</p>
<h2 id="返回值EXCEPTION-DISPOSITION"><a href="#返回值EXCEPTION-DISPOSITION" class="headerlink" title="返回值EXCEPTION_DISPOSITION"></a>返回值EXCEPTION_DISPOSITION</h2><p>异常处理函数的返回值是一个EXCEPTION_DISPOSITION的枚举类型，定义如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">EXCEPTION_DISPOSITION</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ExceptionContinueExecution = <span class="number">0</span>, <span class="comment">//已经处理了异常，回到异常触发点继续执行</span></span><br><span class="line">    ExceptionContinueSearch = <span class="number">1</span>,    <span class="comment">//没有处理异常，继续遍历异常链表</span></span><br><span class="line">    ExceptionNestedException = <span class="number">2</span>,   <span class="comment">//回调函数在试图处理该异常时再次发生了异常，用于系统内部的处理过程</span></span><br><span class="line">    ExceptionCollidedUnwind = <span class="number">3</span>     <span class="comment">//回调函数在试图恢复异常现场时再次发生了异常，用于系统内部的处理过程</span></span><br><span class="line">&#125;EXCEPTION_DISPOSITION;</span><br></pre></td></tr></table></figure>

<h2 id="具体异常分发"><a href="#具体异常分发" class="headerlink" title="具体异常分发"></a>具体异常分发</h2><p><strong>KiUserExceptionDispatcher():</strong></p>
<img src="/2022/04/06/ctf/reverse/%E6%AF%8F%E6%97%A5%E5%8D%9A%E5%AE%A2/4.6-windows%E4%B8%8B%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/image-20220413162017434.png" alt="image-20220413162017434" style="zoom: 33%;"> 



<p><strong>RtlDispatchException（）:</strong></p>
<p>首先调用<code>VEH ExceptionHandler</code>,返回值有两种:<code>EXCEPTION_CONTINUE_EXECUTION</code> / <code>EXCEPTION_CONTINUE_SEARCH</code></p>
<p>返回值不是<code>EXCEPTION_CONTINUE_SEARCH</code>(遍历后续结点)就结束异常分发过程</p>
<p>是的话就获取<code>栈的内存范围</code>,从fs:[0]获取<code>SEH链头结点</code></p>
<p><del>SEHOP机制启用，是一种对SEH链的安全性进行增强验证的机制</del></p>
<p><del>查询进程的ProcessExecuteFlags标志，决定是否进行SEHOP验证</del></p>
<p><del>查询失败或者没有设置标志位时进行SEHOP增强验证，只有确实查询到禁用了SEHOP才不进行</del></p>
<p>遍历<code>handler</code></p>
<p>最后调用<code>VEH ContinueHandler</code>进行异常处理</p>
<h1 id="VEH"><a href="#VEH" class="headerlink" title="VEH"></a>VEH</h1><img src="/2022/04/06/ctf/reverse/%E6%AF%8F%E6%97%A5%E5%8D%9A%E5%AE%A2/4.6-windows%E4%B8%8B%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/image-20220412183133529.png" alt="image-20220412183133529" style="zoom: 33%;"> 

<blockquote>
<p>VEH通过API : AddVectoredExceptionHandler注册回调函数</p>
<p>查看IDA的Exports窗口可以看到TlsCallback_0_0回调函数</p>
</blockquote>
<p> <img src="/2022/04/06/ctf/reverse/%E6%AF%8F%E6%97%A5%E5%8D%9A%E5%AE%A2/4.6-windows%E4%B8%8B%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/image-20220412174913915.png" alt="image-20220412174913915"> </p>
<h2 id="VEH与SEH异同"><a href="#VEH与SEH异同" class="headerlink" title="VEH与SEH异同"></a>VEH与SEH异同</h2><p>优先级 : 异常发生时,VEH先于SEH获得控制权</p>
<p>注册机制 : SEH相关信息保存在栈中,VEH保存在ntdll中的独立链表中,SEH注册一直位于前端,VEH注册时可以指定回调函数位于链表前端还是尾部</p>
<p>作用范围不同 : SEH基于线程,VEH在整个进程范围都有效</p>
<p>VEH不需要栈展开,由于SEH注册和使用依赖于函数调用的栈帧,调用SEH回调函数时会涉及栈展开的问题,SEH就有两次被调用的机会</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/re/" rel="tag"># re</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2022/04/01/ctf/reverse/%E6%AF%8F%E6%97%A5%E5%8D%9A%E5%AE%A2/4.1-C++%E8%99%9A%E5%87%BD%E6%95%B0/" rel="next" title="4.1-C++虚函数">
                <i class="fa fa-chevron-left"></i> 4.1-C++虚函数
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2022/04/08/ctf/reverse/%E6%AF%8F%E6%97%A5%E5%8D%9A%E5%AE%A2/4.8-miniL-ooops/" rel="prev" title="4.8-miniL2021-0oooops">
                4.8-miniL2021-0oooops <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="" />
          <p class="site-author-name" itemprop="name"></p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">108</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">15</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#windows%E4%B8%8B%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="nav-number">1.</span> <span class="nav-text">windows下的异常处理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A6%82%E5%BF%B5"><span class="nav-number">1.1.</span> <span class="nav-text">概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%87%E7%A8%8B%EF%BC%9A"><span class="nav-number">1.2.</span> <span class="nav-text">过程：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CPU%E4%B8%8E%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%BA%A4%E6%8E%A5-IDT%E8%A1%A8%E8%BD%AC%E7%A7%BB"><span class="nav-number">1.3.</span> <span class="nav-text">CPU与操作系统交接: IDT表转移</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%A1%E6%81%AF%E5%B0%81%E8%A3%85-%E5%BC%82%E5%B8%B8%E5%88%86%E5%8F%91%E5%87%BD%E6%95%B0"><span class="nav-number">1.4.</span> <span class="nav-text">信息封装+异常分发函数:</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#EXCEPTION-RECORD-%E5%BC%82%E5%B8%B8%E4%BF%A1%E6%81%AF"><span class="nav-number">1.4.1.</span> <span class="nav-text">EXCEPTION_RECORD 异常信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%99%B7%E9%98%B1%E5%B8%A7-CONTEXT-%E5%BC%82%E5%B8%B8%E7%8E%B0%E5%9C%BA"><span class="nav-number">1.4.2.</span> <span class="nav-text">陷阱帧&#x2F;CONTEXT 异常现场</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nt-KiDispatchException-%E5%BC%82%E5%B8%B8%E5%88%86%E5%8F%91%E5%87%BD%E6%95%B0"><span class="nav-number">1.4.3.</span> <span class="nav-text">nt!KiDispatchException() 异常分发函数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="nav-number">1.5.</span> <span class="nav-text">异常处理</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SEH"><span class="nav-number">2.</span> <span class="nav-text">SEH</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#SEH%E7%9B%B8%E5%85%B3%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">2.1.</span> <span class="nav-text">SEH相关数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#TIB-%E4%BF%9D%E5%AD%98%E7%BA%BF%E7%A8%8B%E4%BF%A1%E6%81%AF-%E6%8C%87%E5%90%91%E5%A4%84%E7%90%86%E9%93%BE%E8%A1%A8"><span class="nav-number">2.1.1.</span> <span class="nav-text">TIB 保存线程信息,指向处理链表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SEH%E9%93%BE-%E5%8C%85%E5%90%AB%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F%E5%9C%B0%E5%9D%80"><span class="nav-number">2.1.2.</span> <span class="nav-text">SEH链 包含处理程序地址</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#EXCEPTION-POINTERS-%E7%B4%A2%E5%BC%95%E5%88%B0%E5%B0%81%E8%A3%85%E7%9A%84%E4%BF%A1%E6%81%AF"><span class="nav-number">2.1.3.</span> <span class="nav-text">_EXCEPTION_POINTERS 索引到封装的信息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SEH%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8C%E5%8D%B8%E8%BD%BD"><span class="nav-number">2.2.</span> <span class="nav-text">SEH处理程序的安装和卸载</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%94%E5%9B%9E%E5%80%BCEXCEPTION-DISPOSITION"><span class="nav-number">2.3.</span> <span class="nav-text">返回值EXCEPTION_DISPOSITION</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B7%E4%BD%93%E5%BC%82%E5%B8%B8%E5%88%86%E5%8F%91"><span class="nav-number">2.4.</span> <span class="nav-text">具体异常分发</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#VEH"><span class="nav-number">3.</span> <span class="nav-text">VEH</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#VEH%E4%B8%8ESEH%E5%BC%82%E5%90%8C"><span class="nav-number">3.1.</span> <span class="nav-text">VEH与SEH异同</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">hzlg</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" target="_blank" rel="noopener" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" target="_blank" rel="noopener" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

</body>
</html>
