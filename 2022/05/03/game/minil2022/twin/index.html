<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="re,game," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="minil2022">
<meta property="og:type" content="article">
<meta property="og:title" content="TLS回调,Hook,子进程保护，xxtea">
<meta property="og:url" content="https://hzlg.github.ioz/2022/05/03/game/minil2022/twin/index.html">
<meta property="og:site_name" content="hzlg&#39;s blog">
<meta property="og:description" content="minil2022">
<meta property="og:locale">
<meta property="article:published_time" content="2022-05-03T03:16:29.411Z">
<meta property="article:modified_time" content="2022-05-08T13:18:51.176Z">
<meta property="article:author" content="hzlg">
<meta property="article:tag" content="re">
<meta property="article:tag" content="game">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://hzlg.github.ioz/2022/05/03/game/minil2022/twin/"/>





  <title>TLS回调,Hook,子进程保护，xxtea | hzlg's blog</title>
  














<meta name="generator" content="Hexo 5.4.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">hzlg's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">笔记、日常</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hzlg.github.ioz/2022/05/03/game/minil2022/twin/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hzlg's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">TLS回调,Hook,子进程保护，xxtea</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2022-05-03T11:16:29+08:00">
                2022-05-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>minil2022</p>
<span id="more"></span>

<h2 id="twin"><a href="#twin" class="headerlink" title="twin"></a>twin</h2><p>main函数里是个fake flag:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">v5 = [<span class="number">38</span>, <span class="number">17</span>, <span class="number">8</span>, <span class="number">35</span>, <span class="number">26</span>, <span class="number">8</span>, <span class="number">28</span>, <span class="number">39</span>, <span class="number">3</span>, <span class="number">25</span>, <span class="number">26</span>, <span class="number">43</span>, <span class="number">10</span>, <span class="number">29</span>, <span class="number">4</span>, <span class="number">30</span>,</span><br><span class="line">      <span class="number">8</span>, <span class="number">49</span>, <span class="number">25</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">25</span>, <span class="number">54</span>, <span class="number">1</span>, <span class="number">20</span>, <span class="number">57</span>, <span class="number">4</span>, <span class="number">59</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">10</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">0x38</span>, <span class="number">0x31</span>, <span class="number">0x3D</span>, <span class="number">0x3C</span>, <span class="number">0x7B</span>, <span class="number">0x78</span>, <span class="number">0x79</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">40</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(i ^ v5[i] ^ <span class="number">0x7F</span>), end=<span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="comment"># You_are_too_young_this_is_a_fake_flag!!!</span></span><br></pre></td></tr></table></figure>

<p>在main函数下断点调试发现在main函数之前就有东西执行了</p>
<p>在函数表里找了些可疑函数下断点再交叉引用,发现<code>TlsCallback_0</code>为关键函数 </p>
<blockquote>
<p>TLS回调函数 : 每当创建/终止进程的线程时会自动调用执行的函数（前后共调用两次）</p>
</blockquote>
<h2 id="TLS0前半部分-增加回调函数"><a href="#TLS0前半部分-增加回调函数" class="headerlink" title="TLS0前半部分 增加回调函数"></a>TLS0前半部分 增加回调函数</h2><p>tls0首尾有两处花指令,还有个welcome,直接nop掉</p>
<p>再把参数类型修一下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl <span class="title">TlsCallback_0</span><span class="params">(PVOID DLLHandle, ulong Reason)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *v2; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> Buffer[<span class="number">80</span>]; <span class="comment">// [esp+10h] [ebp-11Ch] BYREF</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">STARTUPINFOA</span> <span class="title">StartupInfo</span>;</span> <span class="comment">// [esp+60h] [ebp-CCh] BYREF</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">PROCESS_INFORMATION</span> <span class="title">ProcessInformation</span>;</span> <span class="comment">// [esp+A4h] [ebp-88h] BYREF</span></span><br><span class="line">  <span class="keyword">char</span> v7[<span class="number">22</span>]; <span class="comment">// [esp+B8h] [ebp-74h] BYREF</span></span><br><span class="line">  <span class="keyword">char</span> v8[<span class="number">4</span>]; <span class="comment">// [esp+CEh] [ebp-5Eh] BYREF</span></span><br><span class="line">  <span class="keyword">char</span> v9[<span class="number">44</span>]; <span class="comment">// [esp+D4h] [ebp-58h] BYREF</span></span><br><span class="line">  <span class="keyword">char</span> v10[<span class="number">12</span>]; <span class="comment">// [esp+100h] [ebp-2Ch] BYREF</span></span><br><span class="line">  CHAR Name[<span class="number">8</span>]; <span class="comment">// [esp+10Ch] [ebp-20h] BYREF</span></span><br><span class="line">  CHAR ApplicationName[<span class="number">8</span>]; <span class="comment">// [esp+114h] [ebp-18h] BYREF</span></span><br><span class="line">  <span class="keyword">char</span> v13[<span class="number">8</span>]; <span class="comment">// [esp+11Ch] [ebp-10h] BYREF</span></span><br><span class="line">  <span class="keyword">char</span> Format[<span class="number">7</span>]; <span class="comment">// [esp+124h] [ebp-8h] BYREF</span></span><br><span class="line">  <span class="keyword">uint8_t</span> v15; <span class="comment">// [esp+12Bh] [ebp-1h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( Reason == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(Buffer, <span class="number">0</span>, <span class="keyword">sizeof</span>(Buffer));</span><br><span class="line">    WriteConsole_func(Buffer);</span><br><span class="line">    v15 = <span class="number">0</span>;</span><br><span class="line">    v15 = NtCurrentPeb()-&gt;BeingDebugged;</span><br><span class="line">    <span class="keyword">if</span> ( v15 )</span><br><span class="line">      *(&amp;TlsCallbacks + <span class="number">1</span>) = (<span class="keyword">int</span> (__cdecl *)(<span class="keyword">int</span>, <span class="keyword">int</span>))sub_401D60;</span><br><span class="line">    <span class="built_in">strcpy</span>(Name, <span class="string">&quot;93&gt;8&quot;</span>);</span><br><span class="line">    xor_0x7F_decode(Name);</span><br><span class="line">    hObject = CreateFileMappingA(<span class="number">0</span>, <span class="number">0</span>, <span class="number">4u</span>, <span class="number">0</span>, <span class="number">0x1000</span>u, Name);</span><br><span class="line">    *(_DWORD *)dword_404448 = MapViewOfFile(hObject, <span class="number">0xF001F</span>u, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x1000</span>u);</span><br><span class="line">    v7[<span class="number">0</span>] = <span class="number">47</span>;                                 <span class="comment">// Please input your flag:</span></span><br><span class="line">    v7[<span class="number">1</span>] = <span class="number">19</span>;</span><br><span class="line">    v7[<span class="number">2</span>] = <span class="number">26</span>;</span><br><span class="line">    v7[<span class="number">3</span>] = <span class="number">30</span>;</span><br><span class="line">    v7[<span class="number">4</span>] = <span class="number">12</span>;</span><br><span class="line">    v7[<span class="number">5</span>] = <span class="number">26</span>;</span><br><span class="line">    v7[<span class="number">6</span>] = <span class="number">95</span>;</span><br><span class="line">    v7[<span class="number">7</span>] = <span class="number">22</span>;</span><br><span class="line">    v7[<span class="number">8</span>] = <span class="number">17</span>;</span><br><span class="line">    v7[<span class="number">9</span>] = <span class="number">15</span>;</span><br><span class="line">    v7[<span class="number">10</span>] = <span class="number">10</span>;</span><br><span class="line">    v7[<span class="number">11</span>] = <span class="number">11</span>;</span><br><span class="line">    v7[<span class="number">12</span>] = <span class="number">95</span>;</span><br><span class="line">    v7[<span class="number">13</span>] = <span class="number">6</span>;</span><br><span class="line">    v7[<span class="number">14</span>] = <span class="number">16</span>;</span><br><span class="line">    v7[<span class="number">15</span>] = <span class="number">10</span>;</span><br><span class="line">    v7[<span class="number">16</span>] = <span class="number">13</span>;</span><br><span class="line">    v7[<span class="number">17</span>] = <span class="number">95</span>;</span><br><span class="line">    v7[<span class="number">18</span>] = <span class="number">25</span>;</span><br><span class="line">    v7[<span class="number">19</span>] = <span class="number">19</span>;</span><br><span class="line">    v7[<span class="number">20</span>] = <span class="number">30</span>;</span><br><span class="line">    v7[<span class="number">21</span>] = <span class="number">24</span>;</span><br><span class="line">    <span class="built_in">strcpy</span>(v8, <span class="string">&quot;E_&quot;</span>);</span><br><span class="line">    v2 = (<span class="keyword">char</span> *)xor_0x7F_decode(v7);</span><br><span class="line">    WriteConsole_func(v2);</span><br><span class="line">    Format[<span class="number">0</span>] = <span class="number">90</span>;                             <span class="comment">// %s</span></span><br><span class="line">    Format[<span class="number">1</span>] = <span class="number">12</span>;</span><br><span class="line">    Format[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">    xor_0x7F_decode(Format);</span><br><span class="line">    scanf_func(Format, *(_DWORD *)dword_404448, <span class="number">41</span>);</span><br><span class="line">  &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !Reason )</span><br><span class="line">	.</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    Reason不为<span class="number">1</span>的情况在后面</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>创建线程时Reason = 1, 执行tls0的前半部分</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">v15 = <span class="number">0</span>;</span><br><span class="line">v15 = NtCurrentPeb()-&gt;BeingDebugged;</span><br><span class="line"><span class="keyword">if</span> ( v15 )</span><br><span class="line">  *(&amp;TlsCallbacks + <span class="number">1</span>) = (<span class="keyword">int</span> (__cdecl *)(<span class="keyword">int</span>, <span class="keyword">int</span>))sub_401D60;</span><br></pre></td></tr></table></figure>

<p>↑ 此处会判断是否有调试器  <code>BeingDebugged; // 无调试器时 = 0，有调试器时 = 1 </code></p>
<p>若没有调试器就在tls0后增加一个函数<code>sub_401D60</code></p>
<p>动调时想要绕过if判断只需将jnz patch 为jz即可</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">strcpy</span>(Name, <span class="string">&quot;93&gt;8&quot;</span>);</span><br><span class="line">xor_0x7F_decode(Name);</span><br><span class="line">hObject = CreateFileMappingA(<span class="number">0</span>, <span class="number">0</span>, <span class="number">4u</span>, <span class="number">0</span>, <span class="number">0x1000</span>u, Name);</span><br><span class="line">*(_DWORD *)dword_404448 = MapViewOfFile(hObject, <span class="number">0xF001F</span>u, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x1000</span>u);</span><br></pre></td></tr></table></figure>

<p>update : (yzj wp) 28、29行就是初始化<code>FLAG</code>这个字符串。 30行和31行的两个函数不知道干啥的，去翻了下zsky学长的博客，找到一个傀儡进程的题目WP，用到了这两个函数。 <code>hObject = CreateFileMappingA(0, 0, 4u, 0, 0x1000u, Name_FLAG);</code><strong>创建名字为FLAG的文件映射对象，用于进程间通信</strong>。 <code>*(_DWORD *)input = MapViewOfFile(hObject, 0xF001Fu, 0, 0, 0x1000u);</code><strong>存了内存映射文件，便于后面的共享内存</strong>。 </p>
<p>简而言之，就是创建一个名为FLAG的文件映射对象，把input指向的地址设置成一块共享的内存，这样就可以在子进程里对input这块内存进行修改，实现加密。</p>
<h2 id="回调函数-修改WriteFile函数的索引"><a href="#回调函数-修改WriteFile函数的索引" class="headerlink" title="回调函数 修改WriteFile函数的索引"></a>回调函数 修改WriteFile函数的索引</h2><p>update:hook就是调用这个函数的时候 你先跳到自己的函数执行 然后再决定要不要执行原本的函数 最后跳回调用时的下一条指令</p>
<p>新增的函数<code>sub_401D60</code>里面也有一个花,nop掉 :</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl __noreturn <span class="title">sub_401D60</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  CHAR ModuleName[<span class="number">16</span>]; <span class="comment">// [esp+0h] [ebp-1Ch] BYREF</span></span><br><span class="line">  CHAR ProcName[<span class="number">12</span>]; <span class="comment">// [esp+10h] [ebp-Ch] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a2 == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    ProcName[<span class="number">0</span>] = <span class="number">40</span>;</span><br><span class="line">    ProcName[<span class="number">1</span>] = <span class="number">13</span>;</span><br><span class="line">    ProcName[<span class="number">2</span>] = <span class="number">22</span>;</span><br><span class="line">    ProcName[<span class="number">3</span>] = <span class="number">11</span>;</span><br><span class="line">    ProcName[<span class="number">4</span>] = <span class="number">26</span>;</span><br><span class="line">    ProcName[<span class="number">5</span>] = <span class="number">57</span>;</span><br><span class="line">    ProcName[<span class="number">6</span>] = <span class="number">22</span>;</span><br><span class="line">    ProcName[<span class="number">7</span>] = <span class="number">19</span>;</span><br><span class="line">    ProcName[<span class="number">8</span>] = <span class="number">26</span>;</span><br><span class="line">    ProcName[<span class="number">9</span>] = <span class="number">0</span>;</span><br><span class="line">    ModuleName[<span class="number">0</span>] = <span class="number">20</span>;</span><br><span class="line">    ModuleName[<span class="number">1</span>] = <span class="number">26</span>;</span><br><span class="line">    ModuleName[<span class="number">2</span>] = <span class="number">13</span>;</span><br><span class="line">    ModuleName[<span class="number">3</span>] = <span class="number">17</span>;</span><br><span class="line">    ModuleName[<span class="number">4</span>] = <span class="number">26</span>;</span><br><span class="line">    ModuleName[<span class="number">5</span>] = <span class="number">19</span>;</span><br><span class="line">    ModuleName[<span class="number">6</span>] = <span class="number">76</span>;</span><br><span class="line">    ModuleName[<span class="number">7</span>] = <span class="number">77</span>;</span><br><span class="line">    ModuleName[<span class="number">8</span>] = <span class="number">81</span>;</span><br><span class="line">    ModuleName[<span class="number">9</span>] = <span class="number">27</span>;</span><br><span class="line">    ModuleName[<span class="number">10</span>] = <span class="number">19</span>;</span><br><span class="line">    ModuleName[<span class="number">11</span>] = <span class="number">19</span>;</span><br><span class="line">    ModuleName[<span class="number">12</span>] = <span class="number">0</span>;</span><br><span class="line">    xor_0x7F_decode(ProcName);                  <span class="comment">// WriteFile</span></span><br><span class="line">    xor_0x7F_decode(ModuleName);                <span class="comment">// kernel32.dll</span></span><br><span class="line">    hModule = GetModuleHandleA(ModuleName);     <span class="comment">// 获得句柄</span></span><br><span class="line">    funcptr_writefile = (<span class="keyword">int</span> (__stdcall *)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD))GetProcAddress(hModule, ProcName);<span class="comment">// 获得函数指针</span></span><br><span class="line">    replace_func((<span class="keyword">int</span>)funcptr_writefile, (<span class="keyword">int</span>)sub_401650, hModule);<span class="comment">// 调用WriteFile函数时会索引到sub_401650</span></span><br><span class="line">  &#125;</span><br><span class="line">  ExitProcess(<span class="number">0xFFFFFFFF</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>sub_4016C0(replace_func)</code>遍历kernel32的导入表,在lpaddress为WriteFile时调用VituralProtect修改权限,用<code>sub_401650</code>替换WriteFile的索引</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">replace_func</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2, HMODULE a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  DWORD flOldProtect; <span class="comment">// [esp+Ch] [ebp-10h] BYREF</span></span><br><span class="line">  <span class="keyword">int</span> ptr_to_IMPORT_DESCRIPTOR_KERNEL32; <span class="comment">// [esp+10h] [ebp-Ch]</span></span><br><span class="line">  HMODULE v6; <span class="comment">// [esp+14h] [ebp-8h]</span></span><br><span class="line">  LPVOID lpAddress; <span class="comment">// [esp+18h] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  v6 = GetModuleHandleA(<span class="number">0</span>);</span><br><span class="line">  ptr_to_IMPORT_DESCRIPTOR_KERNEL32 = (<span class="keyword">int</span>)v6 + *(_DWORD *)((<span class="keyword">char</span> *)v6 + *((_DWORD *)v6 + <span class="number">15</span>) + <span class="number">128</span>);<span class="comment">// KERNEL32的导入表</span></span><br><span class="line">  flOldProtect = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !*(_DWORD *)(ptr_to_IMPORT_DESCRIPTOR_KERNEL32 + <span class="number">16</span>) || dword_4043D0 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( a3 == GetModuleHandleA((LPCSTR)v6 + *(_DWORD *)(ptr_to_IMPORT_DESCRIPTOR_KERNEL32 + <span class="number">12</span>)) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">for</span> ( lpAddress = (<span class="keyword">char</span> *)v6 + *(_DWORD *)(ptr_to_IMPORT_DESCRIPTOR_KERNEL32 + <span class="number">16</span>);</span><br><span class="line">            lpAddress;</span><br><span class="line">            lpAddress = (<span class="keyword">char</span> *)lpAddress + <span class="number">4</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( *(_DWORD *)lpAddress == a1 )</span><br><span class="line">        &#123;</span><br><span class="line">          VirtualProtect(lpAddress, <span class="number">4u</span>, <span class="number">4u</span>, &amp;flOldProtect);</span><br><span class="line">          *(_DWORD *)lpAddress = a2;</span><br><span class="line">          VirtualProtect(lpAddress, <span class="number">4u</span>, flOldProtect, <span class="number">0</span>);</span><br><span class="line">          dword_4043D0 = <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ptr_to_IMPORT_DESCRIPTOR_KERNEL32 += <span class="number">20</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( !dword_4043D0 );</span><br><span class="line">  <span class="keyword">return</span> dword_4043D0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="用来顶替的函数"><a href="#用来顶替的函数" class="headerlink" title="用来顶替的函数"></a>用来顶替的函数</h2><p>替代writefile的函数<code>sub_401650</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __stdcall <span class="title">sub_401650</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2, <span class="keyword">int</span> a3, <span class="keyword">int</span> a4, <span class="keyword">int</span> a5)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  *(_BYTE *)(a2 + <span class="number">1822</span>) = <span class="number">6</span>;</span><br><span class="line">  *(_BYTE *)(a2 + <span class="number">1713</span>) = <span class="number">6</span>;</span><br><span class="line">  funcptr_writefile(a1, a2, a3, a4, a5);</span><br><span class="line">  another_replace_func(funcptr_writefile, sub_401650, hModule);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用WriteFile时会在缓冲区里写了两个6然后调用真正的WriteFile</p>
<h2 id="TLS0后半部分1-子进程运行tmp文件"><a href="#TLS0后半部分1-子进程运行tmp文件" class="headerlink" title="TLS0后半部分1 子进程运行tmp文件"></a>TLS0后半部分1 子进程运行tmp文件</h2><p>新增函数替换完后执行ExitProcess,终止线程的时候又会调用TLS0,主线程结束时Reason为0,执行TLS0的下半部分</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !Reason )</span><br><span class="line">  &#123;</span><br><span class="line">    ApplicationName[<span class="number">0</span>] = <span class="number">81</span>;</span><br><span class="line">    ApplicationName[<span class="number">1</span>] = <span class="number">80</span>;</span><br><span class="line">    ApplicationName[<span class="number">2</span>] = <span class="number">11</span>;</span><br><span class="line">    ApplicationName[<span class="number">3</span>] = <span class="number">18</span>;</span><br><span class="line">    ApplicationName[<span class="number">4</span>] = <span class="number">15</span>;</span><br><span class="line">    ApplicationName[<span class="number">5</span>] = <span class="number">0</span>;</span><br><span class="line">    xor_0x7F_decode(ApplicationName);           <span class="comment">// ./tmp</span></span><br><span class="line">    new_file_tmp();</span><br><span class="line">    <span class="built_in">memset</span>(&amp;StartupInfo, <span class="number">0</span>, <span class="keyword">sizeof</span>(StartupInfo));</span><br><span class="line">    StartupInfo.cb = <span class="number">68</span>;</span><br><span class="line">    CreateProcessA(ApplicationName, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">3u</span>, <span class="number">0</span>, <span class="number">0</span>, &amp;StartupInfo, &amp;ProcessInformation);</span><br><span class="line">    v10[<span class="number">0</span>] = <span class="number">28</span>;                                <span class="comment">// correct</span></span><br><span class="line">    v10[<span class="number">1</span>] = <span class="number">16</span>;</span><br><span class="line">    v10[<span class="number">2</span>] = <span class="number">13</span>;</span><br><span class="line">    v10[<span class="number">3</span>] = <span class="number">13</span>;</span><br><span class="line">    v10[<span class="number">4</span>] = <span class="number">26</span>;</span><br><span class="line">    v10[<span class="number">5</span>] = <span class="number">28</span>;</span><br><span class="line">    v10[<span class="number">6</span>] = <span class="number">11</span>;</span><br><span class="line">    v10[<span class="number">7</span>] = <span class="number">117</span>;</span><br><span class="line">    v10[<span class="number">8</span>] = <span class="number">0</span>;</span><br><span class="line">    v13[<span class="number">0</span>] = <span class="number">8</span>;                                 <span class="comment">// wrong</span></span><br><span class="line">    v13[<span class="number">1</span>] = <span class="number">13</span>;</span><br><span class="line">    v13[<span class="number">2</span>] = <span class="number">16</span>;</span><br><span class="line">    v13[<span class="number">3</span>] = <span class="number">17</span>;</span><br><span class="line">    v13[<span class="number">4</span>] = <span class="number">24</span>;</span><br><span class="line">    v13[<span class="number">5</span>] = <span class="number">117</span>;</span><br><span class="line">    v13[<span class="number">6</span>] = <span class="number">0</span>;</span><br><span class="line">    v9[<span class="number">0</span>] = <span class="number">47</span>;                                 <span class="comment">// Please close the debugger and try again</span></span><br><span class="line">    v9[<span class="number">1</span>] = <span class="number">19</span>;</span><br><span class="line">    v9[<span class="number">2</span>] = <span class="number">26</span>;</span><br><span class="line">    v9[<span class="number">3</span>] = <span class="number">30</span>;</span><br><span class="line">    v9[<span class="number">4</span>] = <span class="number">12</span>;</span><br><span class="line">    v9[<span class="number">5</span>] = <span class="number">26</span>;</span><br><span class="line">    v9[<span class="number">6</span>] = <span class="number">95</span>;</span><br><span class="line">    v9[<span class="number">7</span>] = <span class="number">28</span>;</span><br><span class="line">    v9[<span class="number">8</span>] = <span class="number">19</span>;</span><br><span class="line">    v9[<span class="number">9</span>] = <span class="number">16</span>;</span><br><span class="line">    v9[<span class="number">10</span>] = <span class="number">12</span>;</span><br><span class="line">    v9[<span class="number">11</span>] = <span class="number">26</span>;</span><br><span class="line">    v9[<span class="number">12</span>] = <span class="number">95</span>;</span><br><span class="line">    v9[<span class="number">13</span>] = <span class="number">11</span>;</span><br><span class="line">    v9[<span class="number">14</span>] = <span class="number">23</span>;</span><br><span class="line">    v9[<span class="number">15</span>] = <span class="number">26</span>;</span><br><span class="line">    v9[<span class="number">16</span>] = <span class="number">95</span>;</span><br><span class="line">    v9[<span class="number">17</span>] = <span class="number">27</span>;</span><br><span class="line">    v9[<span class="number">18</span>] = <span class="number">26</span>;</span><br><span class="line">    v9[<span class="number">19</span>] = <span class="number">29</span>;</span><br><span class="line">    v9[<span class="number">20</span>] = <span class="number">10</span>;</span><br><span class="line">    v9[<span class="number">21</span>] = <span class="number">24</span>;</span><br><span class="line">    v9[<span class="number">22</span>] = <span class="number">24</span>;</span><br><span class="line">    v9[<span class="number">23</span>] = <span class="number">26</span>;</span><br><span class="line">    v9[<span class="number">24</span>] = <span class="number">13</span>;</span><br><span class="line">    v9[<span class="number">25</span>] = <span class="number">95</span>;</span><br><span class="line">    v9[<span class="number">26</span>] = <span class="number">30</span>;</span><br><span class="line">    v9[<span class="number">27</span>] = <span class="number">17</span>;</span><br><span class="line">    v9[<span class="number">28</span>] = <span class="number">27</span>;</span><br><span class="line">    v9[<span class="number">29</span>] = <span class="number">95</span>;</span><br><span class="line">    v9[<span class="number">30</span>] = <span class="number">11</span>;</span><br><span class="line">    v9[<span class="number">31</span>] = <span class="number">13</span>;</span><br><span class="line">    v9[<span class="number">32</span>] = <span class="number">6</span>;</span><br><span class="line">    v9[<span class="number">33</span>] = <span class="number">95</span>;</span><br><span class="line">    v9[<span class="number">34</span>] = <span class="number">30</span>;</span><br><span class="line">    v9[<span class="number">35</span>] = <span class="number">24</span>;</span><br><span class="line">    v9[<span class="number">36</span>] = <span class="number">30</span>;</span><br><span class="line">    v9[<span class="number">37</span>] = <span class="number">22</span>;</span><br><span class="line">    v9[<span class="number">38</span>] = <span class="number">17</span>;</span><br><span class="line">    v9[<span class="number">39</span>] = <span class="number">117</span>;</span><br><span class="line">    v9[<span class="number">40</span>] = <span class="number">0</span>;</span><br><span class="line">    sub_401510(ApplicationName, &amp;ProcessInformation);		</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>



<p><code>sub_401410(new_file_tmp)</code> 创建了一个名为tmp的文件,调用WriteFile时索引到了<code>sub_401650</code>,将一个xxtea算法中的一个右移量修改为6再写入tmp文件(动调跟数据然后按c生成代码就知道改了啥)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">new_file_tmp</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  CHAR Type[<span class="number">8</span>]; <span class="comment">// [esp+0h] [ebp-2Ch] BYREF</span></span><br><span class="line">  CHAR FileName[<span class="number">8</span>]; <span class="comment">// [esp+8h] [ebp-24h] BYREF</span></span><br><span class="line">  BOOL v3; <span class="comment">// [esp+10h] [ebp-1Ch]</span></span><br><span class="line">  DWORD NumberOfBytesWritten; <span class="comment">// [esp+14h] [ebp-18h] BYREF</span></span><br><span class="line">  HGLOBAL hResData; <span class="comment">// [esp+18h] [ebp-14h]</span></span><br><span class="line">  LPCVOID lpBuffer; <span class="comment">// [esp+1Ch] [ebp-10h]</span></span><br><span class="line">  DWORD nNumberOfBytesToWrite; <span class="comment">// [esp+20h] [ebp-Ch]</span></span><br><span class="line">  HRSRC hResInfo; <span class="comment">// [esp+24h] [ebp-8h]</span></span><br><span class="line">  HANDLE hFile; <span class="comment">// [esp+28h] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  FileName[<span class="number">0</span>] = <span class="number">81</span>;</span><br><span class="line">  FileName[<span class="number">1</span>] = <span class="number">80</span>;</span><br><span class="line">  FileName[<span class="number">2</span>] = <span class="number">11</span>;</span><br><span class="line">  FileName[<span class="number">3</span>] = <span class="number">18</span>;</span><br><span class="line">  FileName[<span class="number">4</span>] = <span class="number">15</span>;</span><br><span class="line">  FileName[<span class="number">5</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">strcpy</span>(Type, <span class="string">&quot;:&#x27;:-:,&quot;</span>);</span><br><span class="line">  xor_0x7F_decode(FileName);                    <span class="comment">// ./tmp</span></span><br><span class="line">  xor_0x7F_decode(Type);                        <span class="comment">// EXERES</span></span><br><span class="line">  hResInfo = FindResourceA(<span class="number">0</span>, (LPCSTR)<span class="number">0x65</span>, Type);</span><br><span class="line">  nNumberOfBytesToWrite = SizeofResource(<span class="number">0</span>, hResInfo);</span><br><span class="line">  hResData = LoadResource(<span class="number">0</span>, hResInfo);</span><br><span class="line">  lpBuffer = LockResource(hResData);</span><br><span class="line">  sub_401E40(lpBuffer, nNumberOfBytesToWrite);</span><br><span class="line">  hFile = CreateFileA(FileName, <span class="number">0xC0000000</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2u</span>, <span class="number">0x80</span>u, <span class="number">0</span>);</span><br><span class="line">  NumberOfBytesWritten = <span class="number">0</span>;</span><br><span class="line">  v3 = WriteFile(hFile, lpBuffer, nNumberOfBytesToWrite, &amp;NumberOfBytesWritten, <span class="number">0</span>);</span><br><span class="line">  FlushFileBuffers(hFile);</span><br><span class="line">  <span class="keyword">return</span> CloseHandle(hFile);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>创建tmp文件后创建新进程运行tmp文件</p>
<h2 id="TLS0后半部分2-监视tmp文件"><a href="#TLS0后半部分2-监视tmp文件" class="headerlink" title="TLS0后半部分2 监视tmp文件"></a>TLS0后半部分2 监视tmp文件</h2><p>起到了子进程保护的作用</p>
<p>有一个花,去掉：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL __cdecl <span class="title">sub_401510</span><span class="params">(LPCSTR lpFileName, <span class="keyword">int</span> ProcessInformation)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  CONTEXT Context; <span class="comment">// [esp+8h] [ebp-33Ch] BYREF</span></span><br><span class="line">  <span class="keyword">int</span> v4[<span class="number">23</span>]; <span class="comment">// [esp+2D4h] [ebp-70h] BYREF</span></span><br><span class="line">  HANDLE hThread; <span class="comment">// [esp+330h] [ebp-14h]</span></span><br><span class="line">  <span class="keyword">int</span> ProcessId; <span class="comment">// [esp+334h] [ebp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> ThreadId; <span class="comment">// [esp+338h] [ebp-Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v8; <span class="comment">// [esp+33Ch] [ebp-8h]</span></span><br><span class="line">  <span class="keyword">int</span> v9; <span class="comment">// [esp+340h] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  v4[<span class="number">22</span>] = *(_DWORD *)ProcessInformation;</span><br><span class="line">  hThread = *(HANDLE *)(ProcessInformation + <span class="number">4</span>);</span><br><span class="line">  ProcessId = *(_DWORD *)(ProcessInformation + <span class="number">8</span>);</span><br><span class="line">  ThreadId = *(_DWORD *)(ProcessInformation + <span class="number">12</span>);</span><br><span class="line">  v9 = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span> ( v9 )</span><br><span class="line">  &#123;</span><br><span class="line">    WaitForDebugEvent(&amp;DebugEvent, <span class="number">0xFFFFFFFF</span>);</span><br><span class="line">    <span class="keyword">if</span> ( DebugEvent.dwDebugEventCode == <span class="number">1</span> )     <span class="comment">// code为1时接受处理来自子进程的异常，进而修改子进程代码</span></span><br><span class="line">    &#123;</span><br><span class="line">      qmemcpy(v4, &amp;DebugEvent.u, <span class="number">0x54</span>u);</span><br><span class="line">      v8 = v4[<span class="number">0</span>];</span><br><span class="line">      <span class="keyword">if</span> ( v4[<span class="number">0</span>] == EXCEPTION_ACCESS_VIOLATION )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;Context, <span class="number">0</span>, <span class="keyword">sizeof</span>(Context));</span><br><span class="line">        Context.ContextFlags = <span class="number">65543</span>;</span><br><span class="line">        GetThreadContext(hThread, &amp;Context);</span><br><span class="line">        Context.Eip += <span class="number">5</span>;</span><br><span class="line">        Context.Eax ^= <span class="number">0x1B207</span>u;</span><br><span class="line">        SetThreadContext(hThread, &amp;Context);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( DebugEvent.dwDebugEventCode == <span class="number">5</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      dword_404440 = DebugEvent.u.Exception.ExceptionRecord.ExceptionCode;</span><br><span class="line">      v9 = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ContinueDebugEvent(DebugEvent.dwProcessId, DebugEvent.dwThreadId, <span class="number">0x10002</span>u);</span><br><span class="line">  &#125;</span><br><span class="line">  Sleep(<span class="number">0x64</span>u);</span><br><span class="line">  <span class="keyword">return</span> DeleteFileA(lpFileName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据<code>DebugEvent.dwDebugEventCode</code>进行了分支</p>
<p>它表明了是什么事件被 WaitForDebugEvent() 捕捉到了。同时也决定了，在联合(union )u 里存储的是什么类型 的值。u 里的变量由 dwDebugEventCode 决定，一一对应如下：</p>
<table>
<thead>
<tr>
<th>Event Code</th>
<th>Event Code Value</th>
<th>Union u Value</th>
</tr>
</thead>
<tbody><tr>
<td>0x1</td>
<td>EXCEPTION_DEBUG_EVENT</td>
<td>u.Exception</td>
</tr>
<tr>
<td>0x2</td>
<td>CREATE_THREAD_DEBUG_EVENT</td>
<td>u.CreateThread</td>
</tr>
<tr>
<td>0x3</td>
<td>CREATE_PROCESS_DEBUG_EVENT</td>
<td>u.CreateProcessInfo</td>
</tr>
<tr>
<td>0x4</td>
<td>EXIT_THREAD_DEBUG_EVENT</td>
<td>u.ExitThread</td>
</tr>
<tr>
<td>0x5</td>
<td>EXIT_PROCESS_DEBUG_EVENT</td>
<td>u.ExitProcess</td>
</tr>
<tr>
<td>0x6</td>
<td>LOAD_DLL_DEBUG_EVENT</td>
<td>u.LoadDll</td>
</tr>
<tr>
<td>0x7</td>
<td>UNLOAD_DLL_DEBUG_EVENT</td>
<td>u.UnloadDll</td>
</tr>
<tr>
<td>0x8</td>
<td>OUPUT_DEBUG_STRING_EVENT</td>
<td>u.DebugString</td>
</tr>
<tr>
<td>0x9</td>
<td>RIP_EVENT</td>
<td>u.RipInfo</td>
</tr>
</tbody></table>
<p>若子进程发生了异常,则code为1,接受处理来自子进程的异常，进而修改子进程代码。此处<code>若子进程发生内存访问错误则eip+5并修改eax</code></p>
<p>若子进程正常退出,则code为5。此处保存ExceptionCode</p>
<h2 id="tmp文件-魔改xxtea并校验"><a href="#tmp文件-魔改xxtea并校验" class="headerlink" title="tmp文件 魔改xxtea并校验"></a>tmp文件 魔改xxtea并校验</h2><p>tmp文件里的main函数有很多反调试,并且对delta和key进行了修改</p>
<p><code>sub_401400</code>里对<strong>delta ^= 0x12345678</strong>,并调用<code>AddVectoredExceptionHandler</code>注册了内存访问错误下的VEH异常处理函数(应该没被用到?被主进程的异常处理给抢了?)</p>
<p><code>sub_4010E0</code>判断是否在调试,未在调试则<strong>delta ^= 0x90909090 , key[1] = 0x90</strong></p>
<p><code>sub_401210</code>里<strong>delta = (delta ^ 0x7B) + 12345</strong>,然后引起内存访问异常,被刚刚的主进程接收,进行异常处理,eip+5,<strong>eax(delta) ^= 0x1B207</strong></p>
<p><code>sub_401390</code>打开映像文件,取40个字符,应该是输入的flag</p>
<p><code>sub_401240</code>观察发现是xxtea(看delta值等) </p>
<p>MX右移量在前面改为了6,delta和key也被修改了,不是标准的xxtea:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">MX</span>(<span class="params">z, y, total, key, p, e</span>):</span></span><br><span class="line">    temp1 = (z.value &gt;&gt; <span class="number">6</span> ^ y.value &lt;&lt; <span class="number">2</span>) + (y.value &gt;&gt; <span class="number">3</span> ^ z.value &lt;&lt; <span class="number">4</span>)</span><br><span class="line">    temp2 = (total.value ^ y.value) + (key[(p &amp; <span class="number">3</span>) ^ e.value] ^ z.value)</span><br><span class="line">    <span class="keyword">return</span> c_uint32(temp1 ^ temp2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt</span>(<span class="params">n, v, key</span>):</span></span><br><span class="line">    delta = ((((<span class="number">0x9E3779B9</span> ^ <span class="number">0x12345678</span>) ^ <span class="number">0x90909090</span>) ^ <span class="number">0x7B</span>) + <span class="number">12345</span>) ^ <span class="number">0x1B207</span></span><br><span class="line">    rounds = <span class="number">6</span> + <span class="number">52</span>//n</span><br><span class="line">    total = c_uint32(rounds * delta)</span><br><span class="line">    y = c_uint32(v[<span class="number">0</span>])</span><br><span class="line">    e = c_uint32(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> rounds &gt; <span class="number">0</span>:</span><br><span class="line">        e.value = (total.value &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span></span><br><span class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> <span class="built_in">range</span>(n-<span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>):</span><br><span class="line">            z = c_uint32(v[p-<span class="number">1</span>])</span><br><span class="line">            v[p] = c_uint32((v[p] - MX(z, y, total, key, p, e).value)).value</span><br><span class="line">            y.value = v[p]</span><br><span class="line">        z = c_uint32(v[n-<span class="number">1</span>])</span><br><span class="line">        v[<span class="number">0</span>] = c_uint32(v[<span class="number">0</span>] - MX(z, y, total, key, <span class="number">0</span>, e).value).value</span><br><span class="line">        y.value = v[<span class="number">0</span>]</span><br><span class="line">        total.value -= delta</span><br><span class="line">        rounds -= <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> v</span><br><span class="line"></span><br><span class="line">v = [<span class="number">0x6B7CE328</span>, <span class="number">0x4841D5DD</span>, <span class="number">0x963784DC</span>, <span class="number">0xEF8A3226</span>, <span class="number">0x0776B226</span>]</span><br><span class="line">k = [<span class="number">0x12</span>, <span class="number">0x90</span>, <span class="number">0x56</span>, <span class="number">0x78</span>]</span><br><span class="line">n = <span class="built_in">len</span>(v)</span><br><span class="line"></span><br><span class="line">res = decrypt(n, v, k)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(res[i]))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(v)):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>, <span class="number">0</span>, -<span class="number">2</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">chr</span>(<span class="built_in">int</span>(<span class="built_in">str</span>(<span class="built_in">hex</span>(res[i]))[j:j+<span class="number">2</span>], <span class="number">16</span>)), end=<span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="comment"># miniLctf&#123;cbda59ff59e</span></span><br></pre></td></tr></table></figure>

<h2 id="TLS0后半部分3-普通xxtea并校验"><a href="#TLS0后半部分3-普通xxtea并校验" class="headerlink" title="TLS0后半部分3 普通xxtea并校验"></a>TLS0后半部分3 普通xxtea并校验</h2><p><code>sub_4012C0</code>是xxtea(看delta值等)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">MX</span>(<span class="params">z, y, total, key, p, e</span>):</span></span><br><span class="line">    temp1 = (z.value &gt;&gt; <span class="number">5</span> ^ y.value &lt;&lt; <span class="number">2</span>) + (y.value &gt;&gt; <span class="number">3</span> ^ z.value &lt;&lt; <span class="number">4</span>)</span><br><span class="line">    temp2 = (total.value ^ y.value) + (key[(p &amp; <span class="number">3</span>) ^ e.value] ^ z.value)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> c_uint32(temp1 ^ temp2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span>(<span class="params">n, v, key</span>):</span></span><br><span class="line">    delta = <span class="number">0x9e3779b9</span></span><br><span class="line">    rounds = <span class="number">6</span> + <span class="number">52</span>//n</span><br><span class="line"></span><br><span class="line">    total = c_uint32(<span class="number">0</span>)</span><br><span class="line">    z = c_uint32(v[n-<span class="number">1</span>])</span><br><span class="line">    e = c_uint32(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> rounds &gt; <span class="number">0</span>:</span><br><span class="line">        total.value += delta</span><br><span class="line">        e.value = (total.value &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span></span><br><span class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> <span class="built_in">range</span>(n-<span class="number">1</span>):</span><br><span class="line">            y = c_uint32(v[p+<span class="number">1</span>])</span><br><span class="line">            v[p] = c_uint32(v[p] + MX(z, y, total, key, p, e).value).value</span><br><span class="line">            z.value = v[p]</span><br><span class="line">        y = c_uint32(v[<span class="number">0</span>])</span><br><span class="line">        v[n-<span class="number">1</span>] = c_uint32(v[n-<span class="number">1</span>] + MX(z, y, total, key, n-<span class="number">1</span>, e).value).value</span><br><span class="line">        z.value = v[n-<span class="number">1</span>]</span><br><span class="line">        rounds -= <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> v</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt</span>(<span class="params">n, v, key</span>):</span></span><br><span class="line">    delta = <span class="number">0x9e3779b9</span></span><br><span class="line">    rounds = <span class="number">6</span> + <span class="number">52</span>//n</span><br><span class="line"></span><br><span class="line">    total = c_uint32(rounds * delta)</span><br><span class="line">    y = c_uint32(v[<span class="number">0</span>])</span><br><span class="line">    e = c_uint32(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> rounds &gt; <span class="number">0</span>:</span><br><span class="line">        e.value = (total.value &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span></span><br><span class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> <span class="built_in">range</span>(n-<span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>):</span><br><span class="line">            z = c_uint32(v[p-<span class="number">1</span>])</span><br><span class="line">            v[p] = c_uint32((v[p] - MX(z, y, total, key, p, e).value)).value</span><br><span class="line">            y.value = v[p]</span><br><span class="line">        z = c_uint32(v[n-<span class="number">1</span>])</span><br><span class="line">        v[<span class="number">0</span>] = c_uint32(v[<span class="number">0</span>] - MX(z, y, total, key, <span class="number">0</span>, e).value).value</span><br><span class="line">        y.value = v[<span class="number">0</span>]</span><br><span class="line">        total.value -= delta</span><br><span class="line">        rounds -= <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> v</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">v = [<span class="number">0x9021A921</span>, <span class="number">0xF53B3060</span>, <span class="number">0x8E88A84E</span>, <span class="number">0x43635AD5</span>, <span class="number">0xAC119239</span>]</span><br><span class="line">k = [<span class="number">0x12</span>, <span class="number">0x34</span>, <span class="number">0x56</span>, <span class="number">0x78</span>]</span><br><span class="line">n = <span class="built_in">len</span>(v)</span><br><span class="line"></span><br><span class="line">res = decrypt(n, v, k)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(res[i]))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(v)):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>, <span class="number">0</span>, -<span class="number">2</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">chr</span>(<span class="built_in">int</span>(<span class="built_in">str</span>(<span class="built_in">hex</span>(res[i]))[j:j+<span class="number">2</span>], <span class="number">16</span>)), end=<span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="comment"># 3e90c91c02e9b40b78b&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">miniLctf&#123;cbda59ff59e3e90c91c02e9b40b78b&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/re/" rel="tag"># re</a>
          
            <a href="/tags/game/" rel="tag"># game</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2022/04/28/%E6%AF%8F%E6%97%A5%E5%8D%9A%E5%AE%A2/4.28-angr/" rel="next" title="4.28-angr安装+入门">
                <i class="fa fa-chevron-left"></i> 4.28-angr安装+入门
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2022/05/04/game/minil2022/wasm/" rel="prev" title="wasm初探">
                wasm初探 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="" />
          <p class="site-author-name" itemprop="name"></p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">74</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">16</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#twin"><span class="nav-number">1.</span> <span class="nav-text">twin</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TLS0%E5%89%8D%E5%8D%8A%E9%83%A8%E5%88%86-%E5%A2%9E%E5%8A%A0%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0"><span class="nav-number">2.</span> <span class="nav-text">TLS0前半部分 增加回调函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0-%E4%BF%AE%E6%94%B9WriteFile%E5%87%BD%E6%95%B0%E7%9A%84%E7%B4%A2%E5%BC%95"><span class="nav-number">3.</span> <span class="nav-text">回调函数 修改WriteFile函数的索引</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%A8%E6%9D%A5%E9%A1%B6%E6%9B%BF%E7%9A%84%E5%87%BD%E6%95%B0"><span class="nav-number">4.</span> <span class="nav-text">用来顶替的函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TLS0%E5%90%8E%E5%8D%8A%E9%83%A8%E5%88%861-%E5%AD%90%E8%BF%9B%E7%A8%8B%E8%BF%90%E8%A1%8Ctmp%E6%96%87%E4%BB%B6"><span class="nav-number">5.</span> <span class="nav-text">TLS0后半部分1 子进程运行tmp文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TLS0%E5%90%8E%E5%8D%8A%E9%83%A8%E5%88%862-%E7%9B%91%E8%A7%86tmp%E6%96%87%E4%BB%B6"><span class="nav-number">6.</span> <span class="nav-text">TLS0后半部分2 监视tmp文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#tmp%E6%96%87%E4%BB%B6-%E9%AD%94%E6%94%B9xxtea%E5%B9%B6%E6%A0%A1%E9%AA%8C"><span class="nav-number">7.</span> <span class="nav-text">tmp文件 魔改xxtea并校验</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TLS0%E5%90%8E%E5%8D%8A%E9%83%A8%E5%88%863-%E6%99%AE%E9%80%9Axxtea%E5%B9%B6%E6%A0%A1%E9%AA%8C"><span class="nav-number">8.</span> <span class="nav-text">TLS0后半部分3 普通xxtea并校验</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">hzlg</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" target="_blank" rel="noopener" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" target="_blank" rel="noopener" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

</body>
</html>
