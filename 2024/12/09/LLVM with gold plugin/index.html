<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="CFI," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="部署文档">
<meta property="og:type" content="article">
<meta property="og:title" content="SOK实验-环境部署">
<meta property="og:url" content="https://hzlg.github.ioz/2024/12/09/LLVM%20with%20gold%20plugin/index.html">
<meta property="og:site_name" content="hzlg&#39;s blog">
<meta property="og:description" content="部署文档">
<meta property="og:locale">
<meta property="og:image" content="https://hzlg.github.ioz/2024/12/09/LLVM%20with%20gold%20plugin/image-20241218125147020.png">
<meta property="og:image" content="https://hzlg.github.ioz/2024/12/09/LLVM%20with%20gold%20plugin/image-20241218125808184.png">
<meta property="og:image" content="https://hzlg.github.ioz/2024/12/09/LLVM%20with%20gold%20plugin/image-20241216000518574.png">
<meta property="og:image" content="https://hzlg.github.ioz/2024/12/09/LLVM%20with%20gold%20plugin/image-20241214234824738.png">
<meta property="og:image" content="https://hzlg.github.ioz/2024/12/09/LLVM%20with%20gold%20plugin/image-20241215013235051.png">
<meta property="og:image" content="https://hzlg.github.ioz/2024/12/09/LLVM%20with%20gold%20plugin/image-20241215030248090.png">
<meta property="og:image" content="https://hzlg.github.ioz/2024/12/09/LLVM%20with%20gold%20plugin/image-20241215030312069.png">
<meta property="og:image" content="https://hzlg.github.ioz/2024/12/09/LLVM%20with%20gold%20plugin/image-20241214234726373.png">
<meta property="og:image" content="https://hzlg.github.ioz/2024/12/09/LLVM%20with%20gold%20plugin/image-20241215231620733.png">
<meta property="og:image" content="https://hzlg.github.ioz/2024/12/09/LLVM%20with%20gold%20plugin/image-20241215231740223.png">
<meta property="og:image" content="https://hzlg.github.ioz/2024/12/09/LLVM%20with%20gold%20plugin/image-20241212112751072.png">
<meta property="og:image" content="https://hzlg.github.ioz/2024/12/09/LLVM%20with%20gold%20plugin/image-20241212115222513.png">
<meta property="og:image" content="https://hzlg.github.ioz/2024/12/09/LLVM%20with%20gold%20plugin/image-20241212115900779.png">
<meta property="og:image" content="https://hzlg.github.ioz/2024/12/09/LLVM%20with%20gold%20plugin/image-20241218180844038.png">
<meta property="og:image" content="https://hzlg.github.ioz/2024/12/09/LLVM%20with%20gold%20plugin/image-20250109110431731.png">
<meta property="og:image" content="https://hzlg.github.ioz/2024/12/09/LLVM%20with%20gold%20plugin/image-20250109111123935.png">
<meta property="og:image" content="https://hzlg.github.ioz/2024/12/09/LLVM%20with%20gold%20plugin/image-20250115215148514.png">
<meta property="og:image" content="https://hzlg.github.ioz/2024/12/09/LLVM%20with%20gold%20plugin/image-20250115000444556.png">
<meta property="og:image" content="https://hzlg.github.ioz/2024/12/09/LLVM%20with%20gold%20plugin/image-20250115003320848.png">
<meta property="og:image" content="https://hzlg.github.ioz/2024/12/09/LLVM%20with%20gold%20plugin/image-20250115004530942.png">
<meta property="og:image" content="https://hzlg.github.ioz/2024/12/09/LLVM%20with%20gold%20plugin/image-20250115233708332.png">
<meta property="og:image" content="https://hzlg.github.ioz/2024/12/09/LLVM%20with%20gold%20plugin/image-20250217224357753.png">
<meta property="og:image" content="https://hzlg.github.ioz/2024/12/09/LLVM%20with%20gold%20plugin/image-20250218174734953.png">
<meta property="article:published_time" content="2024-12-09T06:25:13.850Z">
<meta property="article:modified_time" content="2025-05-13T06:57:45.941Z">
<meta property="article:author" content="hzlg">
<meta property="article:tag" content="CFI">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hzlg.github.ioz/2024/12/09/LLVM%20with%20gold%20plugin/image-20241218125147020.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://hzlg.github.ioz/2024/12/09/LLVM with gold plugin/"/>





  <title>SOK实验-环境部署 | hzlg's blog</title>
  














<meta name="generator" content="Hexo 5.4.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">hzlg's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">笔记、日常</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hzlg.github.ioz/2024/12/09/LLVM%20with%20gold%20plugin/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hzlg's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">SOK实验-环境部署</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-12-09T14:25:13+08:00">
                2024-12-09
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2025-05-13T14:57:45+08:00">
                2025-05-13
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>部署文档</p>
<span id="more"></span>

<h1 id="Virtual-Box安装"><a href="#Virtual-Box安装" class="headerlink" title="Virtual Box安装"></a>Virtual Box安装</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/GoodburghCottage/article/details/130307152">超级详细的 VirtualBox 虚拟机安装 及入门教程-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://cn.ubuntu.com/download">Ubuntu系统下载 | Ubuntu</a></p>
<p><a target="_blank" rel="noopener" href="https://ubuntu.com/tutorials/how-to-run-ubuntu-desktop-on-a-virtual-machine-using-virtualbox#1-overview">How to run an Ubuntu Desktop virtual machine using VirtualBox 7 | Ubuntu</a></p>
</blockquote>
<blockquote>
<p>增强功能：</p>
<p>C:\Program Files\Oracle\VirtualBox\VBoxGuestAdditions.iso</p>
<p>内存4096mb 处理器4 硬盘80G</p>
</blockquote>
<p>sudo apt update &amp;&amp; sudo apt upgrade -y</p>
<p>sudo snap refresh</p>
<hr>
<p><strong>virtual box共享文件夹权限</strong></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/392633895">解决virtualbox下共享文件夹权限问题 - 知乎</a></p>
</blockquote>
<p>sudo usermod -aG vboxsf $(whoami)</p>
<p>reboot</p>
<hr>
<p><strong>扩容</strong>：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_47158773/article/details/120984124">VirtualBox如何扩展虚拟机Ubuntu的硬盘容量？_virtualvox ubuntu ext4 扩容-CSDN博客</a> </p>
<p>还有用DiskGenius扩展vdi的方法，报错了没有成功</p>
<p>流程：</p>
<ul>
<li><p>关虚拟机，在virtual box调整磁盘大小</p>
</li>
<li><p>在DiskGenuis新建分区，或sudo fdisk /dev/sda新建分区（显示没空间没关系，reboot）</p>
</li>
<li><p>sudo apt install gparted</p>
<p>sudo gparted</p>
<p>删除新建的分区，就可以找到未分配空间了，resize，保存</p>
</li>
</ul>
</blockquote>
<hr>
<p><strong>Ubuntu 20.04打不开终端&amp;时间乱码问题:</strong></p>
<blockquote>
<img src="/2024/12/09/LLVM%20with%20gold%20plugin/image-20241218125147020.png" alt="image-20241218125147020" style="zoom:50%;"> 

<p>ctrl alt f6切换到终端访问界面</p>
<p>查看locale字符集，切换到zh_CN.UTF-8</p>
<p>sudo 编辑/etc/profile，新增两行代码：<br>export LANG=zh_CN.UTF-8<br>export LANGUAGE=zh_CN:zh</p>
<p>source /etc/profile</p>
<p>[Ubuntu20.04 终端打开不了的问题排查_终端打不开-CSDN博客](<a target="_blank" rel="noopener" href="https://blog.csdn.net/u010092716/article/details/130968032#:~:text=1%E3%80%81Ctrl">https://blog.csdn.net/u010092716/article/details/130968032#:~:text=1、Ctrl</a> %2B Alt %2B F6 先切换到终端访问界面 2、输入一下指令，下载一个 xterm,辅助终端 软件，临时用一下 4、输入一下指令，然后重新启动即可 5、就可以正常打开啦！ 如果上述动作还不能解决你的问题。 请在Xterm输入： 特别注意观察：LANG和LANGUAGE是否正常，如果不正常修改成上述形式；然后保存重启即可！ 文章浏览阅读2.5w次，点赞43次，收藏86次。) </p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_30317039/article/details/141124372">ubuntu系统中文显示乱码解决（将系统语言环境从en_US.UTF-8改为zh_CN.UTF-8）_ubuntu 中文乱码-CSDN博客</a></p>
</blockquote>
<hr>
<p><strong>user is not in the sudoers file:</strong></p>
<blockquote>
<img src="/2024/12/09/LLVM%20with%20gold%20plugin/image-20241218125808184.png" alt="image-20241218125808184" style="zoom:50%;"> 

<p>[<a target="_blank" rel="noopener" href="https://blog.csdn.net/Moelimoe/article/details/105292219">已解决]user is not in the sudoers file. This incident will be reported.(简单不容易出错的方式)_ubuntu18.04 is not in the sudoers file. this incid-CSDN博客</a> </p>
</blockquote>
<h1 id="LLVMCFI"><a href="#LLVMCFI" class="headerlink" title="LLVMCFI"></a>LLVMCFI</h1><h2 id="gcc4-9-3安装流程"><a href="#gcc4-9-3安装流程" class="headerlink" title="gcc4.9.3安装流程"></a>gcc4.9.3安装流程</h2><blockquote>
<p>安装低版本的gcc</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/662657371">从源码构建gcc扫雷笔记 - 知乎</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/dickwang1229/article/details/50296855">CentOS6.2编译llvm3.7.0-CSDN博客</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> gcc-4.9.3</span><br><span class="line">./contrib/download_prerequisites</span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line">mkdir build_gcc</span><br><span class="line"><span class="built_in">cd</span> build_gcc</span><br><span class="line"><span class="comment"># 装完GMP之后，需要指定路径</span></span><br><span class="line"><span class="comment">#../gcc-4.9.3/configure -enable-languages=c,c++ -disable-multilib</span></span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=/usr/<span class="built_in">local</span>/mpc-0.8.1/lib/:<span class="variable">$LD_LIBRARY_PATH</span></span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=/usr/<span class="built_in">local</span>/mpfr-2.4.2/lib/:<span class="variable">$LD_LIBRARY_PATH</span></span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=/usr/<span class="built_in">local</span>/gmp-4.3.2/lib/:<span class="variable">$LD_LIBRARY_PATH</span></span><br><span class="line">../gcc-4.9.3/configure -enable-languages=c,c++ -disable-multilib --with-gmp=/usr/<span class="built_in">local</span>/gmp-4.3.2 --with-mpfr=/usr/<span class="built_in">local</span>/mpfr-2.4.2 --with-mpc=/usr/<span class="built_in">local</span>/mpc-0.8.1 --prefix=/home/hzlg/Desktop/gcc4/install_gcc</span><br><span class="line">find ../ -name <span class="string">&quot;Intrinsics.gen&quot;</span></span><br><span class="line">make -j4</span><br><span class="line">sudo make install</span><br><span class="line">sudo update-alternatives --install /usr/bin/gcc gcc /home/hzlg/Desktop/gcc4/install_gcc/bin/gcc 20</span><br><span class="line">sudo update-alternatives --install /usr/bin/g++ g++ /home/hzlg/Desktop/gcc4/install_gcc/bin/g++ 20</span><br></pre></td></tr></table></figure>

<img src="/2024/12/09/LLVM%20with%20gold%20plugin/image-20241216000518574.png" alt="image-20241216000518574" style="zoom:50%;"> 
</blockquote>
<hr>
<blockquote>
<p>需要prerequisites,包括GMP,MPFR,MPC等</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zhiminyu/p/18267733">linux 安装gcc—GMP, MPFR and MPC - burlingame - 博客园</a></p>
<p>gcc.gnu.org/pub/gcc/infrastructure/mpfr-2.4.2.tar.bz2</p>
<p>gcc.gnu.org/pub/gcc/infrastructure/gmp-4.3.2.tar.bz2</p>
<p>gcc.gnu.org/pub/gcc/infrastructure/mpc-0.8.1.tar.gz</p>
<p>gcc.gnu.org/pub/gcc/infrastructure/isl-0.12.2.tar.bz2</p>
<p>gcc.gnu.org/pub/gcc/infrastructure/cloog-0.18.1.tar.gz</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install m4</span><br><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line">wget ftp://ftp.gnu.org/gnu/gmp/gmp-4.3.2.tar.bz2</span><br><span class="line">tar -vxf gmp-4.3.2.tar.bz2</span><br><span class="line"><span class="built_in">cd</span> gmp-4.3.2/</span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/gmp-4.3.2</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br><span class="line"><span class="comment"># install完提示检查一下出错没，check完发现有一个bug</span></span><br><span class="line">make check</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line">wget https://ftp.gnu.org/gnu/mpfr/mpfr-2.4.2.tar.bz2</span><br><span class="line">tar -vxf mpfr-2.4.2.tar.bz2</span><br><span class="line"><span class="built_in">cd</span> mpfr-2.4.2/</span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/mpfr-2.4.2 --with-gmp=/usr/<span class="built_in">local</span>/gmp-4.3.2</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line">wget gcc.gnu.org/pub/gcc/infrastructure/mpc-0.8.1.tar.gz</span><br><span class="line">tar -vxf mpc-0.8.1.tar.gz</span><br><span class="line"><span class="built_in">cd</span> mpc-0.8.1/</span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/mpc-0.8.1 --with-gmp=/usr/<span class="built_in">local</span>/gmp-4.3.2 --with-mpfr=/usr/<span class="built_in">local</span>/mpfr-2.4.2</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/ComputerInBook/article/details/107100738">编译isl和cloog库出现：fatal error: gmp.h: No such file or directory-CSDN博客</a></p>
<p>新版本的isl不用–with-gmp，用–with-gmp-prefix</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line">wget gcc.gnu.org/pub/gcc/infrastructure/isl-0.12.2.tar.bz2</span><br><span class="line">tar -vxf isl-0.12.2.tar.bz2</span><br><span class="line"><span class="built_in">cd</span> isl-0.12.2</span><br><span class="line"><span class="comment"># 新版本的isl编译参数不再为--with-gmp，而是--with-gmp-prefix</span></span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/isl-0.12.2 --with-gmp-prefix=/usr/<span class="built_in">local</span>/gmp-4.3.2</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line">wget gcc.gnu.org/pub/gcc/infrastructure/cloog-0.18.1.tar.gz</span><br><span class="line">tar -vxf cloog-0.18.1.tar.gz</span><br><span class="line"><span class="built_in">cd</span> cloog-0.18.1</span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/cloog-0.18.1 --with-gmp-prefix=/usr/<span class="built_in">local</span>/gmp-4.3.2</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

</blockquote>
<hr>
<blockquote>
<p>make之后报错error: use of an operand of type ‘bool’ in‘operator++’ is forbidden in C++17</p>
<img src="/2024/12/09/LLVM%20with%20gold%20plugin/image-20241214234824738.png" alt="image-20241214234824738" style="zoom: 33%;"> 

<p>原因是编译器版本太新了</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Freetz-NG/freetz-ng/discussions/396">gcc-4.8.5: “error: use of an operand of type‘ bool ’in‘ operator ++ ’is forbidden in C ++ 17” · Freetz-NG/freetz-ng · Discussion #396</a></p>
<p><del><a target="_blank" rel="noopener" href="https://www.soinside.com/question/ZhpMeL6wVRHaK6UDZyfMgC">如何从源代码在 ubuntu 24.04 上构建和安装编译器 g++-4.8.5？ - linux - SO中文参考 - www.soinside.com</a></del></p>
<p>解决方案：装一个老一点的gcc（7.5.0），用老gcc编老老gcc</p>
<p><del>【error: use of an operand of type ‘bool’ in ‘operator++’ is forbidden in C++17 这个问题是因为，新版 gcc 已经默认的语言标准使用 C++17 了，所以一些旧的写法算语法错误。只需要编译的时候使用旧标准就行，make 的时候加参数，make CXXFLAGS=”-std=c++11” 即可】</del></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/662657371">c++编译器版本太新了 解决方案：装一个老一点的 gcc</a></p>
</blockquote>
<hr>
<blockquote>
<img src="/2024/12/09/LLVM%20with%20gold%20plugin/image-20241215013235051.png" alt="image-20241215013235051" style="zoom:50%;"> 

<p>const char*啥的，这个错误要根据补丁修改gcc4的源码:</p>
<p><a target="_blank" rel="noopener" href="https://www.reddit.com/r/linuxquestions/comments/ohrn9f/i_cant_compile_gcc_error_const_char_libc_name/?rdt=33636">I can’t compile GCC. Error: ‘const char* libc_name_p(const char*, unsigned int)’ redeclared inline with ‘gnu_inline’ attribute : r/linuxquestions</a></p>
<p><a target="_blank" rel="noopener" href="https://gcc.gnu.org/git/?p=gcc.git;a=commitdiff;h=3a27b4db566c2cde8e043220f3d2c5401159b10e;hp=871b3f473a4bca51d05c1682efb5017385ec9e9e">gcc.gnu.org Git - gcc.git/commitdiff</a></p>
<img src="/2024/12/09/LLVM%20with%20gold%20plugin/image-20241215030248090.png" alt="image-20241215030248090" style="zoom:50%;"> 

<img src="/2024/12/09/LLVM%20with%20gold%20plugin/image-20241215030312069.png" alt="image-20241215030312069" style="zoom:50%;"> 

<p><a target="_blank" rel="noopener" href="https://github.com/gcc-mirror/gcc/commit/71b55d45e4304f5e2e98ac30473c581f58fc486b#diff-da6f8e2978021510a4487148326e4c9cc3423dac19956981d48cc2116b2f2241R253">libsanitizer: Use pre-computed size of struct ustat for Linux · gcc-mirror/gcc@71b55d4</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/gcc-mirror/gcc/commit/2701442d0cf6292f6624443c15813d6d1a3562fe#diff-b1a8febe72517ebb4c073f648248b2276e437d245e26a52f6518b63464a4ee4eL872">libsanitizer: cherry-pick 9cf13067cb5088626ba7 from upstream · gcc-mirror/gcc@2701442</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/llvm-mirror/compiler-rt/commit/8a5e425a68de4d2c80ff00a97bbcb3722a4716da">Fix sanitizer build against latest glibc · llvm-mirror/compiler-rt@8a5e425</a> </p>
</blockquote>
<h2 id="gcc5安装流程"><a href="#gcc5安装流程" class="headerlink" title="gcc5安装流程"></a>gcc5安装流程</h2><blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">sudo bash -c <span class="string">&quot;echo &#x27;deb https://mirrors.aliyun.com/ubuntu/ xenial main&#x27; &gt;&gt; /etc/apt/sources.list&quot;</span></span><br><span class="line">sudo bash -c <span class="string">&quot;echo &#x27;deb-src https://mirrors.aliyun.com/ubuntu/ xenial main&#x27; &gt;&gt; /etc/apt/sources.list&quot;</span> </span><br><span class="line">sudo bash -c <span class="string">&quot;echo &#x27;deb https://mirrors.aliyun.com/ubuntu/ xenial universe&#x27; &gt;&gt; /etc/apt/sources.list&quot;</span> </span><br><span class="line">sudo bash -c <span class="string">&quot;echo &#x27;deb-src https://mirrors.aliyun.com/ubuntu/ xenial universe&#x27; &gt;&gt; /etc/apt/sources.list&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># -------</span></span><br><span class="line">sudo vim /etc/apt/sources.list</span><br><span class="line">在文件末尾添加：</span><br><span class="line">deb https://mirrors.aliyun.com/ubuntu/ xenial main</span><br><span class="line">deb-src https://mirrors.aliyun.com/ubuntu/ xenial main</span><br><span class="line"></span><br><span class="line">deb https://mirrors.aliyun.com/ubuntu/ xenial universe</span><br><span class="line">deb-src https://mirrors.aliyun.com/ubuntu/ xenial universe</span><br><span class="line"><span class="comment"># -------</span></span><br><span class="line"></span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt install g++-5 gcc-5</span><br><span class="line">sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-5 50</span><br><span class="line">sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-5 50</span><br></pre></td></tr></table></figure>

</blockquote>
<h2 id="gcc7-5-0安装流程"><a href="#gcc7-5-0安装流程" class="headerlink" title="gcc7.5.0安装流程"></a>gcc7.5.0安装流程</h2><blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install build-essential libgmp-dev libmpfr-dev libmpc-dev zlib1g-dev gawk</span><br><span class="line">wget http://ftp.gnu.org/gnu/gcc/gcc-7.5.0/gcc-7.5.0.tar.gz</span><br><span class="line">tar xzf gcc-7.5.0.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># -------</span></span><br><span class="line"><span class="comment"># 根据https://github.com/spack/spack/commit/6fb6b28d51f50287ac1c399c639caa7c4e2914cc，patch gcc7.5.0的源码</span></span><br><span class="line">vim gcc-7.5.0/libsanitizer/sanitizer_common/sanitizer_platform_limits_posix.cc</span><br><span class="line">vim gcc-7.5.0/libsanitizer/sanitizer_common/sanitizer_platform_limits_posix.h</span><br><span class="line"><span class="comment"># -------</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> gcc-7.5.0</span><br><span class="line">mkdir build &amp;&amp; <span class="built_in">cd</span> build</span><br><span class="line">sudo mkdir /usr/<span class="built_in">local</span>/gcc-7.5.0</span><br><span class="line">../configure --enable-languages=c,c++ --disable-werror --disable-multilib --prefix=/usr/<span class="built_in">local</span>/gcc-7.5.0</span><br><span class="line">make -j4</span><br><span class="line">sudo make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加</span></span><br><span class="line"><span class="comment"># sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-9 90</span></span><br><span class="line"><span class="comment"># sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-9 90</span></span><br><span class="line">sudo update-alternatives --install /usr/bin/gcc gcc /usr/<span class="built_in">local</span>/gcc-7.5.0/bin/gcc 70</span><br><span class="line">sudo update-alternatives --install /usr/bin/g++ g++ /usr/<span class="built_in">local</span>/gcc-7.5.0/bin/g++ 70</span><br><span class="line"><span class="comment"># 选择，如果选择完，gcc -v不变，在~/.bashrc export PATH=&quot;/usr/bin:$PATH&quot;</span></span><br><span class="line">sudo update-alternatives --config gcc</span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">sudo update-alternatives --display gcc</span><br><span class="line"><span class="comment"># 移除</span></span><br><span class="line">sudo update-alternatives --remove gcc /usr/bin/gcc-7</span><br></pre></td></tr></table></figure>

</blockquote>
<hr>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_21161993/article/details/88428716">gcc configure: error: I suspect your system does not have 32-bit developement libraries (libc and-CSDN博客</a></p>
<hr>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/hanbingchegu/article/details/107060579">cc1：加载共享库时出错：libmpc.so.2：无法打开共享对象文件：没有这样的文件或目录_error while loading shared libraries: libmpc.so.2:-CSDN博客</a></p>
<p>sudo apt install plocate</p>
<p>locate libmpc.so.2</p>
</blockquote>
<hr>
<blockquote>
<p>error: size of array ‘assertion_failed__1150’ is negative</p>
<img src="/2024/12/09/LLVM%20with%20gold%20plugin/image-20241214234726373.png" alt="image-20241214234726373" style="zoom:50%;"> 

<p><a target="_blank" rel="noopener" href="https://github.com/spack/spack/commit/6fb6b28d51f50287ac1c399c639caa7c4e2914cc">gcc: Fix error ‘size of array is negative’ (#16968) · spack/spack@6fb6b28</a> </p>
</blockquote>
<hr>
<blockquote>
<p>make VERBOSE=1可以让打印信息更加详细</p>
<p>查看报错的具体原因:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -j$(nproc) &gt; /tmp/out.log 2&gt; /tmp/err.log</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="glod-plugin安装流程"><a href="#glod-plugin安装流程" class="headerlink" title="glod plugin安装流程"></a>glod plugin安装流程</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://llvm.org/docs/GoldPlugin.html#lto-how-to-build">The LLVM gold plugin — LLVM 20.0.0git documentation</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_47778392/article/details/141099209">从源码开始部署 SVF 并且让配套的 LLVM 包含 gold 插件_llvm gold-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/SVF-tools/SVF/wiki/Install-LLVM-Gold-Plugin-on-Ubuntu">Install LLVM Gold Plugin on Ubuntu · SVF-tools/SVF Wiki</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/timmyyuan/build-whole-program-into-LLVM-IR?tab=readme-ov-file">build-whole-program-into-LLVM-IR: some notes for how to build projects into a single LLVM bitcode file.</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43971060/article/details/93464535">LLVM gold插件安装步骤-CSDN博客</a> </p>
</blockquote>
<p>You need to have gold with plugin support and build the LLVMgold plugin. The gold linker is installed as ld.gold. To see whether gold is the default on your system, run <code>/usr/bin/ld -v</code>. It will report “GNU gold” or else “GNU ld” if not.  </p>
<p><strong>检查 Gold 是否为默认链接器：</strong></p>
<p>运行以下命令来查看当前系统使用的链接器：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/ld -v</span><br></pre></td></tr></table></figure>

<ul>
<li>如果输出显示 <code>&quot;GNU gold&quot;</code>，那么 Gold 链接器已经是默认链接器。</li>
<li>如果输出显示 <code>&quot;GNU ld&quot;</code>，则表示你的系统没有使用 Gold 链接器，而是传统的 GNU 链接器。</li>
</ul>
<p>If gold is already installed at <code>/usr/bin/ld.gold</code>, one option is to simply make that the default by backing up your existing <code>/usr/bin/ld</code> and creating a symbolic link with <code>ln -s /usr/bin/ld.gold /usr/bin/ld</code>.Alternatively, you can build with clang’s <code>-fuse-ld=gold</code> or add <code>-fuse-ld=gold</code> to LDFLAGS, which will cause the clang driver to invoke <code>/usr/bin/ld.gold</code> directly.</p>
<p><strong>设置 Gold 为默认链接器：</strong></p>
<p>如果 Gold 已经安装在 <code>/usr/bin/ld.gold</code>，但你的系统使用的是传统的 <code>ld</code> 链接器，你可以通过创建符号链接将 Gold 设置为默认链接器：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份现有的 ld 链接器</span></span><br><span class="line">sudo mv /usr/bin/ld /usr/bin/ld.bak</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建符号链接，将 ld 指向 ld.gold</span></span><br><span class="line">sudo ln -s /usr/bin/ld.gold /usr/bin/ld</span><br></pre></td></tr></table></figure>

<p>或者，你也可以通过在构建时指定使用 Gold 链接器：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -fuse-ld=gold ...</span><br></pre></td></tr></table></figure>

<p>或者将 <code>-fuse-ld=gold</code> 添加到 <code>LDFLAGS</code> 环境变量中：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> LDFLAGS=<span class="string">&quot;-fuse-ld=gold&quot;</span></span><br></pre></td></tr></table></figure>

<p>这样 Clang 会使用 <code>/usr/bin/ld.gold</code> 进行链接。</p>
<p>If you have gold installed, check for plugin support by running <code>/usr/bin/ld.gold -plugin</code>. If it complains “missing argument” then you have plugin support. If not, and you get an error such as “unknown option”, then you will either need to build gold or install a version with plugin support.</p>
<p><strong>检查 Gold 链接器是否支持插件</strong></p>
<p>Gold 链接器支持插件，检查是否启用了插件支持：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/ld.gold -plugin</span><br></pre></td></tr></table></figure>

<ul>
<li>如果输出显示 “missing argument”，表示插件支持已经启用。</li>
<li>如果输出显示错误，比如 “unknown option”，则表示你的 Gold 链接器不支持插件，可能需要重新编译 Gold 来启用插件支持。</li>
</ul>
<p>Download, configure and build gold with plugin support:</p>
<p>That should leave you with <code>build/gold/ld-new</code> which supports the <code>-plugin</code> option. Running <code>make</code> will additionally build <code>build/binutils/ar</code> and <code>nm-new</code> binaries supporting plugins.</p>
<p>Once you’re ready to switch to using gold, backup your existing <code>/usr/bin/ld</code> then replace it with <code>ld-new</code>. Alternatively, install in <code>/usr/bin/ld.gold</code> and use <code>-fuse-ld=gold</code> as described earlier.</p>
<p>Optionally, add <code>--enable-gold=default</code> to the above configure invocation to automatically install the newly built gold as the default linker with <code>make install</code>.</p>
<h3 id="下载并构建-Gold-链接器与插件支持"><a href="#下载并构建-Gold-链接器与插件支持" class="headerlink" title="下载并构建 Gold 链接器与插件支持"></a><strong>下载并构建 Gold 链接器与插件支持</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 一些前置安装</span></span><br><span class="line">sudo apt install git</span><br><span class="line">sudo apt install libgmp-dev libmpfr-dev</span><br><span class="line">sudo apt-get install apt-file texinfo texi2html</span><br><span class="line">sudo apt install bison flex</span><br></pre></td></tr></table></figure>

<p>如果你的系统没有启用插件支持，或者你需要重新安装一个支持插件的版本，你可以通过以下步骤来编译和安装 Gold 链接器：</p>
<ol>
<li><p><strong>克隆源码</strong>： 首先，克隆 <code>binutils-gdb</code> 仓库，这是包含 Gold 链接器的源代码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> --depth 1 git://sourceware.org/git/binutils-gdb.git binutils</span><br></pre></td></tr></table></figure></li>
<li><p><strong>配置和构建</strong>： 创建一个构建目录并配置构建选项，启用 Gold 和插件支持。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir /usr/<span class="built_in">local</span>/install_binutils</span><br><span class="line">mkdir build_binutils &amp;&amp; <span class="built_in">cd</span> build_binutils</span><br><span class="line"><span class="comment"># gcc 4.9不行，gcc 13可以，要用C++17以上的</span></span><br><span class="line">../binutils/configure --enable-gold --enable-plugins --disable-werror --prefix=/usr/<span class="built_in">local</span>/install_binutils</span><br></pre></td></tr></table></figure>

<ul>
<li><code>--enable-gold</code>: 启用 Gold 链接器支持。</li>
<li><code>--enable-plugins</code>: 启用插件支持。</li>
<li><code>--disable-werror</code>: 禁用将警告当作错误的选项（避免因警告导致构建失败）。</li>
</ul>
</li>
<li><p><strong>构建 Gold 链接器</strong>： 构建 Gold 链接器及其插件支持。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make all-gold</span><br></pre></td></tr></table></figure>

<p>构建完成后，生成的 Gold 链接器会位于 <code>build/gold/ld-new</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make -j4</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<blockquote>
<p>![image-20241212101356473](LLVM with gold plugin/image-20241212101356473.png) </p>
</blockquote>
</li>
<li><p><strong>替换或安装 Gold 链接器</strong>： 你可以将 <code>ld-new</code> 替换为系统默认的 <code>ld</code>，或者将其安装到 <code>/usr/bin/ld.gold</code>，并通过 <code>-fuse-ld=gold</code> 使用它。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份现有 ld 链接器</span></span><br><span class="line">sudo mv /usr/bin/ld /usr/bin/ld.bak</span><br><span class="line"></span><br><span class="line"><span class="comment"># 替换为新构建的 ld-new</span></span><br><span class="line">sudo mv build/gold/ld-new /usr/bin/ld</span><br></pre></td></tr></table></figure>

<p>或者将其安装到 <code>/usr/bin/ld.gold</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mv build/gold/ld-new /usr/bin/ld.gold</span><br></pre></td></tr></table></figure></li>
</ol>
<p>Build the LLVMgold plugin. Run CMake with <code>-DLLVM_BINUTILS_INCDIR=/path/to/binutils/include</code>. The correct include path will contain the file <code>plugin-api.h</code>.</p>
<h2 id="LLVM-gold"><a href="#LLVM-gold" class="headerlink" title="LLVM+gold"></a>LLVM+gold</h2><p>Building LLVM With Autotools</p>
<p>LLVMgold 插件使得 Clang 能够使用 Gold 链接器进行链接时优化（LTO）。要构建和启用该插件：</p>
<ol>
<li><p><strong>指定 <code>binutils</code> 的头文件路径</strong>： 当你使用 <code>CMake</code> 构建 LLVM 时，需要告诉 <code>CMake</code> <code>binutils</code> 的头文件路径，特别是 <code>plugin-api.h</code> 文件。可以通过以下方式设置 <code>LLVM_BINUTILS_INCDIR</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmake -DLLVM_BINUTILS_INCDIR=/path/to/binutils/include ...</span><br></pre></td></tr></table></figure>

<p>其中，<code>/path/to/binutils/include</code> 是 <code>binutils</code> 安装路径中的 <code>include</code> 目录，包含 <code>plugin-api.h</code> 文件。</p>
</li>
<li><p><strong>构建 LLVMgold 插件</strong>： 通过运行 <code>CMake</code> 和 <code>make</code> 来构建 LLVMgold 插件。具体步骤可以参考你当前的 LLVM 项目构建文档。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> build_llvm</span><br><span class="line">cmake ../ -DLLVM_BINUTILS_INCDIR=/home/hzlg/Desktop/gold/install_binutils/include/ -DCMAKE_BUILD_TYPE=Release -DLLVM_TARGETS_TO_BUILD=X86 -DCMAKE_INSTALL_PREFIX=/home/hzlg/Desktop/llvm15/llvm-15.0.7.src/install_llvm/</span><br><span class="line"><span class="comment"># 有两个包含include的目录</span></span><br><span class="line">cmake ../ -DLLVM_BINUTILS_INCDIR=/home/hzlg/Desktop/gold/binutils/include -DCMAKE_BUILD_TYPE=Release -DLLVM_TARGETS_TO_BUILD=X86 -DCMAKE_INSTALL_PREFIX=/home/hzlg/Desktop/llvm15/llvm-15.0.7.src/install_llvm</span><br><span class="line">make -j4</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="LLVM-15安装流程"><a href="#LLVM-15安装流程" class="headerlink" title="LLVM 15安装流程"></a>LLVM 15安装流程</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://releases.llvm.org/">Download LLVM releases</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/614675827">Ubuntu安装LLVM15 - 知乎</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Night_ZW/article/details/108359715">【LLVM】Llvm 源码编译安装_llvm源码编译-CSDN博客</a></p>
</blockquote>
<p>sudo apt install gcc g++ cmake make python3</p>
<p><del>sudo apt install subversion zlib1g zlib1g-dev</del></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/llvm/llvm-project/releases/download/llvmorg-15.0.7/clang-15.0.7.src.tar.xz</span><br><span class="line">wget https://github.com/llvm/llvm-project/releases/download/llvmorg-15.0.7/cmake-15.0.7.src.tar.xz</span><br><span class="line">wget https://github.com/llvm/llvm-project/releases/download/llvmorg-15.0.7/llvm-15.0.7.src.tar.xz</span><br><span class="line">tar -xf clang-15.0.7.src.tar.xz</span><br><span class="line">tar -xf cmake-15.0.7.src.tar.xz</span><br><span class="line">tar -xf llvm-15.0.7.src.tar.xz</span><br><span class="line"></span><br><span class="line">mv clang-15.0.7.src llvm-15.0.7.src/tools/</span><br><span class="line">cp cmake-15.0.7.src/Modules/* llvm-15.0.7.src/cmake/modules/</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> llvm-15.0.7.src</span><br><span class="line">mkdir install_llvm</span><br><span class="line">mkdir build_llvm &amp;&amp; <span class="built_in">cd</span> build_llvm</span><br><span class="line">cmake ../ -G <span class="string">&quot;Unix Makefiles&quot;</span> -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/home/hzlg/Desktop/llvm15/llvm-15.0.7.src/install_llvm              </span><br><span class="line">make -j4</span><br><span class="line">make check-all</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<h2 id="LLVM-3-7-0安装流程"><a href="#LLVM-3-7-0安装流程" class="headerlink" title="LLVM 3.7.0安装流程"></a>LLVM 3.7.0安装流程</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_63471305/article/details/139568496">获取并编译 LLVM 3.0 的详细步骤-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/dickwang1229/article/details/50296855">CentOS6.2编译llvm3.7.0-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_36537774/article/details/109441791">LLVM完整参考安装_llvm 安装白-CSDN博客</a> </p>
<p>需要安装低版本的gcc</p>
<p>安装完后：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">tar -xf llvm-3.7.0.src.tar.xz </span><br><span class="line">tar -xf cfe-3.7.0.src.tar.xz </span><br><span class="line">tar -xf clang-tools-extra-3.7.0.src.tar.xz </span><br><span class="line">tar -xf compiler-rt-3.7.0.src.tar.xz </span><br><span class="line">tar -xf libcxx-3.7.0.src.tar.xz</span><br><span class="line">mv cfe-3.7.0.src clang</span><br><span class="line">mv clang llvm-3.7.0.src/tools/</span><br><span class="line">mv clang-tools-extra-3.7.0.src extra</span><br><span class="line">mv extra/ llvm-3.7.0.src/tools/clang/</span><br><span class="line">mv compiler-rt-3.7.0.src compiler-rt</span><br><span class="line">mv compiler-rt llvm-3.7.0.src/projects/</span><br><span class="line"><span class="built_in">cd</span> llvm-3.7.0.src/</span><br><span class="line">sudo mkdir /usr/<span class="built_in">local</span>/llvm3.7.0</span><br><span class="line">mkdir build_llvm &amp;&amp; <span class="built_in">cd</span> build_llvm</span><br><span class="line"><span class="comment"># cmake ../ -G &quot;Unix Makefiles&quot; -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr/local/llvm3.7.0</span></span><br><span class="line"><span class="comment"># 指定gcc版本</span></span><br><span class="line"><span class="comment"># CC=&quot;/home/hzlg/Desktop/gcc4/install_gcc/bin/gcc&quot; CXX=&quot;/home/hzlg/Desktop/gcc4/install_gcc/bin/g++&quot; cmake ../ -G &quot;Unix Makefiles&quot; -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr/local/llvm3.7.0</span></span><br><span class="line"><span class="comment"># 加入gold</span></span><br><span class="line">cmake ../ -G <span class="string">&quot;Unix Makefiles&quot;</span> -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr/<span class="built_in">local</span>/llvm3.7.0 -DLLVM_BINUTILS_INCDIR=/home/hzlg/Desktop/gold/binutils/include/</span><br><span class="line">make -j4</span><br><span class="line">make check-all</span><br><span class="line">sudo make install</span><br><span class="line"><span class="comment"># 查看是否安装成功</span></span><br><span class="line">sudo update-alternatives --install /usr/bin/llvm-config llvm-config /home/hzlg/Desktop/llvm3.7.0/llvm-3.7.0.src/install_llvm/bin/llvm-config 20</span><br><span class="line">sudo update-alternatives --install /usr/bin/clang clang /home/hzlg/Desktop/llvm3.7.0/llvm-3.7.0.src/install_llvm/bin/clang 20</span><br><span class="line">llvm-config --version</span><br><span class="line">clang --versoin</span><br></pre></td></tr></table></figure>

</blockquote>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/gcc-mirror/gcc/commit/71b55d45e4304f5e2e98ac30473c581f58fc486b#diff-da6f8e2978021510a4487148326e4c9cc3423dac19956981d48cc2116b2f2241R253">libsanitizer: Use pre-computed size of struct ustat for Linux · gcc-mirror/gcc@71b55d4</a> </p>
</blockquote>
<blockquote>
<p>找不到crtbegin.o(在gcc_install的lib里)</p>
<p>clang -flto a.a b.o -o main –sysroot=/home/hzlg/Desktop/gcc4/install_gcc/lib/gcc</p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/44528465/usr-bin-ld-crtbegin-o-no-such-file-no-such-file-or-directory">c++ - /usr/bin/ld: crtbegin.o: No such file: No such file or directory - Stack Overflow</a> </p>
<img src="/2024/12/09/LLVM%20with%20gold%20plugin/image-20241215231620733.png" alt="image-20241215231620733" style="zoom:50%;"> 

<p>找不到crt1.o</p>
<img src="/2024/12/09/LLVM%20with%20gold%20plugin/image-20241215231740223.png" alt="image-20241215231740223" style="zoom:50%;"> 

<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/3299511/missing-crt1-and-crti-when-crosscompiling">gcc - Missing crt1 and crti when crosscompiling - Stack Overflow</a> </p>
</blockquote>
<h2 id="gold测试"><a href="#gold测试" class="headerlink" title="gold测试"></a><strong>gold测试</strong></h2><blockquote>
<p>找不到LLVMgold.so</p>
<img src="/2024/12/09/LLVM%20with%20gold%20plugin/image-20241212112751072.png" alt="image-20241212112751072" style="zoom:50%;"> 

<p><del>把/usr/bin/ld换成/usr/bin/ld.gold的话，会找不到a.a的符号表</del></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/ask/sof/660771">如何安装clang+llvm的LLVMgold.so二进制包？-腾讯云开发者社区-腾讯云</a></p>
<p>在build_llvm里能找到LLVMgold.so</p>
<img src="/2024/12/09/LLVM%20with%20gold%20plugin/image-20241212115222513.png" alt="image-20241212115222513" style="zoom:50%;"> 

<p>sudo ln -sf /home/hzlg/Desktop/llvm15/llvm-15.0.7.src/build_llvm/lib/LLVMgold.so /usr/local/lib/LLVMgold.so</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">--- a.c ---</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">foo1</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">foo4</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo2</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Foo2\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo3</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  foo4();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  foo1();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">--- b.c ---</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">foo2</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo1</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  foo2();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo4</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Foo4&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">--- <span class="built_in">command</span> lines ---</span><br><span class="line">$ clang -flto a.c -c -o a.o      <span class="comment"># &lt;-- a.o is LLVM bitcode file</span></span><br><span class="line">$ ar q a.a a.o                   <span class="comment"># &lt;-- a.a is an archive with LLVM bitcode</span></span><br><span class="line"><span class="comment"># sudo apt install llvm</span></span><br><span class="line"><span class="comment"># llvm-ranlib a.a</span></span><br><span class="line">$ clang b.c -c -o b.o            <span class="comment"># &lt;-- b.o is native object file</span></span><br><span class="line">$ clang -flto a.a b.o -o main    <span class="comment"># &lt;-- link with LLVMgold plugin</span></span><br><span class="line"><span class="comment"># 如果报错/usr/bin/ld: a.a: error adding symbols: archive has no index; run ranlib to add one，是因为系统默认的nm和ar不支持bitcode，要将llvm-nm和llvm-ar注册到/usr/bin/nm和/usr/bin/ar</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>![image-20250104200644984](LLVM with gold plugin/image-20250104200644984.png) </p>
<p>当你使用 <code>clang -flto</code> 时，编译器生成的 <code>.o</code> 文件通常是 <strong>LLVM 位码文件</strong>，而不是传统的机器码（例如 <code>.elf</code> 文件）。这些位码文件可以进行 <strong>链接时优化</strong>（LTO），并且它们不一定与常规的目标文件兼容。</p>
<p><code>nm</code> 用于查看目标文件中的符号表，然而它通常期望的是一个传统的目标文件（如 ELF 格式的 <code>.o</code> 文件）。当你使用 <code>clang -flto</code> 时，生成的 <code>.o</code> 文件是 LLVM 位码文件，这种文件的格式与标准的目标文件不同，<code>nm</code> 无法正确处理它。</p>
<p>如果你只是想查看符号表，尝试使用 <code>llvm-nm</code> 而不是 <code>nm</code>，因为 <code>llvm-nm</code> 可以处理 LLVM 位码文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">llvm-nm a.o</span><br></pre></td></tr></table></figure>

<p>如果你需要查看完整的符号信息，可以使用 <code>llvm-objdump</code> 来代替 <code>nm</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">llvm-objdump -t a.o</span><br></pre></td></tr></table></figure>
</blockquote>
<ol>
<li><strong><code>clang -flto a.c -c -o a.o</code></strong></li>
</ol>
<ul>
<li><strong>作用</strong>: 这条命令编译源代码 <code>a.c</code>，并生成一个 <strong>LLVM bitcode</strong> 文件 <code>a.o</code>。</li>
<li><code>-flto</code>: 启用链接时优化（LTO）。LTO 允许在链接阶段对整个程序进行优化，而不仅仅是在编译阶段。</li>
<li><code>-c</code>: 只编译，不进行链接，生成目标文件（<code>a.o</code>）。</li>
<li><code>-o a.o</code>: 指定输出文件名为 <code>a.o</code>，这个文件是 LLVM 的 bitcode 文件，它包含了源代码经过编译后的中间表示。</li>
</ul>
<ol start="2">
<li><strong><code>ar q a.a a.o</code></strong></li>
</ol>
<ul>
<li><strong>作用</strong>: 这条命令将 <code>a.o</code> 文件打包成一个静态库 <code>a.a</code>。</li>
<li><code>ar q a.a a.o</code>: <code>ar</code> 是一个归档工具，它会将目标文件 <code>a.o</code> 添加到静态库 <code>a.a</code> 中。</li>
<li>静态库 <code>a.a</code> 现在包含了 LLVM bitcode 文件。</li>
</ul>
<ol start="3">
<li><strong><code>clang b.c -c -o b.o</code></strong></li>
</ol>
<ul>
<li><strong>作用</strong>: 这条命令编译源文件 <code>b.c</code>，并生成一个本地的目标文件 <code>b.o</code>。</li>
<li><code>-c</code>: 只进行编译，不链接，生成目标文件。</li>
<li><code>-o b.o</code>: 指定输出文件名为 <code>b.o</code>。这个文件是本地机器代码，不包含 LLVM bitcode。</li>
</ul>
<ol start="4">
<li><strong><code>clang -flto a.a b.o -o main</code></strong></li>
</ol>
<ul>
<li><strong>作用</strong>: 这条命令将静态库 <code>a.a</code>（其中包含 LLVM bitcode）和目标文件 <code>b.o</code>（本地对象文件）一起链接成一个可执行文件 <code>main</code>，并使用 <strong>LLVMgold 插件</strong> 进行链接时优化。</li>
<li><code>-flto</code>: 启用链接时优化（LTO），这意味着链接器会将 <code>a.a</code> 中的 LLVM bitcode 与 <code>b.o</code> 进行优化，并生成最终的可执行文件。</li>
<li><code>a.a</code>: 这是包含 LLVM bitcode 的静态库，之前通过 <code>ar</code> 命令创建。</li>
<li><code>b.o</code>: 这是本地目标文件，它是经过标准编译生成的机器代码。</li>
<li><code>-o main</code>: 指定输出文件为 <code>main</code>，这是最终生成的可执行文件。</li>
<li><strong>LLVMgold插件</strong>: 链接时会使用 <strong>LLVMgold</strong> 插件，它是一个通过 LTO 和 LLVM 提供优化的链接器插件。它允许链接器处理静态库中的 LLVM bitcode 文件并与本地目标文件（如 <code>b.o</code>）进行优化和合并。</li>
</ul>
<blockquote>
<img src="/2024/12/09/LLVM%20with%20gold%20plugin/image-20241212115900779.png" alt="image-20241212115900779" style="zoom:50%;"> 
</blockquote>
<h2 id="使用LTO编译支持autotool的项目"><a href="#使用LTO编译支持autotool的项目" class="headerlink" title="使用LTO编译支持autotool的项目"></a>使用LTO编译支持autotool的项目</h2><blockquote>
<p>![image-20250104220948229](LLVM with gold plugin/image-20250104220948229.png) </p>
<p>默认这样好像就行了,把ar和nm改掉,LLVMgold.so无所谓,添加一下环境路径</p>
<p>![image-20250104223156966](LLVM with gold plugin/image-20250104223156966.png) </p>
</blockquote>
<p>Quickstart for using LTO with autotooled projects</p>
<p>Once your system <code>ld</code>, <code>ar</code>, and <code>nm</code> all support LLVM bitcode, everything is in place for an easy to use LTO build of autotooled projects:</p>
<ul>
<li><p>Follow the instructions <a target="_blank" rel="noopener" href="https://llvm.org/docs/GoldPlugin.html#lto-how-to-build">on how to build LLVMgold.so</a>.</p>
</li>
<li><p>Install the newly built binutils to <code>$PREFIX</code></p>
</li>
<li><p>Copy <code>Release/lib/LLVMgold.so</code> to <code>$PREFIX/lib/bfd-plugins/</code></p>
</li>
<li><p>Set environment variables (<code>$PREFIX</code> is where you installed clang and binutils):</p>
</li>
<li><p>Or you can just set your path:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;<span class="variable">$PREFIX</span>/bin:<span class="variable">$PATH</span>&quot;</span></span><br><span class="line"><span class="built_in">export</span> CC=<span class="string">&quot;clang -flto&quot;</span></span><br><span class="line"><span class="built_in">export</span> CXX=<span class="string">&quot;clang++ -flto&quot;</span></span><br><span class="line"><span class="built_in">export</span> RANLIB=/bin/<span class="literal">true</span></span><br></pre></td></tr></table></figure></li>
<li><p>Configure and build the project as usual:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">% ./configure &amp;&amp; make &amp;&amp; make check</span><br></pre></td></tr></table></figure></li>
</ul>
<p>The environment variable settings may work for non-autotooled projects too, but you may need to set the <code>LD</code> environment variable as well.</p>
<p><strong>更新path</strong></p>
<p>add newest binutils and newest LLVM to envirnoment variables.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vim ~/.bashrc</span><br><span class="line"><span class="comment"># use (ESC + a) to insert sentences to current file in vi/vim</span></span><br><span class="line"><span class="built_in">export</span> PATH=/path/to/binutils_install/bin:<span class="variable">$PATH</span> <span class="comment"># add this line to bashrc</span></span><br><span class="line"><span class="built_in">export</span> PATH=/path/to/llvm/build/bin:<span class="variable">$PATH</span>       <span class="comment"># add this line to bashrc</span></span><br><span class="line"><span class="built_in">export</span> CC=<span class="string">&quot;clang -flto&quot;</span></span><br><span class="line"><span class="built_in">export</span> CXX=<span class="string">&quot;clang++ -flto&quot;</span></span><br><span class="line"><span class="built_in">export</span> RANLIB=/bin/<span class="literal">true</span></span><br><span class="line"><span class="comment"># use (ESC + :wq) to quit vi/vim</span></span><br></pre></td></tr></table></figure>

<p>then type the command to shell</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></table></figure>

<p>to evaluate the envirnoment variables, reopen shell is also workful.</p>
<p>Backup ar, nm, ld and ranlib</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line">mkdir backup</span><br><span class="line"><span class="built_in">cd</span> /usr/bin/</span><br><span class="line">cp ar ~/backup/</span><br><span class="line">cp nm ~/backup/</span><br><span class="line">cp ld ~/backup/</span><br><span class="line">cp ranlib ~/backup/</span><br></pre></td></tr></table></figure>



<p>Replace ar, nm, ld and ranlib</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/bin/</span><br><span class="line">sudo cp ~/build/binutils/ar ./</span><br><span class="line">sudo rm nm</span><br><span class="line">sudo cp ~/build/binutils/nm-new ./nm</span><br><span class="line">sudo cp ~/build/binutils/ranlib ./</span><br><span class="line">sudo cp ~/build/gold/ld-new ./ld</span><br></pre></td></tr></table></figure>



<p>install LLVMgold.so to /usr/lib/bfd-plugins</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/lib</span><br><span class="line">sudo mkdir bfd-plugins</span><br><span class="line"><span class="built_in">cd</span> bfd-plugins</span><br><span class="line">sudo cp ~/llvm-6.0.0.obj/lib/LLVMgold.so ./</span><br><span class="line">sudo cp ~/llvm-6.0.0.obj/lib/libLTO.* ./</span><br></pre></td></tr></table></figure>



<p>export environment variables</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> CC=<span class="string">&quot;~/llvm-6.0.0.obj/bin/clang -flto -g&quot;</span></span><br><span class="line"><span class="built_in">export</span> CXX=<span class="string">&quot;~/llvm-6.0.0.obj/bin/clang++ -flto -g&quot;</span></span><br><span class="line"><span class="built_in">export</span> RANLIB=/bin/<span class="literal">true</span></span><br></pre></td></tr></table></figure>



<p>前置工具：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install make cmake gcc g++ git bash zip wget </span><br><span class="line"></span><br><span class="line">sudo apt install automake libtool</span><br><span class="line"></span><br><span class="line">sudo apt-get install apt-file texinfo texi2html</span><br><span class="line">sudo apt-file update</span><br><span class="line">sudo apt-file search makeinfo</span><br><span class="line"></span><br><span class="line">sudo apt install libz-dev libzstd-dev libncurses5-dev</span><br><span class="line"></span><br><span class="line">sudo apt install bison flex</span><br><span class="line"></span><br><span class="line"># ↓有文章提到了但没装</span><br><span class="line">sudo apt install ninja-build python2.7 binutils-gold binutils-dev linux-headers-$(uname -r) gawk </span><br></pre></td></tr></table></figure>

<ol>
<li><p>make 是一个自动化构建工具，通常用于编译程序。make 通过 Makefile 文件来控制构建流程。</p>
</li>
<li><p>cmake 是一个跨平台的构建工具，用于自动化生成 Makefile 文件，支持多种编译器和构建系统。它是大多数现代项目的构建系统。</p>
</li>
<li><p>gcc和g++ GCC 是 GNU 编译器集合（GNU Compiler Collection）的缩写，gcc 用于编译 C 语言程序，g++ 用于编译 C++ 程序。</p>
</li>
<li><p>git 是一个分布式版本控制系统，用于管理代码和项目的历史版本。它是现代软件开发中必不可少的工具。</p>
</li>
<li><p>bash 是一种常用的 shell，用于命令行交互。</p>
</li>
<li><p>zip和wget zip 用于压缩文件，wget 用于从网络上下载文件。</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/zhizhengguan/article/details/112008982">automake和libtool</a> 这两个工具帮助自动生成 Makefile 文件，通常用于大型的开源项目。libtool 用于处理跨平台的共享库构建。</p>
</li>
<li><p>apt-file: 是一个用来查询 Ubuntu 软件包内容的工具，可以让你查找某个文件属于哪个包。通过它，你可以找到缺失的文件并安装相应的软件包。</p>
<p>texinfo: 是用于生成和处理 Texinfo 格式文档的工具，包括 makeinfo。安装 texinfo 会提供 makeinfo 工具。</p>
<p>texi2html: 是一个将 Texinfo 文档转换为 HTML 格式的工具，可以与 makeinfo 一起使用。</p>
</li>
<li><p>libz-dev和libzstd-dev 这两个库分别是 zlib和Zstandard 的开发库，它们提供了数据压缩的功能。很多项目需要这些库来进行数据压缩和解压缩操作。</p>
</li>
<li><p>libncurses5-dev 这是 ncurses 库的开发版本，提供了终端界面管理的功能，如文本界面窗口、颜色、键盘输入等，常用于构建命令行界面应用。</p>
</li>
<li><p>bison和flex bison 是一个语法分析器生成工具，flex 是一个词法分析器生成工具。这些工具常用于编译器、解析器的开发。</p>
</li>
<li><p>ninja-build 是一个小而高效的构建系统，通常用于 CMake 生成的项目。比起 make，ninja 通常提供更高效的构建速度。</p>
</li>
<li><p>python2.7 安装 Python 2.7 版本，虽然 Python 3 已成为主流，但某些老旧项目仍依赖于 Python 2.7。</p>
</li>
<li><p>binutils-gold和binutils-dev binutils 是一组用于处理目标文件、可执行文件、汇编文件的工具，而 binutils-gold 是 binutils 的一种优化版链接器，速度较快。</p>
</li>
<li><p>linux-headers-$(uname -r) 这个包包含当前内核版本的头文件，常用于编译与内核相关的模块或程序。$(uname -r) 是一个命令替换，它会返回当前系统内核的版本号。例如，如果你的内核版本是 5.4.0-80-generic，命令将会变成 linux-headers-5.4.0-80-generic。这确保你安装的是与当前内核版本匹配的头文件。</p>
</li>
<li><p>gawk 是 awk 的 GNU 实现，awk 是一个强大的文本处理工具，用于模式扫描和处理任务。</p>
</li>
</ol>
<h2 id="LLVMCFI安装流程"><a href="#LLVMCFI安装流程" class="headerlink" title="LLVMCFI安装流程"></a>LLVMCFI安装流程</h2><p>preparation:</p>
<ul>
<li>gold-plugin</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install git libgmp-dev libmpfr-dev apt-file texinfo texi2html bison flex</span><br><span class="line">mkdir ~/Desktop/gold/ &amp;&amp; <span class="built_in">cd</span> ~/Desktop/gold/</span><br><span class="line">git <span class="built_in">clone</span> --depth 1 git://sourceware.org/git/binutils-gdb.git binutils</span><br><span class="line">mkdir build_binutils &amp;&amp; <span class="built_in">cd</span> build_binutils</span><br><span class="line">sudo mkdir /usr/<span class="built_in">local</span>/install_binutils</span><br><span class="line">../binutils/configure --enable-gold --enable-plugins --disable-werror --prefix=/usr/<span class="built_in">local</span>/install_binutils</span><br><span class="line">make all-gold</span><br><span class="line">sudo mv ./gold/ld-new /usr/bin/ld.gold</span><br><span class="line">make -j4</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<ul>
<li>gcc 5.x (5.0-5.5)</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">sudo bash -c <span class="string">&quot;echo &#x27;deb https://mirrors.aliyun.com/ubuntu/ xenial main&#x27; &gt;&gt; /etc/apt/sources.list&quot;</span></span><br><span class="line">sudo bash -c <span class="string">&quot;echo &#x27;deb-src https://mirrors.aliyun.com/ubuntu/ xenial main&#x27; &gt;&gt; /etc/apt/sources.list&quot;</span> </span><br><span class="line">sudo bash -c <span class="string">&quot;echo &#x27;deb https://mirrors.aliyun.com/ubuntu/ xenial universe&#x27; &gt;&gt; /etc/apt/sources.list&quot;</span> </span><br><span class="line">sudo bash -c <span class="string">&quot;echo &#x27;deb-src https://mirrors.aliyun.com/ubuntu/ xenial universe&#x27; &gt;&gt; /etc/apt/sources.list&quot;</span> </span><br><span class="line">sudo apt update</span><br><span class="line"><span class="comment"># PG error: https://mirrors.aliyun.com/ubuntu xenial InRelease: The following signatures couldn&#x27;t be verified because the public key is not available: No_PUBKEY 40976EAF437D05B5 N0_PUBKEY 3B4FE6ACC0B21F32</span></span><br><span class="line"><span class="comment"># 方法一:添加公钥</span></span><br><span class="line"><span class="comment"># sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 40976EAF437D05B5</span></span><br><span class="line"><span class="comment"># sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 3B4FE6ACC0B21F32</span></span><br><span class="line"><span class="comment"># 方法二:临时禁用验证,添加[trusted=yes]后sudo apt update</span></span><br><span class="line"><span class="comment"># deb [trusted=yes] https...</span></span><br><span class="line"><span class="comment"># 这样可能会导致ArduPilot的install_xxx.sh报错</span></span><br><span class="line">sudo apt install g++-5 gcc-5</span><br><span class="line">sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-5 50</span><br><span class="line">sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-5 50</span><br></pre></td></tr></table></figure>

<p>installation:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install cmake libxml2 libxml2-dev</span><br><span class="line"><span class="built_in">cd</span> ~/Desktop/</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/TeamVault/LLVM-CFI.git</span><br><span class="line"><span class="built_in">cd</span> LLVM-CFI/source_code/build/</span><br><span class="line">sudo mkdir /usr/<span class="built_in">local</span>/install_llvmcfi</span><br><span class="line"></span><br><span class="line"><span class="comment"># -------</span></span><br><span class="line"><span class="comment"># 切换到gcc5.x</span></span><br><span class="line">sudo update-alternatives --config gcc</span><br><span class="line">sudo update-alternatives --config g++</span><br><span class="line"><span class="comment"># -------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意替换binutils的路径</span></span><br><span class="line">cmake ../ -DLLVM_BINUTILS_INCDIR=~/Desktop/gold/binutils/include/ -DCMAKE_INSTALL_PREFIX=/usr/<span class="built_in">local</span>/install_llvmcfi</span><br><span class="line">make -j4</span><br><span class="line">sudo make install</span><br><span class="line">sudo update-alternatives --install /usr/bin/clang clang /usr/<span class="built_in">local</span>/install_llvmcfi/bin/clang 90</span><br><span class="line">sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/<span class="built_in">local</span>/install_llvmcfi/bin/clang++ 90</span><br><span class="line">sudo update-alternatives --install /usr/bin/llvm-config llvm-config /usr/<span class="built_in">local</span>/install_llvmcfi/bin/llvm-config 90</span><br><span class="line">sudo update-alternatives --install /usr/bin/ar ar /usr/<span class="built_in">local</span>/install_llvmcfi/bin/llvm-ar 90</span><br><span class="line">sudo update-alternatives --install /usr/bin/nm nm /usr/<span class="built_in">local</span>/install_llvmcfi/bin/llvm-nm 90</span><br><span class="line"></span><br><span class="line">vim ~/.bashrc</span><br><span class="line"><span class="comment"># -------</span></span><br><span class="line"><span class="built_in">export</span> PREFIX=<span class="string">&quot;/usr/local/install_llvmcfi&quot;</span></span><br><span class="line"><span class="built_in">export</span> CC=<span class="string">&quot;<span class="variable">$PREFIX</span>/bin/clang -flto -femit-vtbl-checks&quot;</span></span><br><span class="line"><span class="built_in">export</span> CXX=<span class="string">&quot;<span class="variable">$PREFIX</span>/bin/clang++ -flto -femit-vtbl-checks&quot;</span></span><br><span class="line"><span class="built_in">export</span> AR=<span class="string">&quot;<span class="variable">$PREFIX</span>/bin/llvm-ar&quot;</span></span><br><span class="line"><span class="built_in">export</span> NM=<span class="string">&quot;<span class="variable">$PREFIX</span>/bin/llvm-nm&quot;</span></span><br><span class="line"><span class="built_in">export</span> RANLIB=/bin/<span class="literal">true</span></span><br><span class="line"><span class="built_in">export</span> LDFLAGS=<span class="string">&quot;-fuse-ld=gold -Wl,-plugin-opt=sd-return&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> PREFIX=<span class="string">&quot;/usr/local/install_llvmcfi&quot;</span></span><br><span class="line"><span class="built_in">export</span> CC=<span class="string">&quot;<span class="variable">$PREFIX</span>/bin/clang&quot;</span></span><br><span class="line"><span class="built_in">export</span> CXX=<span class="string">&quot;<span class="variable">$PREFIX</span>/bin/clang++&quot;</span></span><br><span class="line"><span class="built_in">export</span> CFLAGS=<span class="string">&quot;-flto -femit-vtbl-checks&quot;</span></span><br><span class="line"><span class="built_in">export</span> CXXFLAGS=<span class="string">&quot;-flto -femit-vtbl-checks&quot;</span></span><br><span class="line"><span class="built_in">export</span> AR=<span class="string">&quot;<span class="variable">$PREFIX</span>/bin/llvm-ar&quot;</span></span><br><span class="line"><span class="built_in">export</span> NM=<span class="string">&quot;<span class="variable">$PREFIX</span>/bin/llvm-nm&quot;</span></span><br><span class="line"><span class="built_in">export</span> RANLIB=/bin/<span class="literal">true</span></span><br><span class="line"><span class="built_in">export</span> LDFLAGS=<span class="string">&quot;-fuse-ld=gold -Wl,-plugin-opt=sd-return&quot;</span></span><br><span class="line"><span class="comment"># -------</span></span><br><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></table></figure>



<hr>
<p>LLVM-CFI/source_code/include/llvm/IR/ValueMap.h:102:31: error: cannot convert ‘const std::unique_ptr&lt;llvm::DenseMap&lt;const llvm::Metadata*, llvm::TrackingMDRef&gt; &gt;’ to ‘bool’ in return</p>
<blockquote>
<p>![image-20241218134604735](LLVM with gold plugin/image-20241218134604735.png) </p>
</blockquote>
<hr>
<p>configure: error: Building GDB requires GMP 4.2+, and MPFR 3.1.0+.</p>
<blockquote>
<p>sudo apt install libgmp-dev libmpfr-dev</p>
<p>或者手动安装GMP,MPFR…</p>
</blockquote>
<hr>
<p>missing: OCAMLFIND OCAML_VERSION OCAML_STDLIB_PATH) </p>
<p>OCaml bindings disabled, need ctypes &gt;=0.3.</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/550727182">OCaml 环境的安装和运行 - 知乎</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install ocaml ocaml-findlib</span><br><span class="line">sudo apt-get install opam</span><br><span class="line"><span class="built_in">eval</span> $(opam env)</span><br><span class="line">opam --version</span><br><span class="line"><span class="built_in">which</span> ocaml</span><br><span class="line">opam install ocamlfind</span><br><span class="line"><span class="built_in">eval</span> $(opam env)</span><br><span class="line">opam install ctypes</span><br></pre></td></tr></table></figure>

<hr>
<p>Error: Could not find the .cmi file for interface</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install ocaml ocaml-findlib</span><br><span class="line">sudo apt-get install libllvm-dev</span><br></pre></td></tr></table></figure>

<hr>
<blockquote>
<img src="/2024/12/09/LLVM%20with%20gold%20plugin/image-20241218180844038.png" alt="image-20241218180844038" style="zoom:50%;"> 
</blockquote>
<hr>
<blockquote>
<p>![image-20241218181057661](LLVM with gold plugin/image-20241218181057661.png) </p>
</blockquote>
<h2 id="LLVMCFI测试"><a href="#LLVMCFI测试" class="headerlink" title="LLVMCFI测试"></a>LLVMCFI测试</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/thalo1204/article/details/49183911">Autotools使用教程_autotools教程-CSDN博客</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install autoconf automake libtool</span><br></pre></td></tr></table></figure>

<ol>
<li>建立两个文件夹include，src（include里面放置头文件，src中放置源文件）</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir include src</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>编写程序</li>
</ol>
<p>测试LLVM-CFI的cpp例子</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Hello from Base!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Derived</span> :</span> <span class="keyword">public</span> Base &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">hello</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Hello from Derived!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Base *basePtr = <span class="keyword">new</span> <span class="built_in">Derived</span>();</span><br><span class="line">    basePtr-&gt;<span class="built_in">hello</span>();</span><br><span class="line">    <span class="keyword">delete</span> basePtr;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>c的例子</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#vim <span class="meta-keyword">include</span>/pr.h</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pr</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;helloworld&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#vim src/hello.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> “pr.h”</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> x;</span><br><span class="line">    x=pr();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>autoscan 生成 configure.scan</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">autoscan</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//configure.scan文件内容（红色部分是注释和新增的 用于生成configure.ac）</span></span><br><span class="line"><span class="number">1.</span> # -- Autoconf --</span><br><span class="line"><span class="number">2.</span> # Process <span class="keyword">this</span> file with autoconf to produce a configure script.</span><br><span class="line"><span class="number">3.</span> AC_PREREQ([<span class="number">2.59</span>]) <span class="comment">//使用的autoconf版本号</span></span><br><span class="line"><span class="number">4.</span> AC_INIT([FULL-PACKAGE-NAME], [VERSION], [BUG-REPORT-ADDRESS]) <span class="comment">//FULL-PACKAGE-NAME</span></span><br><span class="line">为程序名称，VERSION为当前版本，BUG-REPORT-ADDRESS为bug汇报地址（一般写作者邮箱）</span><br><span class="line"><span class="number">5.</span> AM_INIT_AUTOMAKE([ir_tree],[<span class="number">1.0</span>]) <span class="comment">//指示可执行名称+版本号，用于生成makefile</span></span><br><span class="line"><span class="number">6.</span> AC_CONFIG_SRCDIR([src/hello.c]) <span class="comment">//用来侦测所指定的源码文件是否存在，你可以检测所有的文件，这里为了示意，检查一个</span></span><br><span class="line"><span class="number">7.</span> AC_CONFIG_HEADER([config.h]) <span class="comment">//检测头文件是否存在，用于生成config.h文件，以便autoheader 使用</span></span><br><span class="line"><span class="number">8.</span># Checks <span class="keyword">for</span> programs.</span><br><span class="line"><span class="number">9.</span> AC_PROG_CC <span class="comment">// # 检验gcc是否存在，如果你是要的C++，那么AC_PROG_CXX，所有你需要什么，到uanfang手册去查找就OK了！</span></span><br><span class="line"><span class="number">10.</span> # Checks <span class="keyword">for</span> libraries.</span><br><span class="line"><span class="number">11.</span>#AC_CHECK_LIB([m],[<span class="built_in">sqrt</span>])<span class="comment">//检查数学库-lm，这里我们没用其实AC_CHECK_LIB的完整格式是AC_CHECK_LIB([lib],[func],[if_exist_action], [not_exist_action])，后面的func是你使用到的函数名</span></span><br><span class="line"><span class="number">12.</span> #AC_PROG_RANLIB <span class="comment">//当你使用了静态库的时候，需要这一句；如果你使用了共享库，那么使用AC_PROG_LIBTOOL</span></span><br><span class="line"><span class="number">13.</span> # Checks <span class="keyword">for</span> header files.</span><br><span class="line"><span class="number">14.</span> # Checks <span class="keyword">for</span> typedefs, structures, <span class="keyword">and</span> compiler characteristics.</span><br><span class="line"><span class="number">15.</span> # Checks <span class="keyword">for</span> library functions.</span><br><span class="line"><span class="number">16.</span> AC_CONFIG_FILES([Makefile]) <span class="comment">//用于生成相应的Makefile 文件。</span></span><br><span class="line"><span class="number">17.</span> AC_OUTPUT</span><br></pre></td></tr></table></figure>

<p>添加两行，改名为configure.ac</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AM_INIT_AUTOMAKE([cpp_test],[1.0])</span><br><span class="line">AC_CONFIG_FILES([Makefile])</span><br></pre></td></tr></table></figure>

<img src="/2024/12/09/LLVM%20with%20gold%20plugin/image-20250109110431731.png" alt="image-20250109110431731" style="zoom:25%;"> 

<ol start="4">
<li>aclocal 由文件configure.ac生成aclocal.m4文件以及autom4te.cache文件夹</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aclocal</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>autoheader 由文件configure.ac 生成 config.h.in文件</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">autoheader</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>编写Makefile.am文件</li>
</ol>
<img src="/2024/12/09/LLVM%20with%20gold%20plugin/image-20250109111123935.png" alt="image-20250109111123935" style="zoom: 33%;"> 

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">AUTOMAKE_OPTIONS=foreign</span><br><span class="line">bin_PROGRAMS= main</span><br><span class="line">main_SOURCES= src/main.cpp</span><br><span class="line">main_CPPFLAGS = -I include/</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>automake / automake –add-missing 生成Makefile.in</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">automake --add-missing</span><br><span class="line">automake</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>autoconf 由configure.ac aclocal.m4生成configure</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">autoconf</span><br></pre></td></tr></table></figure>

<ol start="9">
<li>./configure 生成Makefile和config.h</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure</span><br></pre></td></tr></table></figure>

<ol start="10">
<li>make</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>![image-20250105001143889](LLVM with gold plugin/image-20250105001143889.png) </p>
</blockquote>
<h1 id="ArduPilot-4-1"><a href="#ArduPilot-4-1" class="headerlink" title="ArduPilot 4.1"></a>ArduPilot 4.1</h1><h2 id="最新版-clang10"><a href="#最新版-clang10" class="headerlink" title="最新版+clang10"></a>最新版+clang10</h2><ol>
<li>下载并安装前置环境</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install git llvm lld clang</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/ArduPilot/ardupilot.git</span><br><span class="line"><span class="built_in">cd</span> ardupilot</span><br><span class="line">git submodule update --init --recursive</span><br><span class="line"><span class="comment"># 如果提示submodule相关的报错，就加--force</span></span><br><span class="line">git submodule update --init --recursive --force</span><br><span class="line"><span class="comment">#git tag -l</span></span><br><span class="line"><span class="comment">#git checkout -b compile Copter-3.6.12</span></span><br><span class="line"><span class="comment">#chmod +x install-prereqs-ubuntu.sh</span></span><br><span class="line">./Tools/environment_install/install-prereqs-ubuntu.sh</span><br><span class="line"><span class="comment">#./Tools/scripts/install-prereqs-ubuntu.sh</span></span><br><span class="line"><span class="comment">#. ~/.profile</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改ardupilot文件夹下的wscript文件，在def configure(cfg)函数中添加如下代码：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加在以下代码下面</span></span><br><span class="line"><span class="comment"># cfg.env.CXXFLAGS += [&#x27;-include&#x27;, &#x27;ap_config.h&#x27;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># llvm ir</span></span><br><span class="line">    cfg.env.prepend_value(<span class="string">&#x27;CFLAGS&#x27;</span>, [<span class="string">&#x27;-flto&#x27;</span>])</span><br><span class="line">    cfg.env.prepend_value(<span class="string">&#x27;CFLAGS&#x27;</span>, [<span class="string">&#x27;-fno-discard-value-names&#x27;</span>,<span class="string">&#x27;-fembed-bitcode&#x27;</span>])</span><br><span class="line">    cfg.env.prepend_value(<span class="string">&#x27;CXXFLAGS&#x27;</span>, [<span class="string">&#x27;-flto&#x27;</span>])</span><br><span class="line">    cfg.env.prepend_value(<span class="string">&#x27;CXXFLAGS&#x27;</span>, [<span class="string">&#x27;-fno-discard-value-names&#x27;</span>,<span class="string">&#x27;-fembed-bitcode&#x27;</span>,<span class="string">&#x27;-fwhole-program-vtables&#x27;</span>])</span><br><span class="line">    cfg.env.prepend_value(<span class="string">&#x27;LINKFLAGS&#x27;</span>,<span class="string">&#x27;-flto&#x27;</span>)</span><br><span class="line">    cfg.env.prepend_value(<span class="string">&#x27;LINKFLAGS&#x27;</span>,<span class="string">&#x27;-fuse-ld=ld.lld&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>输入以下命令开始编译(/usr/bin为llvm 的路径的绝对路径)：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CC=/usr/bin/clang CXX=/usr/bin/clang++  LDFLAGS=<span class="string">&quot;-fuse-ld=/usr/bin/ld.lld&quot;</span> ./waf configure --board=sitl </span><br><span class="line"><span class="comment">#CC=$CC CXX=$CXX LDFLAGS=$LDFLAGS ./waf configure --board=sitl</span></span><br><span class="line">./waf copter</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>链接*.o和*.a为IR：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> build/sitl/</span><br><span class="line"><span class="comment"># /usr/bin替换为你的路径</span></span><br><span class="line">/usr/bin/llvm-ar -s lib/libArduCopter_libs.a</span><br><span class="line"></span><br><span class="line">/usr/bin/clang++ -Wl,--export-dynamic -fuse-ld=lld -flto -Wl,--plugin-opt=emit-llvm -Wl,--lto-whole-program-visibility ArduCopter/*.o -Llib -lArduCopter_libs -o arducopter.bc</span><br><span class="line"></span><br><span class="line">/usr/bin/llvm-dis arducopter.bc</span><br></pre></td></tr></table></figure>

<h2 id="Copter-4-4-LLVMCFI"><a href="#Copter-4-4-LLVMCFI" class="headerlink" title="Copter-4.4 + LLVMCFI"></a>Copter-4.4 + LLVMCFI</h2><hr>
<p>../../libraries/AP_CheckFirmware/AP_CheckFirmware.cpp:213:24: fatal error: default initialization of an object of const type ‘const app_descriptor_t’ (aka ‘const app_descriptor_unsigned’) without a user-provided default constructor const app_descriptor_t app_descriptor;</p>
<p>这个错误信息表明，在尝试初始化 <code>const app_descriptor_t</code> 类型的 <code>app_descriptor</code> 对象时，编译器遇到了问题。具体来说，<code>const app_descriptor_t</code> 类型的对象没有提供默认构造函数，因此不能进行默认初始化。</p>
<blockquote>
<p>如果你必须使用 <code>const</code> 类型的 <code>app_descriptor_unsigned</code>，确保对象在声明时显式初始化,这种方法不依赖于构造函数，而是在声明时直接使用大括号初始化所有成员，包括数组和其他成员变量。</p>
<img src="/2024/12/09/LLVM%20with%20gold%20plugin/image-20250115215148514.png" alt="image-20250115215148514" style="zoom:50%;"> 
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &#123;AP_APP_DESCRIPTOR_SIGNATURE_UNSIGNED&#125;,  <span class="comment">// 初始化数组</span></span><br><span class="line">    <span class="number">0</span>,  <span class="comment">// image_crc1</span></span><br><span class="line">    <span class="number">0</span>,  <span class="comment">// image_crc2</span></span><br><span class="line">    <span class="number">0</span>,  <span class="comment">// image_size</span></span><br><span class="line">    <span class="number">0</span>,  <span class="comment">// git_hash</span></span><br><span class="line">    APP_FW_MAJOR,  <span class="comment">// version_major</span></span><br><span class="line">    APP_FW_MINOR,  <span class="comment">// version_minor</span></span><br><span class="line">    APJ_BOARD_ID,  <span class="comment">// board_id</span></span><br><span class="line">    &#123;<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>&#125;  <span class="comment">// reserved</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h2 id="Copter-4-1-LLVMCFI"><a href="#Copter-4-1-LLVMCFI" class="headerlink" title="Copter-4.1 + LLVMCFI"></a>Copter-4.1 + LLVMCFI</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install git llvm lld clang</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/ArduPilot/ardupilot.git</span><br><span class="line"><span class="built_in">cd</span> ardupilot</span><br><span class="line">git checkout -b compile Copter-4.1</span><br><span class="line">git submodule update --init --recursive</span><br><span class="line">./Tools/environment_install/install-prereqs-ubuntu.sh</span><br><span class="line"></span><br><span class="line">./waf clean</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> PREFIX=<span class="string">&quot;/usr/local/install_llvmcfi&quot;</span></span><br><span class="line"><span class="built_in">export</span> CC=<span class="string">&quot;<span class="variable">$PREFIX</span>/bin/clang -flto -femit-vtbl-checks&quot;</span></span><br><span class="line"><span class="built_in">export</span> CXX=<span class="string">&quot;<span class="variable">$PREFIX</span>/bin/clang++ -flto -femit-vtbl-checks&quot;</span></span><br><span class="line"><span class="built_in">export</span> AR=<span class="string">&quot;<span class="variable">$PREFIX</span>/bin/llvm-ar&quot;</span></span><br><span class="line"><span class="built_in">export</span> NM=<span class="string">&quot;<span class="variable">$PREFIX</span>/bin/llvm-nm&quot;</span></span><br><span class="line"><span class="built_in">export</span> RANLIB=/bin/<span class="literal">true</span></span><br><span class="line"><span class="built_in">export</span> LDFLAGS=<span class="string">&quot;-fuse-ld=gold -Wl,-plugin-opt=sd-return&quot;</span></span><br><span class="line">CC=<span class="string">&quot;/usr/local/install_llvmcfi/bin/clang -flto -femit-vtbl-checks&quot;</span> CXX=<span class="string">&quot;/usr/local/install_llvmcfi/bin/clang++ -flto -femit-vtbl-checks&quot;</span> RANLIB=/bin/<span class="literal">true</span> LDFLAGS=<span class="string">&quot;-fuse-ld=gold -Wl,-plugin-opt=sd-return&quot;</span></span><br><span class="line"></span><br><span class="line">CC=<span class="string">&quot;/usr/bin/clang&quot;</span> CXX=<span class="string">&quot;/usr/bin/clang++&quot;</span> ./waf configure --board=sitl</span><br><span class="line"></span><br><span class="line">CC=<span class="string">&quot;/usr/bin/clang-10&quot;</span> CXX=<span class="string">&quot;/usr/bin/clang++-10&quot;</span> ./waf configure --board=sitl</span><br><span class="line"></span><br><span class="line">CC=<span class="variable">$CC</span> CXX=<span class="variable">$CXX</span> LDFLAGS=<span class="variable">$LDFLAGS</span> ./waf configure --board=sitl</span><br><span class="line"></span><br><span class="line">./waf copter -v</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cfg.env.CXXFLAGS.append(&#x27;-Wno-shadow&#x27;)</span><br><span class="line">cfg.env.CXXFLAGS.append(&#x27;-Wno-implicit-fallthrough&#x27;)</span><br><span class="line">cfg.env.CXXFLAGS.append(&#x27;-Wunused-private-field&#x27;)</span><br></pre></td></tr></table></figure>



<hr>
<p>../../libraries/AP_FETtecOneWire/AP_FETtecOneWire.h:284:79: fatal error: declaration shadows a field of ‘AP_FETtecOneWire’ [-Wshadow]<br>        SET_FAST_COM_LENGTH(uint8_t _byte_count, uint8_t _min_esc_id, uint8_t _esc_count) :</p>
<p>这个错误表明在 <code>AP_FETtecOneWire.h</code> 文件中，<code>SET_FAST_COM_LENGTH</code> 的某个声明中的参数（例如 <code>_byte_count</code>、<code>_min_esc_id</code> 或 <code>_esc_count</code>）的名字与类 <code>AP_FETtecOneWire</code> 的某个成员变量的名字相同，导致了命名冲突（即<strong>名称遮蔽</strong>问题）。</p>
<p>当启用了 <code>-Wshadow</code> 警告时，编译器会检测到这种情况并发出警告或错误。</p>
<p>如果你无法修改代码且不关心这个警告，可以禁用 <code>-Wshadow</code> 警告。修改你的编译命令，添加<code>-Wno-shadow</code>选项</p>
<p>使用waf调用编译器时，在 <code>wscript</code> 中找到编译器标志配置的位置，通常是在 <code>configure</code> 或 <code>build</code> 函数中，添加<code>-Wno-shadow</code>选项:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">def <span class="title">configure</span><span class="params">(cfg)</span>:</span></span><br><span class="line"><span class="function">    cfg.env.CXXFLAGS.append(<span class="string">&#x27;-Wno-shadow&#x27;</span>)</span></span><br></pre></td></tr></table></figure>

<hr>
<p>../../libraries/AP_Baro/AP_Baro_MS5611.cpp:101:5: fatal error: unannotated fall-through between switch labels [-Wimplicit-fallthrough]<br>    case BARO_MS5611:<br>    ^<br>../../libraries/AP_Baro/AP_Baro_MS5611.cpp:101:5: note: insert ‘[[clang::fallthrough]];’ to silence this warning<br>    case BARO_MS5611:<br>    ^<br>    [[clang::fallthrough]];<br>../../libraries/AP_Baro/AP_Baro_MS5611.cpp:101:5: note: insert ‘break;’ to avoid fall-through<br>    case BARO_MS5611:<br>    ^<br>    break;<br>3 warnings and 1 error generated.</p>
<p>你遇到的错误是由于没有显式的终止或标注，导致编译器认为存在<strong>潜在的 fall-through</strong>。这在 C++17 和之后的标准中，通常需要标注或处理，否则会生成警告或错误。</p>
<p>如果你不想处理这些警告，并且确信代码逻辑正确，也可以通过禁用此警告来解决问题。你可以在编译时禁用 <code>-Wimplicit-fallthrough</code> 警告：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#CXXFLAGS=&quot;-Wno-implicit-fallthrough&quot; ./waf configure</span></span><br><span class="line">cfg.env.CXXFLAGS.append(<span class="string">&#x27;-Wno-implicit-fallthrough&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>这会抑制类似警告，但这并不推荐作为长期解决方案，因为它可能掩盖潜在的逻辑错误。</p>
<hr>
<p>../../libraries/SITL/SIM_Scrimmage.h:82:17: warning: private field ‘frame_str’ is not used [-Wunused-private-field]</p>
<p>这个警告提示你代码中的一个<strong>私有成员变量</strong> <code>frame_str</code> 没有被使用，因此编译器认为它是<strong>无用的</strong>，并发出了警告 <code>-Wunused-private-field</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfg.env.CXXFLAGS.append(&#x27;-Wunused-private-field&#x27;)</span><br></pre></td></tr></table></figure>

<hr>
<p>../../libraries/SITL/SIM_Frame.h:35:5: fatal error: constructor for ‘SITL::Frame’ must explicitly initialize the const member ‘default_model’<br>    Frame(const char *_name,<br>    ^<br>../../libraries/SITL/SIM_Frame.h:130:7: note: ‘default_model’ declared here<br>    } default_model;<br>      ^<br>3 warnings and 1 error generated.</p>
<p>这个错误提示你在 <code>Frame</code> 类的构造函数中没有显式地初始化一个 <code>const</code> 成员变量 <code>default_model</code>。在 C++ 中，**<code>const</code> 成员变量**必须在类的构造函数初始化列表中显式地初始化，因为 <code>const</code> 变量的值一旦设定就不能再改变。</p>
<p>去源码发现，<code>default_model</code> 被声明为 <code>const struct Model</code>，这意味着它的值在对象创建后不能更改，但你没有在构造函数中为它提供一个初始化值。因此，编译器会报错提示你需要在构造函数中显式初始化 <code>default_model</code>。</p>
<blockquote>
<p>libraries/SITL/SIM_Frame.h 39</p>
<img src="/2024/12/09/LLVM%20with%20gold%20plugin/image-20250115000444556.png" alt="image-20250115000444556" style="zoom:50%;"> 
</blockquote>
<p>../../libraries/SITL/SIM_Blimp.cpp:26:8: fatal error: constructor for ‘SITL::Blimp’ must explicitly initialize the const member ‘model’<br>Blimp::Blimp(const char *frame_str) :<br>       ^<br>../../libraries/SITL/SIM_Blimp.h:46:7: note: ‘model’ declared here<br>    } model;<br>      ^<br>3 warnings and 1 error generated.</p>
<blockquote>
<p>libraries/SITL/SIM_Blimp.cpp:26</p>
<img src="/2024/12/09/LLVM%20with%20gold%20plugin/image-20250115003320848.png" alt="image-20250115003320848" style="zoom:50%;"> 
</blockquote>
<blockquote>
<p>libraries/SITL/SIM_Submarine.cpp:50</p>
<img src="/2024/12/09/LLVM%20with%20gold%20plugin/image-20250115004530942.png" alt="image-20250115004530942" style="zoom:50%;"> 
</blockquote>
<h2 id="Copter-3-6-12"><a href="#Copter-3-6-12" class="headerlink" title="Copter 3.6.12"></a>Copter 3.6.12</h2><p>这个版本主要是前置的python等会有依赖问题</p>
<h3 id="Ubuntu18-安装pynmeagps有问题"><a href="#Ubuntu18-安装pynmeagps有问题" class="headerlink" title="Ubuntu18 安装pynmeagps有问题"></a>Ubuntu18 安装pynmeagps有问题</h3><p>export PATH=/opt/gcc-arm-none-eabi-6-2017-q2-update/bin:$PATH</p>
<p>pynmeagps是python3的包</p>
<p>python3 -m pip install –upgrade pynmeagps</p>
<h3 id="Ubuntu20-安装python-2-7-1有问题"><a href="#Ubuntu20-安装python-2-7-1有问题" class="headerlink" title="Ubuntu20 安装python-2.7.1有问题"></a>Ubuntu20 安装python-2.7.1有问题</h3><hr>
<p>如果编译的时候显示g++：学长添加的东西报错了，是因为waf没有选择clang作为c++的编译器，需要指定CXX为clang（我指定不了，就卸载了gcc）</p>
<hr>
<p>执行 install-prereqs-ubuntu.sh 时报错</p>
<p>sudo pip2 -q install -U future lxml pymavlink MAVProxy<br>Could not find a version that satisfies the requirement pynmeagps (from MAVProxy) (from versions: )<br>No matching distribution found for pynmeagps (from MAVProxy)</p>
<hr>
<p>执行 install-prereqs-ubuntu.sh 时报错</p>
<p>Collecting pyserial<br>  Downloading pyserial-3.5-py2.py3-none-any.whl (90 kB)</p>
<p>packaging.version.InvalidVersion: Invalid version: ‘1.0.3.linux-x86_64’</p>
<p>解决：</p>
<blockquote>
<p>[<a target="_blank" rel="noopener" href="https://github.com/pypa/setuptools/issues/4511">BUG] string version check regression (1.0.3.linux-x86_64) · Issue #4511 · pypa/setuptools</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/ArduPilot/ardupilot/pull/27689/commits/ff714e819004ddd63fd3e642fd248a6bd4d57ebd">Tools: environment_install: fix focal install by peterbarker · Pull Request #27689 · ArduPilot/ardupilot</a></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-</span><br><span class="line"><span class="variable">$PIP</span> install <span class="variable">$PIP_USER_ARGUMENT</span> -U pip packaging setuptools wheel</span><br><span class="line"></span><br><span class="line">+</span><br><span class="line">SETUPTOOLS=<span class="string">&quot;setuptools&quot;</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$&#123;RELEASE_CODENAME&#125;</span> == <span class="string">&#x27;focal&#x27;</span> ]; <span class="keyword">then</span></span><br><span class="line">    SETUPTOOLS=setuptools==70.3.0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="variable">$PIP</span> install <span class="variable">$PIP_USER_ARGUMENT</span> -U pip packaging <span class="variable">$SETUPTOOLS</span> wheel</span><br></pre></td></tr></table></figure>

<hr>
<p>ARM交叉编译工具链出问题</p>
<p>sudo wget <a target="_blank" rel="noopener" href="http://firmware.ardupilot.org/Tools/PX4-tools/gcc-arm-none-eabi-4_9-2015q3-20150921-linux.tar.bz2">http://firmware.ardupilot.org/Tools/PX4-tools/gcc-arm-none-eabi-4_9-2015q3-20150921-linux.tar.bz2</a></p>
<p>ERROR 404: Not Found.</p>
<p>解决：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://firmware.ardupilot.org/Tools/PX4-tools/">ArduPilot firmware : /Tools/STM32-tools</a>没有gcc-arm-none-eabi-4_9-2015q3-20150921-linux.tar.bz2，更改install-prereqs-ubuntu.sh</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ARM_ROOT=<span class="string">&quot;gcc-arm-none-eabi-6&quot;</span></span><br><span class="line">ARM_TARBALL=<span class="string">&quot;<span class="variable">$ARM_ROOT</span>-2017-q2-update-linux.tar.bz2&quot;</span></span><br><span class="line">ARM_TARBALL_URL=<span class="string">&quot;http://firmware.ardupilot.org/Tools/PX4-tools/<span class="variable">$ARM_TARBALL</span>&quot;</span></span><br></pre></td></tr></table></figure>

<hr>
<p>编译时报错../../libraries/AP_InertialSensor/AP_InertialSensor_Invensensev3.cpp:169:37: error: expected ‘,’ before ‘)’ token static_assert(sizeof(FIFOData) == 16);</p>
<p>错误点是 <code>static_assert</code> 的语法不正确，编译器期望在某个位置找到 <code>,</code>，但没有找到。</p>
<p>虽然从 C++17 开始，第二个参数是可选的，但如果项目使用的是 C++11 或 C++14 标准，第二个参数是必需的。</p>
<p>解决：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-</span><br><span class="line">static_assert(sizeof(FIFOData) == 16);</span><br><span class="line">static_assert(sizeof(FIFODataHighRes) == 20);</span><br><span class="line">+</span><br><span class="line">static_assert(sizeof(FIFOData) == 16, &quot;FIFOData must be 16 bytes&quot;);</span><br><span class="line">static_assert(sizeof(FIFODataHighRes) == 20, &quot;FIFODataHighRes must be 20 bytes&quot;);</span><br></pre></td></tr></table></figure>

<hr>
<p>fatal error: static assertion failed due to requirement ‘sizeof (1.0E+6) == sizeof(float)’: Compilation needs to use single-precision constants</p>
<p>这个错误发生在你试图验证 <code>sizeof(1.0E+6)</code> 是否等于 <code>sizeof(float)</code>，但 <code>1.0E+6</code> 是一个默认的 <strong>双精度浮点常量</strong>（<code>double</code>），而不是 <strong>单精度浮点常量</strong>（<code>float</code>）。</p>
<p>解决：加一个f</p>
<p><strong>显式将常量转换为 <code>float</code> 类型</strong>： 在 C++ 中，可以通过将常量后面加上 <code>f</code> 来将常量指定为 <code>float</code> 类型，而不是 <code>double</code>。例如：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in"><span class="keyword">static_assert</span></span>(<span class="built_in"><span class="keyword">sizeof</span></span>(<span class="number">1.0E+6</span>f) == <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">float</span>), <span class="string">&quot;Compilation needs to use single-precision constants&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>这里，<code>1.0E+6f</code> 表示一个 <strong>单精度浮点常量</strong>，<code>sizeof(1.0E+6f)</code> 将返回 <code>sizeof(float)</code>，并且静态断言应该不会失败。</p>
<hr>
<p>fatal error: non-constant-expression cannot be narrowed from type ‘double’ to ‘float’ in initializer list [-Wc++11-narrowing]</p>
<p>这个错误是由于 <strong>C++11</strong> 中的 <strong>窄化转换（narrowing conversion）</strong> 规则引起的。具体来说，错误提示说：“<code>non-constant-expression cannot be narrowed from type &#39;double&#39; to &#39;float&#39; in initializer list</code>”，意思是在初始化列表中，你试图将一个 <code>double</code> 类型的值窄化（转换）成 <code>float</code> 类型，而这种转换是不允许的，尤其是在 C++11 标准及以后的版本中。</p>
<h1 id="BetaFlight-4-3-maintenance"><a href="#BetaFlight-4-3-maintenance" class="headerlink" title="BetaFlight 4.3-maintenance"></a>BetaFlight 4.3-maintenance</h1><blockquote>
<p>![image-20250116011507806](LLVM with gold plugin/image-20250116011507806.png)</p>
<p>![image-20250116012007394](LLVM with gold plugin/image-20250116012007394.png)</p>
<p>是crt1.o导致的问题，可以去掉crt1.o，把ld改成ld.gold，加一个sd-return</p>
<p>想要make一步实现编译,可以加一个-nostartfiles或-nostdlib,但这样sd-return会输出0   </p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/betaflight/betaflight.git</span><br><span class="line">cd betaflight</span><br><span class="line">git checkout 4.3-maintenance</span><br><span class="line">make arm_sdk_install</span><br><span class="line">make configs</span><br></pre></td></tr></table></figure>

<p>修改MakeFile</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 -Wall -Wextra -Werror -Wunsafe-loop-optimizations -Wdouble-promotion \ 为：</span></span><br><span class="line">-Wall -Wextra -Wunsafe-loop-optimizations -Wdouble-promotion \ </span><br><span class="line"><span class="comment"># 即删除 -Werror 选项</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 	$(V1) $(CROSS_CC) -o $@ $(filter-out %.ld,$^) $(LD_FLAGS)为：</span></span><br><span class="line">$(V1) $(CROSS_CC) -o <span class="variable">$@</span> $(filter-out %.ld,$^) $(LD_FLAGS) -v </span><br><span class="line"><span class="comment"># 即添加 -v便于打印详细的link过程</span></span><br><span class="line">-v -fuse-ld=gold -Wl,-plugin-opt=sd-return</span><br></pre></td></tr></table></figure>

<p>编译</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 其中 $CC 为clang 编译的完整路径 $CXX为clang++ 编译器的完整路径</span><br><span class="line">source setup.sh</span><br><span class="line">make TARGET=SITL CROSS_CC=$CC CROSS_CXX=$CXX</span><br></pre></td></tr></table></figure>

<p>ld变成ld.gold,去掉crt1,加一个-plugin-opt=sd-return</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;/usr/bin/ld.gold&quot; --eh-frame-hdr -m elf_x86_64 -dynamic-linker /lib64/ld-linux-x86-64.so.2 -o obj/main/betaflight_SITL.elf /usr/lib/gcc/x86_64-linux-gnu/5.3.1/../../../x86_64-linux-gnu/crti.o /usr/lib/gcc/x86_64-linux-gnu/5.3.1/crtbegin.o /usr/lib/gcc/x86_64-linux-gnu/5.3.1/crtfastmath.o -L/usr/lib/gcc/x86_64-linux-gnu/5.3.1 -L/usr/lib/gcc/x86_64-linux-gnu/5.3.1/../../../x86_64-linux-gnu -L/usr/lib/gcc/x86_64-linux-gnu/5.3.1/../../../../lib64 -L/lib/x86_64-linux-gnu -L/lib/../lib64 -L/usr/lib/x86_64-linux-gnu -L/usr/lib/../lib64 -L/usr/lib/x86_64-linux-gnu/../../lib64 -L/usr/lib/gcc/x86_64-linux-gnu/5.3.1/../../.. -L/usr/local/install_llvmcfi/bin/../lib -L/lib -L/usr/lib -plugin /usr/local/install_llvmcfi/bin/../lib/LLVMgold.so -plugin-opt=mcpu=x86-64 -plugin-opt=sd-return obj/main/SITL/./lib/main/dyad/dyad.o obj/main/SITL/drivers/accgyro/accgyro_fake.o obj/main/SITL/drivers/barometer/barometer_fake.o obj/main/SITL/drivers/compass/compass_fake.o obj/main/SITL/drivers/serial_tcp.o obj/main/SITL/build/build_config.o obj/main/SITL/build/debug.o obj/main/SITL/build/debug_pin.o obj/main/SITL/build/version.o obj/main/SITL/target.o obj/main/SITL/udplink.o obj/main/SITL/main.o obj/main/SITL/pg/motor.o obj/main/SITL/pg/rcdevice.o obj/main/SITL/pg/pin_pull_up_down.o obj/main/SITL/pg/bus_i2c.o obj/main/SITL/pg/bus_quadspi.o obj/main/SITL/pg/gyrodev.o obj/main/SITL/pg/pg.o obj/main/SITL/pg/dyn_notch.o obj/main/SITL/pg/pinio.o obj/main/SITL/pg/max7456.o obj/main/SITL/pg/usb.o obj/main/SITL/pg/rx.o obj/main/SITL/pg/rx_spi_cc2500.o obj/main/SITL/pg/scheduler.o obj/main/SITL/pg/adc.o obj/main/SITL/pg/dashboard.o obj/main/SITL/pg/displayport_profiles.o obj/main/SITL/pg/rx_spi.o obj/main/SITL/pg/timerup.o obj/main/SITL/pg/flash.o obj/main/SITL/pg/beeper_dev.o obj/main/SITL/pg/mco.o obj/main/SITL/pg/vtx_io.o obj/main/SITL/pg/rx_pwm.o obj/main/SITL/pg/beeper.o obj/main/SITL/pg/board.o obj/main/SITL/pg/bus_spi.o obj/main/SITL/pg/stats.o obj/main/SITL/pg/vcd.o obj/main/SITL/pg/rx_spi_expresslrs.o obj/main/SITL/pg/vtx_table.o obj/main/SITL/pg/sdcard.o obj/main/SITL/pg/piniobox.o obj/main/SITL/pg/timerio.o obj/main/SITL/pg/sdio.o obj/main/SITL/pg/serial_uart.o obj/main/SITL/common/maths.o obj/main/SITL/common/bitarray.o obj/main/SITL/common/printf.o obj/main/SITL/common/crc.o obj/main/SITL/common/uvarint.o obj/main/SITL/common/time.o obj/main/SITL/common/sdft.o obj/main/SITL/common/huffman.o obj/main/SITL/common/typeconversion.o obj/main/SITL/common/strtol.o obj/main/SITL/common/string_light.o obj/main/SITL/common/huffman_table.o obj/main/SITL/common/encoding.o obj/main/SITL/common/printf_serial.o obj/main/SITL/common/filter.o obj/main/SITL/common/sensor_alignment.o obj/main/SITL/common/explog_approx.o obj/main/SITL/common/gps_conversion.o obj/main/SITL/common/streambuf.o obj/main/SITL/common/colorconversion.o obj/main/SITL/config/config_eeprom.o obj/main/SITL/config/simplified_tuning.o obj/main/SITL/config/config.o obj/main/SITL/config/config_streamer.o obj/main/SITL/config/feature.o obj/main/SITL/cli/cli.o obj/main/SITL/cli/settings.o obj/main/SITL/drivers/dshot.o obj/main/SITL/drivers/dshot_dpwm.o obj/main/SITL/drivers/dshot_command.o obj/main/SITL/drivers/buf_writer.o obj/main/SITL/drivers/bus.o obj/main/SITL/drivers/bus_i2c_busdev.o obj/main/SITL/drivers/bus_i2c_soft.o obj/main/SITL/drivers/bus_quadspi.o obj/main/SITL/drivers/buttons.o obj/main/SITL/drivers/display.o obj/main/SITL/drivers/display_canvas.o obj/main/SITL/drivers/dma_common.o obj/main/SITL/drivers/dma_reqmap.o obj/main/SITL/drivers/exti.o obj/main/SITL/drivers/io.o obj/main/SITL/drivers/light_led.o obj/main/SITL/drivers/mco.o obj/main/SITL/drivers/motor.o obj/main/SITL/drivers/pinio.o obj/main/SITL/drivers/pin_pull_up_down.o obj/main/SITL/drivers/resource.o obj/main/SITL/drivers/serial.o obj/main/SITL/drivers/sound_beeper.o obj/main/SITL/drivers/stack_check.o obj/main/SITL/drivers/timer_common.o obj/main/SITL/drivers/transponder_ir_arcitimer.o obj/main/SITL/drivers/transponder_ir_ilap.o obj/main/SITL/drivers/transponder_ir_erlt.o obj/main/SITL/fc/board_info.o obj/main/SITL/fc/dispatch.o obj/main/SITL/fc/hardfaults.o obj/main/SITL/fc/tasks.o obj/main/SITL/fc/runtime_config.o obj/main/SITL/fc/stats.o obj/main/SITL/io/beeper.o obj/main/SITL/io/piniobox.o obj/main/SITL/io/serial.o obj/main/SITL/io/smartaudio_protocol.o obj/main/SITL/io/statusindicator.o obj/main/SITL/io/tramp_protocol.o obj/main/SITL/io/transponder_ir.o obj/main/SITL/io/usb_cdc_hid.o obj/main/SITL/io/usb_msc.o obj/main/SITL/msp/msp.o obj/main/SITL/msp/msp_box.o obj/main/SITL/msp/msp_serial.o obj/main/SITL/scheduler/scheduler.o obj/main/SITL/sensors/adcinternal.o obj/main/SITL/sensors/battery.o obj/main/SITL/sensors/current.o obj/main/SITL/sensors/voltage.o obj/main/SITL/target/config_helper.o obj/main/SITL/fc/init.o obj/main/SITL/fc/controlrate_profile.o obj/main/SITL/drivers/camera_control.o obj/main/SITL/drivers/accgyro/gyro_sync.o obj/main/SITL/drivers/pwm_esc_detect.o obj/main/SITL/drivers/rx/rx_spi.o obj/main/SITL/drivers/rx/rx_pwm.o obj/main/SITL/drivers/serial_softserial.o obj/main/SITL/fc/core.o obj/main/SITL/fc/rc.o obj/main/SITL/fc/rc_adjustments.o obj/main/SITL/fc/rc_controls.o obj/main/SITL/fc/rc_modes.o obj/main/SITL/flight/position.o obj/main/SITL/flight/failsafe.o obj/main/SITL/flight/gps_rescue.o obj/main/SITL/flight/dyn_notch_filter.o obj/main/SITL/flight/imu.o obj/main/SITL/flight/feedforward.o obj/main/SITL/flight/mixer.o obj/main/SITL/flight/mixer_init.o obj/main/SITL/flight/mixer_tricopter.o obj/main/SITL/flight/pid.o obj/main/SITL/flight/pid_init.o obj/main/SITL/flight/rpm_filter.o obj/main/SITL/flight/servos.o obj/main/SITL/flight/servos_tricopter.o obj/main/SITL/io/serial_4way.o obj/main/SITL/io/serial_4way_avrootloader.o obj/main/SITL/io/serial_4way_stk500v2.o obj/main/SITL/rx/ibus.o obj/main/SITL/rx/jetiexbus.o obj/main/SITL/rx/msp.o obj/main/SITL/rx/pwm.o obj/main/SITL/rx/frsky_crc.o obj/main/SITL/rx/rx.o obj/main/SITL/rx/rx_bind.o obj/main/SITL/rx/rx_spi.o obj/main/SITL/rx/rx_spi_common.o obj/main/SITL/rx/crsf.o obj/main/SITL/rx/ghst.o obj/main/SITL/rx/sbus.o obj/main/SITL/rx/sbus_channels.o obj/main/SITL/rx/spektrum.o obj/main/SITL/rx/srxl2.o obj/main/SITL/io/spektrum_vtx_control.o obj/main/SITL/io/spektrum_rssi.o obj/main/SITL/rx/sumd.o obj/main/SITL/rx/sumh.o obj/main/SITL/rx/xbus.o obj/main/SITL/rx/fport.o obj/main/SITL/rx/msp_override.o obj/main/SITL/sensors/acceleration.o obj/main/SITL/sensors/acceleration_init.o obj/main/SITL/sensors/boardalignment.o obj/main/SITL/sensors/compass.o obj/main/SITL/sensors/gyro.o obj/main/SITL/sensors/gyro_init.o obj/main/SITL/sensors/initialisation.o obj/main/SITL/blackbox/blackbox.o obj/main/SITL/blackbox/blackbox_encoding.o obj/main/SITL/blackbox/blackbox_io.o obj/main/SITL/cms/cms.o obj/main/SITL/cms/cms_menu_blackbox.o obj/main/SITL/cms/cms_menu_failsafe.o obj/main/SITL/cms/cms_menu_firmware.o obj/main/SITL/cms/cms_menu_gps_rescue.o obj/main/SITL/cms/cms_menu_imu.o obj/main/SITL/cms/cms_menu_ledstrip.o obj/main/SITL/cms/cms_menu_main.o obj/main/SITL/cms/cms_menu_misc.o obj/main/SITL/cms/cms_menu_osd.o obj/main/SITL/cms/cms_menu_power.o obj/main/SITL/cms/cms_menu_saveexit.o obj/main/SITL/cms/cms_menu_vtx_common.o obj/main/SITL/cms/cms_menu_vtx_rtc6705.o obj/main/SITL/cms/cms_menu_vtx_smartaudio.o obj/main/SITL/cms/cms_menu_vtx_tramp.o obj/main/SITL/cms/cms_menu_persistent_stats.o obj/main/SITL/drivers/light_ws2811strip.o obj/main/SITL/drivers/rangefinder/rangefinder_hcsr04.o obj/main/SITL/drivers/rangefinder/rangefinder_lidartf.o obj/main/SITL/drivers/vtx_common.o obj/main/SITL/drivers/vtx_table.o obj/main/SITL/io/dashboard.o obj/main/SITL/io/displayport_frsky_osd.o obj/main/SITL/io/displayport_max7456.o obj/main/SITL/io/displayport_msp.o obj/main/SITL/io/displayport_srxl.o obj/main/SITL/io/displayport_crsf.o obj/main/SITL/io/displayport_hott.o obj/main/SITL/io/frsky_osd.o obj/main/SITL/io/rcdevice_cam.o obj/main/SITL/io/rcdevice.o obj/main/SITL/io/gps.o obj/main/SITL/io/ledstrip.o obj/main/SITL/io/pidaudio.o obj/main/SITL/osd/osd.o obj/main/SITL/osd/osd_elements.o obj/main/SITL/osd/osd_warnings.o obj/main/SITL/sensors/barometer.o obj/main/SITL/sensors/rangefinder.o obj/main/SITL/telemetry/telemetry.o obj/main/SITL/telemetry/frsky_hub.o obj/main/SITL/telemetry/hott.o obj/main/SITL/telemetry/jetiexbus.o obj/main/SITL/telemetry/smartport.o obj/main/SITL/telemetry/ltm.o obj/main/SITL/telemetry/mavlink.o obj/main/SITL/telemetry/msp_shared.o obj/main/SITL/telemetry/ibus.o obj/main/SITL/telemetry/ibus_shared.o obj/main/SITL/sensors/esc_sensor.o obj/main/SITL/io/vtx.o obj/main/SITL/io/vtx_rtc6705.o obj/main/SITL/io/vtx_smartaudio.o obj/main/SITL/io/vtx_tramp.o obj/main/SITL/io/vtx_control.o obj/main/SITL/./lib/main/google/olc/olc.o -lm -lpthread -lc -lrt -gc-sections -Map ./obj/main/betaflight_SITL.map -L./src/link --cref -lgcc --as-needed -lgcc_s --no-as-needed -lc -lgcc --as-needed -lgcc_s --no-as-needed /usr/lib/gcc/x86_64-linux-gnu/5.3.1/crtend.o /usr/lib/gcc/x86_64-linux-gnu/5.3.1/../../../x86_64-linux-gnu/crtn.o</span><br></pre></td></tr></table></figure>



<h1 id="MatrixPilot"><a href="#MatrixPilot" class="headerlink" title="MatrixPilot"></a>MatrixPilot</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/MatrixPilot/MatrixPilot.git</span><br><span class="line">cd MatrixPilot</span><br></pre></td></tr></table></figure>

<p>修改MakeFile</p>
<blockquote>
<p>CPP := g++ 改为 CPP := clang++</p>
<img src="/2024/12/09/LLVM%20with%20gold%20plugin/image-20250115233708332.png" alt="image-20250115233708332" style="zoom:50%;"> 

</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/clang++ -fuse-ld=lld -flto -Wl,--plugin-opt=emit-llvm -Wl,--lto-whole-program-visibility -o MPSIM-SIL-Cessna.bc MatrixPilot/airspeedCntrl.o MatrixPilot/altitudeCntrl.o MatrixPilot/altitudeCntrlVariable.o MatrixPilot/behavior.o MatrixPilot/cameraCntrl.o MatrixPilot/config.o MatrixPilot/config_tests.o MatrixPilot/console.o MatrixPilot/data_services.o MatrixPilot/data_storage.o MatrixPilot/euler_angles.o MatrixPilot/flightplan.o MatrixPilot/flightplan-logo.o MatrixPilot/flightplan-waypoints.o MatrixPilot/flight_state.o MatrixPilot/fly_by_datalink.o MatrixPilot/helicalTurnCntrl.o MatrixPilot/main.o MatrixPilot/MAVFlexiFunctions.o MatrixPilot/MAVLink.o MatrixPilot/MAVMission.o MatrixPilot/MAVParams.o MatrixPilot/MAVUDBExtra.o MatrixPilot/minim_osd.o MatrixPilot/minIni.o MatrixPilot/mode_switch.o MatrixPilot/mp_osd.o MatrixPilot/navigate.o MatrixPilot/nv_memory_table.o MatrixPilot/parameter_table2.o MatrixPilot/parameter_table.o MatrixPilot/parameter_table_init.o MatrixPilot/pitchCntrl.o MatrixPilot/preflight.o MatrixPilot/redef.o MatrixPilot/remzibi_osd.o MatrixPilot/ring_buffer.o MatrixPilot/rollCntrl.o MatrixPilot/servoMix.o MatrixPilot/servoPrepare.o MatrixPilot/sonarCntrl.o MatrixPilot/states.o MatrixPilot/telemetry.o MatrixPilot/telemetry_log.o MatrixPilot/yawCntrl.o libDCM/deadReckoning.o libDCM/estAirspeed.o libDCM/estAltitude.o libDCM/estLocation.o libDCM/estWind.o libDCM/estYawDrift.o libDCM/gpsData.o libDCM/gpsParseCommon.o libDCM/gpsParseMTEK.o libDCM/gpsParseNMEA.o libDCM/gpsParseSTD.o libDCM/gpsParseUBX.o libDCM/hilsim.o libDCM/libDCM.o libDCM/mag_drift.o libDCM/mathlib.o libDCM/mathlibNAV.o libDCM/rmat.o Tools/MatrixPilot-SIL/flt2frct.o Tools/MatrixPilot-SIL/frct2flt.o Tools/MatrixPilot-SIL/SIL-24LC256.o Tools/MatrixPilot-SIL/SIL-dsp.o Tools/MatrixPilot-SIL/SIL-eeprom.o Tools/MatrixPilot-SIL/SIL-events.o Tools/MatrixPilot-SIL/SIL-filesys.o Tools/MatrixPilot-SIL/SIL-filesystem.o Tools/MatrixPilot-SIL/SIL-I2C1.o Tools/MatrixPilot-SIL/SIL-serial.o Tools/MatrixPilot-SIL/SIL-udb.o Tools/MatrixPilot-SIL/SIL-ui-mp-term.o Tools/MatrixPilot-SIL/UDBSocketUnix.o Tools/MatrixPilot-SIL/UDBSocketWin.o MAVLink/MAVLink.a</span><br></pre></td></tr></table></figure>



<h1 id="paparazzi"><a href="#paparazzi" class="headerlink" title="paparazzi"></a>paparazzi</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/paparazzi/paparazzi.git</span><br></pre></td></tr></table></figure>

<h1 id="PX4"><a href="#PX4" class="headerlink" title="PX4"></a>PX4</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/PX4/PX4-Autopilot.git</span><br><span class="line"><span class="built_in">cd</span> PX4-Autopilot/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1.新建[px4_root_dir]/set_compiler.sh文件：</span><br><span class="line"><span class="built_in">export</span> PREFIX=<span class="string">&quot;/home/lqs66/Desktop/modelCheckingFlightControl/dependencies/llvm-16.0.4/arm_build&quot;</span> <span class="comment"># 替换为自己的路径</span></span><br><span class="line"><span class="built_in">export</span> CC=<span class="string">&quot;<span class="variable">$PREFIX</span>/bin/clang&quot;</span></span><br><span class="line"><span class="built_in">export</span> CFLAGS=<span class="string">&quot;-flto -fno-discard-value-names -fembed-bitcode&quot;</span></span><br><span class="line"><span class="built_in">export</span> CXX=<span class="string">&quot;<span class="variable">$PREFIX</span>/bin/clang++ -v&quot;</span> <span class="comment"># 这个 -v 是为了获取link过程，便于后续生成IR</span></span><br><span class="line"><span class="built_in">export</span> CXXFLAGS=<span class="string">&quot;-flto -fno-discard-value-names -fembed-bitcode -fwhole-program-vtables&quot;</span></span><br><span class="line"><span class="built_in">export</span> AR=<span class="string">&quot;<span class="variable">$PREFIX</span>/bin/llvm-ar&quot;</span></span><br><span class="line"><span class="built_in">export</span> LD=<span class="string">&quot;<span class="variable">$PREFIX</span>/bin/lld&quot;</span></span><br><span class="line"><span class="built_in">export</span> NM=<span class="string">&quot;<span class="variable">$PREFIX</span>/bin/nm&quot;</span></span><br><span class="line"><span class="built_in">export</span> RANLIB=<span class="string">&quot;<span class="variable">$PREFIX</span>/bin/llvm-ranlib&quot;</span></span><br><span class="line"><span class="built_in">export</span> LDFLAGS=<span class="string">&quot;-fuse-ld=lld -flto&quot;</span></span><br><span class="line"></span><br><span class="line">2.修改[px4_root_dir]/CMakeLists.txt文件：</span><br><span class="line">project(px4 CXX C ASM)</span><br><span class="line"><span class="comment"># 在以上代码下一行添加下列代码</span></span><br><span class="line"><span class="built_in">set</span> (CMAKE_BUILD_TYPE <span class="string">&quot;Debug&quot;</span> CACHE STRING <span class="string">&quot;Choose the type of build.&quot;</span> FORCE)</span><br><span class="line">  </span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line"><span class="comment"># gold linker - use if available (posix only for now)</span></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$&#123;PX4_PLATFORM&#125;</span> STREQUAL <span class="string">&quot;posix&quot;</span>)</span><br><span class="line">  include(CMakeDependentOption)</span><br><span class="line">  CMAKE_DEPENDENT_OPTION(USE_LD_GOLD</span><br><span class="line">      <span class="string">&quot;Use GNU gold linker&quot;</span> ON</span><br><span class="line">      <span class="string">&quot;NOT WIN32;NOT APPLE&quot;</span> OFF</span><br><span class="line">  )</span><br><span class="line"><span class="comment"># 在以上代码下一行添加下列代码，不使用gold链接器</span></span><br><span class="line"><span class="built_in">set</span>(USE_LD_GOLD OFF)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3.在[px4_root_dir]/cmake/px4_add_common_flags.cmake：</span><br><span class="line"><span class="comment"># 注释-Werror</span></span><br><span class="line"><span class="comment"># -Werror</span></span><br><span class="line"></span><br><span class="line">4.修改[px4_root_dir]/platforms/common/px4_work_queue/WorkQueueManager.cpp：</span><br><span class="line"><span class="comment"># 修改以下代码。这里是一个bug，clang-15编译器认为模板的传入必须一致，PTHREAD_STACK_MIN是long类型而PX4_STACK_ADJUSTED(wq-&gt;stacksize)是int型，因此编译无法通过</span></span><br><span class="line">const size_t stacksize = math::max(PTHREAD_STACK_MIN, PX4_STACK_ADJUSTED(wq-&gt;stacksize));const size_t stacksize = math::max((int)PTHREAD_STACK_MIN, PX4_STACK_ADJUSTED(wq-&gt;stacksize));</span><br><span class="line"></span><br><span class="line">5.编译：</span><br><span class="line"><span class="built_in">source</span> set_compiler.sh</span><br><span class="line">make px4_sitl</span><br><span class="line"></span><br><span class="line">6.获得IR：</span><br><span class="line">[path]/clang++ -Wl,--export-dynamic -fuse-ld=lld -flto -Wl,--plugin-opt=emit-llvm -Wl,--lto-whole-program-visibility $(find ./platforms/posix/CMakeFiles/px4.dir/ -<span class="built_in">type</span> f -name <span class="string">&quot;*.o&quot;</span>)  -o px4.bc  $(find ./ -<span class="built_in">type</span> f -name <span class="string">&quot;*.a&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pip3 install kconfiglib</span><br><span class="line">pip3 install --user pyros-genmsg</span><br><span class="line">pip3 install --user jsonschema</span><br><span class="line"></span><br><span class="line">/usr/bin/clang++ -Wl,--export-dynamic -fuse-ld=lld -flto -Wl,--plugin-opt=emit-llvm -Wl,--lto-whole-program-visibility $(find ./platforms/posix/CMakeFiles/px4.dir/ -type f -name &quot;*.o&quot;)  -o px4.bc  $(find ./ -type f -name &quot;*.a&quot;)</span><br></pre></td></tr></table></figure>





<h1 id="HPCFI"><a href="#HPCFI" class="headerlink" title="HPCFI"></a>HPCFI</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install cmake</span><br><span class="line">sudo apt install ninja-build</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/Fraunhofer-AISEC/hpcfi.git</span><br><span class="line"><span class="built_in">cd</span> hpcfi</span><br><span class="line"><span class="comment"># build.sh里有git clone，可以把git@github.com:换成https://github.com/</span></span><br><span class="line">./build.sh</span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line"><span class="comment">#git clone git@github.com:Fraunhofer-AISEC/hpcfi-svf.git</span></span><br><span class="line"><span class="comment">#git clone git@github.com:Fraunhofer-AISEC/hpcfi-llvm-project.git</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/Fraunhofer-AISEC/hpcfi-svf.git</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/Fraunhofer-AISEC/hpcfi-llvm-project.git</span><br><span class="line"></span><br><span class="line">MY_PATH=<span class="string">&quot;<span class="subst">$(cd <span class="string">&quot;<span class="subst">$(dirname <span class="string">&quot;<span class="variable">$0</span>&quot;</span>)</span>&quot;</span> ; pwd -P)</span>&quot;</span></span><br><span class="line">SVF_SRC_DIR=<span class="variable">$MY_PATH</span>/hpcfi-svf</span><br><span class="line">LLVM_BUILD_DIR=<span class="variable">$MY_PATH</span>/hpcfi-llvm-project/build</span><br><span class="line">LLVM_SRC_DIR=<span class="variable">$MY_PATH</span>/hpcfi-llvm-project/llvm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># build llvm without hpcfi</span></span><br><span class="line">mkdir <span class="variable">$LLVM_BUILD_DIR</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$LLVM_BUILD_DIR</span></span><br><span class="line">LLVM_CMAKE_OPTIONS=<span class="string">&quot;\</span></span><br><span class="line"><span class="string">  -DCMAKE_BUILD_TYPE=Release \</span></span><br><span class="line"><span class="string">  -DLLVM_ENABLE_PROJECTS=clang;lld&quot;</span></span><br><span class="line">cmake -G Ninja <span class="variable">$LLVM_SRC_DIR</span> <span class="variable">$LLVM_CMAKE_OPTIONS</span></span><br><span class="line">ninja</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># build svf</span></span><br><span class="line"><span class="built_in">export</span> LLVM_DIR=<span class="variable">$LLVM_BUILD_DIR</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$LLVM_BUILD_DIR</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"><span class="built_in">export</span> Z3_DIR=<span class="variable">$SVF_SRC_DIR</span>/z3.obj</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$SVF_SRC_DIR</span> &amp;&amp; ./build.sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># build hpcfi pass</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$LLVM_BUILD_DIR</span></span><br><span class="line">LLVM_CMAKE_OPTIONS+=<span class="string">&quot; -DBUILD_HPCFI=ON&quot;</span></span><br><span class="line">cmake -G Ninja <span class="variable">$LLVM_SRC_DIR</span> <span class="variable">$LLVM_CMAKE_OPTIONS</span></span><br><span class="line">ninja</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line"></span><br><span class="line">struct S &#123;</span><br><span class="line">    void (*f)(void);</span><br><span class="line">    void (*g)(void);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">void A() &#123;</span><br><span class="line">    puts(&quot;A&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void B() &#123;</span><br><span class="line">    puts(&quot;B&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void C(struct S *s) &#123;</span><br><span class="line">    s-&gt;f();</span><br><span class="line">    s-&gt;g();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">    struct S s = &#123;A, B&#125;;</span><br><span class="line">    C(&amp;s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">*********CallGraph Stats***************</span><br><span class="line">################ (program : ld-temp.o)###############</span><br><span class="line">-------------------------------------------------------</span><br><span class="line">CalRetPairInCycle   0</span><br><span class="line">TotalEdge           9</span><br><span class="line">MaxNodeInCycle      0</span><br><span class="line">NodeInCycle         0</span><br><span class="line">TotalCycle          0</span><br><span class="line">TotalNode           12</span><br><span class="line">#######################################################</span><br><span class="line"></span><br><span class="line">*********General Stats***************</span><br><span class="line">################ (program : ld-temp.o)###############</span><br><span class="line">BBWith3Succ         0</span><br><span class="line">AddrsNum            20</span><br><span class="line">TotalFieldObjects   2</span><br><span class="line">LocalVarInRecur     0</span><br><span class="line">FSObjNum            15</span><br><span class="line">TotalPTASVFStmts    38</span><br><span class="line">GepsNum             10</span><br><span class="line">FIObjNum            0</span><br><span class="line">LoadsNum            4</span><br><span class="line">MaxStructSize       2</span><br><span class="line">TotalCallSite       9</span><br><span class="line">TotalSVFStmts       44</span><br><span class="line">TotalPointers       64</span><br><span class="line">ReturnsNum          0</span><br><span class="line">VarArrayObj         0</span><br><span class="line">CopysNum            4</span><br><span class="line">ConstArrayObj       0</span><br><span class="line">CallsNum            1</span><br><span class="line">TotalObjects        16</span><br><span class="line">FunctionObjs        12</span><br><span class="line">GlobalObjs          1</span><br><span class="line">HeapObjs            0</span><br><span class="line">StackObjs           1</span><br><span class="line">ConstStructObj      1</span><br><span class="line">VarStructObj        1</span><br><span class="line">NonPtrObj           13</span><br><span class="line">ConstantObj         0</span><br><span class="line">IndCallSites        2</span><br><span class="line">StoresNum           4</span><br><span class="line">BBWith2Succ         0</span><br><span class="line">-------------------------------------------------------</span><br><span class="line">#######################################################</span><br><span class="line"></span><br><span class="line">*********Constraint Graph Stats***************</span><br><span class="line">################ (program : ld-temp.o)###############</span><br><span class="line">-------------------------------------------------------</span><br><span class="line">AvgIn/OutEdge       0.884615</span><br><span class="line">AvgIn/OutAddrEdge   0.307692</span><br><span class="line">AvgIn/OutLoadEdge   0.0769231</span><br><span class="line">AvgIn/OutCopyEdge   0.423077</span><br><span class="line">MaxInAddrEdge       1</span><br><span class="line">MaxOutStoreEdge     1</span><br><span class="line">NumOfCGNode         102</span><br><span class="line">TotalValidNode      52</span><br><span class="line">AvgIn/OutStoreEdge  0</span><br><span class="line">TotalValidObjNode   17</span><br><span class="line">NumOfGeps           10</span><br><span class="line">NumOfCGEdge         30</span><br><span class="line">NumOfAddrs          16</span><br><span class="line">MaxOutAddrEdge      2</span><br><span class="line">NumOfLoads          4</span><br><span class="line">NumOfStores         4</span><br><span class="line">MaxOutLoadEdge      1</span><br><span class="line">NumOfCopys          12</span><br><span class="line">MaxOutCopyEdge      3</span><br><span class="line">MaxInStoreEdge      1</span><br><span class="line">MaxInLoadEdge       1</span><br><span class="line">MaxInCopyEdge       1</span><br><span class="line">#######################################################</span><br><span class="line"></span><br><span class="line">*********Andersen Pointer Analysis Stats***************</span><br><span class="line">################ (program : ld-temp.o)###############</span><br><span class="line">-------------------------------------------------------</span><br><span class="line">AvgTopLvlPtsSize    1</span><br><span class="line">AvgPtsSetSize       0.362745</span><br><span class="line">LoadStoreTime       0</span><br><span class="line">CollapseTime        0</span><br><span class="line">UpdateCGTime        0</span><br><span class="line">CopyGepTime         0</span><br><span class="line">SCCMergeTime        0</span><br><span class="line">SCCDetectTime       0</span><br><span class="line">TotalTime           0</span><br><span class="line">NullPointer         0</span><br><span class="line">PointsToBlkPtr      0</span><br><span class="line">TotalPWCCycleNum    0</span><br><span class="line">IndEdgeSolved       2</span><br><span class="line">TotalCycleNum       0</span><br><span class="line">IndCallSites        2</span><br><span class="line">PointsToConstPtr    0</span><br><span class="line">MaxPtsSetSize       1</span><br><span class="line">DYFieldObjs         2</span><br><span class="line">MemObjects          16</span><br><span class="line">Pointers            62</span><br><span class="line">NumOfFieldExpand    0</span><br><span class="line">DYFieldPtrs         2</span><br><span class="line">NumOfSFRs           0</span><br><span class="line">GepProcessed        10</span><br><span class="line">LoadProcessed       4</span><br><span class="line">CopyProcessed       11</span><br><span class="line">MaxNodesInSCC       0</span><br><span class="line">Iterations          3</span><br><span class="line">StoreProcessed      4</span><br><span class="line">AddrProcessed       16</span><br><span class="line">NumOfSCCDetect      3</span><br><span class="line">TotalObjects        18</span><br><span class="line">NodesInCycles       0</span><br><span class="line">TotalPointers       64</span><br><span class="line">#######################################################</span><br><span class="line">****Persistent Points-To Cache Statistics: bv-finalize****</span><br><span class="line">UniquePointsToSets       18</span><br><span class="line">TotalUnions              37</span><br><span class="line">PropertyUnions           37</span><br><span class="line">UniqueUnions             0</span><br><span class="line">LookupUnions             0</span><br><span class="line">PreemptiveUnions         0</span><br><span class="line">TotalComplements         304</span><br><span class="line">PropertyComplements      304</span><br><span class="line">UniqueComplements        0</span><br><span class="line">LookupComplements        0</span><br><span class="line">PreemptiveComplements    0</span><br><span class="line">TotalIntersections       8</span><br><span class="line">PropertyIntersections    8</span><br><span class="line">UniqueIntersections      0</span><br><span class="line">LookupIntersections      0</span><br><span class="line">PreemptiveIntersections  0</span><br><span class="line"></span><br><span class="line">****Memory SSA Statistics****</span><br><span class="line"></span><br><span class="line">************************</span><br><span class="line">################ (program : ld-temp.o)###############</span><br><span class="line">-------------------------------------------------------</span><br><span class="line">AverageRegSize      1</span><br><span class="line">SSARenameTime       0</span><br><span class="line">InsertPHITime       0</span><br><span class="line">GenMUCHITime        0</span><br><span class="line">GenRegionTime       0</span><br><span class="line">TotalMSSATime       0</span><br><span class="line">BBHasMSSAPhi        0</span><br><span class="line">StoreHasChi         2</span><br><span class="line">MaxRegSize          1</span><br><span class="line">MemRegions          4</span><br><span class="line">FunHasRetMu         4</span><br><span class="line">FunEntryChi         6</span><br><span class="line">StoreChiNode        2</span><br><span class="line">LoadMuNode          4</span><br><span class="line">MSSAPhi             0</span><br><span class="line">LoadHasMu           4</span><br><span class="line">CSChiNode           0</span><br><span class="line">CSMuNode            2</span><br><span class="line">CSHasChi            0</span><br><span class="line">FunRetMu            6</span><br><span class="line">FunHasEntryChi      2</span><br><span class="line">CSHasMu             1</span><br><span class="line">#######################################################</span><br><span class="line"></span><br><span class="line">****SVFG Statistics****</span><br><span class="line"></span><br><span class="line">************************</span><br><span class="line">################ (program : ld-temp.o)###############</span><br><span class="line">-------------------------------------------------------</span><br><span class="line">AvgWeight           1</span><br><span class="line">OptTime             0</span><br><span class="line">ATNodeTime          0</span><br><span class="line">TLNodeTime          0</span><br><span class="line">ConnDirEdgeTime     0</span><br><span class="line">ConnIndEdgeTime     0</span><br><span class="line">TotalTime           0</span><br><span class="line">MaxIndOutDeg        2</span><br><span class="line">AvgIndOutDeg        1</span><br><span class="line">Addr                16</span><br><span class="line">ActualOut           0</span><br><span class="line">ActualRet           0</span><br><span class="line">Copy                3</span><br><span class="line">ActualParam         7</span><br><span class="line">FormalRet           0</span><br><span class="line">ActualIn            2</span><br><span class="line">Gep                 10</span><br><span class="line">FormalParam         1</span><br><span class="line">TotalNode           60</span><br><span class="line">MaxOutDegree        5</span><br><span class="line">MSSAPhi             0</span><br><span class="line">FormalOut           6</span><br><span class="line">FormalIn            6</span><br><span class="line">IndRetEdge          0</span><br><span class="line">Store               4</span><br><span class="line">Load                4</span><br><span class="line">MaxIndInDeg         1</span><br><span class="line">IndCallEdge         2</span><br><span class="line">PHI                 0</span><br><span class="line">DirectCallEdge      1</span><br><span class="line">DirectEdge          33</span><br><span class="line">IndirectEdge        18</span><br><span class="line">DirectRetEdge       0</span><br><span class="line">AvgInDegree         0</span><br><span class="line">IndirectEdgeLabels  18</span><br><span class="line">AvgOutDegree        0</span><br><span class="line">TotalEdge           51</span><br><span class="line">MaxInDegree         3</span><br><span class="line">AvgIndInDeg         1</span><br><span class="line">#######################################################</span><br><span class="line">#functions: 12</span><br><span class="line">#affunctions: 2</span><br><span class="line">ind call:   call void %3() #7, !dbg !43, !is_icall !16, !mlta_info !44</span><br><span class="line">filename: example/main.c | 17,5 | *** 1 *** 1 *** 1 *** 1 *** 2</span><br><span class="line">MLTA target</span><br><span class="line"></span><br><span class="line">	A [SVF]  [TYPE]  [MLTA] </span><br><span class="line">	B [TYPE] </span><br><span class="line">ind call:   call void %9() #7, !dbg !47, !is_icall !16, !mlta_info !48</span><br><span class="line">filename: example/main.c | 18,5 | *** 1 *** 1 *** 1 *** 1 *** 2</span><br><span class="line">MLTA target</span><br><span class="line"></span><br><span class="line">	A [TYPE] </span><br><span class="line">	B [SVF]  [TYPE]  [MLTA] </span><br></pre></td></tr></table></figure>



<h1 id="MLTA"><a href="#MLTA" class="headerlink" title="MLTA"></a>MLTA</h1><blockquote>
<p>到底什么是识别间接调用？<br>    有address-taking的地方（全局变量静态初始化/存储指令）就发生了间接调用，识别间接调用就是在所有address-taken函数中，找出cll site可能对应的target函数(集)</p>
<p>类型是怎么提取的？<br>    llvm IR 里就有类型</p>
<p>第一步在whole-program bitcode分析类型层次。</p>
<ol>
<li><p>分析类型层次：</p>
<p>收集所有的address-taken functions</p>
<p>识别所有address-taking操作 ( 全局变量static initializer或者 store 指令)</p>
<p>分析address-taking操作确定memory object（函数指针变量）的multi-layer type。比如 b.a.handler，type为B.A.fptr_t。</p>
<p>将multi-layer type切分为多个two-layer type，B.A.fptr_t 会被切分为 fptr_t, A.fptr_t, B.A。并将这些信息添加到 type-function map，key 为two-layer type的hash值，value 是pointer object的type</p>
</li>
<li><p>分析类型传播: 分析 cast 操作确定pointer object是如何被传播到其它type，比如 *p=a。并通过 type-propagation map 记录操作数之间的关系，key 是 a 的type、value 是 p 的type。</p>
</li>
<li><p>捕获type escaping cases，如果不能确定一个type的所有它可以约束的icall target那么它就是个escaping type。比如，当primitive type被 cast 到composite type，因为不能确定primitive type的icall target，composite type也不能被确定，因此escape。这些type会保存在一个 escaped-type set 中。</p>
</li>
</ol>
<p>第二步对每个indirect-callsite进行求解，每一个callsite都会分配一个function set作为潜在调用集合。</p>
<ol>
<li>解析function pointer的type，并进一步拆分为多个two-layer type。</li>
<li>基于FLTA初始计算一个function set，然后迭代求解，从first layer求解到last layer。每一层的target set都会和前一层的target set相交。<br>如果当前type escape，那么停止求解，输出已求出的结果。<br>不然基于 type-propagation map，查找其它 cast 到当前类型的type。这些type会递归的收集并求解target set并求并集。</li>
</ol>
</blockquote>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/638892748">论文总结 a-19-ccs-Where Does It Go? Refining Indirect-Call Targets with Multi-Layer Type Analysis - 知乎</a></p>
<p>局限性：平均 icall 目标仍较多（不是所有间接调用都适用TYPEDIVE）、无法处理动态链接库等情况</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_44370676/article/details/134513475">基于类型匹配的间接调用分析-CSDN博客</a></p>
<p>不足：</p>
<p>3函数指针加载的type和分析保存了函数指针的type不一样，而这两个type之间的 cast 不在bc中，因此产生了漏报。</p>
<p>MLTA没有考虑函数指针cast的情况，(fptr_t)function_1 中 function_1 的类型为 i32 (i8*, i8*)<em>，没有考虑到 function_1 被cast到 void (i8</em>, i8*)* 的情况。这点在paper中也有提到，在 checking for Linux 段落中作者提到，由于参数类型 long int 和 char* 存在隐式类型转换，甚至返回值类型也有类型转换，因此在FLTA时会出现miss。</p>
<p>一个project（比如linux kernel）可能有多个module，MLTA目前是独立处理每个module，没有考虑module之间存在的数据依赖情况。这个在之后的工作TyPM中得到处理。</p>
<p>因此，MLTA出现漏报的主要原因是代码中多种多样的 cast，MLTA处理了confine函数指针的类型的 cast，但是并没有处理函数参数、返回值类型相关的 cast。同时，变参函数也给函数签名分析带来了挑战。</p>
</blockquote>
<p>clang version 15.0.0</p>
<p>build_llvm.sh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash -e</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># LLVM version: 15.0.0 </span></span><br><span class="line"></span><br><span class="line">ROOT=$(<span class="built_in">pwd</span>)</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/llvm/llvm-project.git</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$ROOT</span>/llvm-project</span><br><span class="line">git checkout e758b77161a7</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="string">&quot;build&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">  mkdir build</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line"></span><br><span class="line">cmake -DLLVM_TARGET_ARCH=<span class="string">&quot;X86&quot;</span> \</span><br><span class="line">			-DLLVM_TARGETS_TO_BUILD=<span class="string">&quot;ARM;X86;AArch64&quot;</span> \</span><br><span class="line">			-DLLVM_EXPERIMENTAL_TARGETS_TO_BUILD=WebAssembly \</span><br><span class="line">			-DCMAKE_BUILD_TYPE=Release \</span><br><span class="line">			-DLLVM_ENABLE_PROJECTS=<span class="string">&quot;clang;lldb&quot;</span> \</span><br><span class="line">			-G <span class="string">&quot;Unix Makefiles&quot;</span> \</span><br><span class="line">			../llvm</span><br><span class="line"></span><br><span class="line">make -j$(nproc)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="string">&quot;<span class="variable">$ROOT</span>/llvm-project/prefix&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">  mkdir <span class="variable">$ROOT</span>/llvm-project/prefix</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">cmake -DCMAKE_INSTALL_PREFIX=<span class="variable">$ROOT</span>/llvm-project/prefix -P cmake_install.cmake</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">make</span><br><span class="line">cd IRDumper</span><br><span class="line">make</span><br><span class="line">cd ../</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">export PATH=/home/hzlg/Desktop/mlta/llvm-project/prefix/bin/:$PATH</span><br><span class="line">export CXXFLAGS=&quot;-Wno-error -g -Xclang -no-opaque-pointers -Xclang -flegacy-pass-manager -Xclang -load -Xclang /home/hzlg/Desktop/mlta/IRDumper/build/lib/libDumper.so&quot;</span><br><span class="line">cd test/src</span><br><span class="line">clang++ $CXXFLAGS hello.cpp</span><br><span class="line">cd mlta</span><br><span class="line">./build/lib/kalalyzer hello.c.bc</span><br></pre></td></tr></table></figure>

<blockquote>
<img src="/2024/12/09/LLVM%20with%20gold%20plugin/image-20250217224357753.png" alt="image-20250217224357753" style="zoom:50%;"> 
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">编译HPCFI的main.c例子,结果是:</span><br><span class="line">[CallGraph] Updated in 0 modules.</span><br><span class="line">[CallGraph] Postprocessing ...</span><br><span class="line">[CallGraph] Done!</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@@ Total number of final callees: 3.</span><br><span class="line">############## Result Statistics ##############</span><br><span class="line"># Number of indirect calls: 			2</span><br><span class="line"># Number of indirect calls with targets: 	2</span><br><span class="line"># Number of indirect-call targets: 		3</span><br><span class="line"># Number of address-taken functions: 		2</span><br><span class="line"># Number of multi-layer calls: 			2</span><br><span class="line"># Number of multi-layer targets: 		3</span><br><span class="line"># Number of one-layer calls: 			0</span><br><span class="line"># Number of one-layer targets: 			0</span><br></pre></td></tr></table></figure>



<h1 id="DeepType"><a href="#DeepType" class="headerlink" title="DeepType"></a>DeepType</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_44370676/article/details/134513475">基于类型匹配的间接调用分析-CSDN博客</a> </p>
</blockquote>
<p>sudo apt-get install libz3-dev</p>
<p>-g -Xclang -no-opaque-pointers</p>
<blockquote>
<img src="/2024/12/09/LLVM%20with%20gold%20plugin/image-20250218174734953.png" alt="image-20250218174734953" style="zoom: 33%;"> 
</blockquote>
<h1 id="TFA"><a href="#TFA" class="headerlink" title="TFA"></a>TFA</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装llvm</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/llvm/llvm-project.git</span><br><span class="line">git checkout llvmorg-15-init</span><br><span class="line">mkdir build &amp;&amp; <span class="built_in">cd</span> build</span><br><span class="line">cmake -G <span class="string">&quot;Unix Makefiles&quot;</span> -DCMAKE_BUILD_TYPE=<span class="string">&quot;Release&quot;</span> -DLLVM_ENABLE_PROJECTS=<span class="string">&quot;clang;clang-tools-extra;lld;lldb;openmp&quot;</span> -DLLVM_ENABLE_RUNTIMES=<span class="string">&quot;libcxx;libcxxabi&quot;</span> ../llvm</span><br><span class="line">make -j8</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装mysql</span></span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt install -y mysql-server</span><br><span class="line"><span class="comment"># 启动mysql</span></span><br><span class="line">sudo systemctl start mysql</span><br><span class="line"><span class="comment"># 将mysql设置为开机启动</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> mysql</span><br><span class="line"><span class="comment"># 查看mysql状态</span></span><br><span class="line">sudo systemctl status mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录mysql，在默认安装时如果没有让我们设置密码，则直接回车就能登录成功。</span></span><br><span class="line">sudo mysql -uroot -p</span><br><span class="line"><span class="comment"># 设置密码 mysql8.0</span></span><br><span class="line">ALTER USER <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED WITH mysql_native_password BY <span class="string">&#x27;新密码&#x27;</span>;</span><br><span class="line"><span class="comment"># 刷新缓存</span></span><br><span class="line">flush privileges;</span><br><span class="line"><span class="comment"># 创建一个名为icall_data的数据库</span></span><br><span class="line">CREATE DATABASE icall_data;</span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 离线安装openmp，用不上，备份一下 https://blog.csdn.net/qq_37389133/article/details/130484512</span></span><br><span class="line"><span class="comment"># 在https://www.open-mpi.org/software/ompi/v4.1/下载.tar.gz</span></span><br><span class="line">tar zxvf openmpi-4.1.8.tar.gz</span><br><span class="line"><span class="comment"># 指定路径安装</span></span><br><span class="line">sudo mkdir /opt/openmp</span><br><span class="line">./configure --prefix=/opt/openmp</span><br><span class="line">make -j4</span><br><span class="line">sudo make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加环境路径</span></span><br><span class="line">sudo vim ~/.bashrc</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;<span class="variable">$PATH</span>:/opt/openmp/bin&quot;</span></span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=<span class="string">&quot;<span class="variable">$LD_LIBRARY_PATH</span>:/opt/openmp/lib&quot;</span></span><br><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br><span class="line"><span class="built_in">cd</span> ../examples</span><br><span class="line"><span class="comment"># 编译</span></span><br><span class="line">mpicc hello_c.c -o hello_c</span><br><span class="line"><span class="comment"># 运行</span></span><br><span class="line">mpirun -np 4 hello_c</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在线安装</span></span><br><span class="line"><span class="comment"># 安装openmp，默认gcc有openmp，lib路径在 /usr/lib/gcc/x86_64-linux-gnu/11/include/omp.h</span></span><br><span class="line"><span class="comment"># sudo apt install libomp-dev</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试openmp</span></span><br><span class="line"><span class="comment">#test_openmp.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#include &lt;omp.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;iostream&gt;</span></span><br><span class="line">int <span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="comment">#pragma omp parallel</span></span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Hello from thread &quot;</span> &lt;&lt; <span class="string">omp_get_thread_num() &lt;&lt; std::endl;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"># 编译</span></span><br><span class="line"><span class="string">g++ -fopenmp test_openmp.cpp -o test_openmp</span></span><br><span class="line"><span class="string"># 若运行 ./test_openmp 看到输出类似“Hello from thread 0”的信息，那么表示OpenMP已成功安装。</span></span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/dinghaoliu/TFA-project.git</span><br><span class="line"><span class="built_in">cd</span> TFA-project</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改MakeFile</span></span><br><span class="line">vim MakeFile</span><br><span class="line">LLVM_BUILD := /home/hzlg/Desktop/llvm-project/build</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取the include and library paths</span></span><br><span class="line">sudo apt install libmysqlclient-dev</span><br><span class="line">sudo apt install libomp-dev</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改src/CMakeLists.txt</span></span><br><span class="line">vim src/CMakeLists.txt</span><br><span class="line"><span class="comment"># Set your openmp include path here</span></span><br><span class="line"><span class="comment"># For Mac OS with openmp installed by brew, using the following flags</span></span><br><span class="line"><span class="built_in">set</span>(OMP_INCLUDE_DRIS <span class="string">&quot;/usr/lib/llvm-14/lib/clang/14.0.0/include&quot;</span>)</span><br><span class="line"><span class="built_in">set</span>(OMP_LIB_DRIS <span class="string">&quot;/usr/lib/llvm-14/lib&quot;</span>)</span><br><span class="line">include_directories(<span class="variable">$&#123;OMP_INCLUDE_DRIS&#125;</span>)</span><br><span class="line">link_directories(<span class="variable">$&#123;OMP_LIB_DRIS&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set your mysql include path here</span></span><br><span class="line"><span class="comment"># For Mac OS with mysql installed by brew, using the following flags</span></span><br><span class="line"><span class="built_in">set</span>(MYSQL_INCLUDE_DIRS <span class="string">&quot;/usr/include/mysql/&quot;</span>)</span><br><span class="line"><span class="built_in">set</span>(MYSQL_LIB_DRIS <span class="string">&quot;/usr/lib/mysql/&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改src/lib/utils/Common.cc</span></span><br><span class="line">vim src/lib/utils/Common.cc</span><br><span class="line"><span class="comment">#define LINUX_SOURCE &quot;/usr/src/linux-headers-6.8.0-52-generic/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改src/lib/utils/DBTools.cc，此处使用 Unix socket，不用密码，将user改为root，之前CREATE DATABASE icall_data;创建了一个数据库icall_data</span></span><br><span class="line">vim src/lib/utils/DBTools.cc</span><br><span class="line">//Use your own database config</span><br><span class="line">const char *server = <span class="string">&quot;localhost&quot;</span>;</span><br><span class="line">const char *user = <span class="string">&quot;root&quot;</span>;</span><br><span class="line">const char *<span class="built_in">pwd</span> = <span class="string">&quot;1&quot;</span>;</span><br><span class="line">const char *database = <span class="string">&quot;icall_data&quot;</span>;</span><br><span class="line"></span><br><span class="line">NPROC := <span class="variable">$&#123;shell sysctl -n hw.ncpu&#125;</span></span><br><span class="line">NPROC := $(shell nproc)  <span class="comment"># 修改: 使用 nproc 计算 CPU 核心数</span></span><br><span class="line"></span><br><span class="line">cmake <span class="variable">$&#123;1&#125;</span> \</span><br><span class="line">cmake <span class="variable">$&#123;1&#125;</span> <span class="variable">$&#123;CUR_DIR&#125;</span>/src \</span><br><span class="line"></span><br><span class="line">make</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">clang++ -emit-llvm -c -O0 -g source.c -o source.bc</span><br><span class="line">./build/lib/analyzer test.bc</span><br><span class="line">./build/lib/analyzer @bc.list</span><br></pre></td></tr></table></figure>



<h1 id="SVF-metadata"><a href="#SVF-metadata" class="headerlink" title="SVF+metadata"></a>SVF+metadata</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 直接sudo apt install cmake安装的cmake版本偏低，通过官网安装，此处选择3.23.0版本</span></span><br><span class="line">sudo wget https://cmake.org/files/v3.23/cmake-3.23.0.tar.gz</span><br><span class="line">sudo tar -zxvf cmake-3.23.0.tar.gz</span><br><span class="line"><span class="built_in">cd</span> cmake-3.23.0</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get -y install libssl-dev</span><br><span class="line">sudo ./configure</span><br><span class="line">sudo make -j8 </span><br><span class="line">sudo make install</span><br><span class="line">sudo cp ./bin/cmake /usr/bin/</span><br><span class="line">cmake --version</span><br><span class="line"></span><br><span class="line">wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -     <span class="comment"># 导入仓库公钥  </span></span><br><span class="line">sudo add-apt-repository <span class="string">&quot;deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-16 main&quot;</span>    <span class="comment"># 添加 Jammy (22.04) 的 Clang 16 仓库  </span></span><br><span class="line">sudo apt update  </span><br><span class="line"></span><br><span class="line">sudo apt install -y \</span><br><span class="line">  clang-16 llvm-16-dev llvm-16-tools libclang-cpp16-dev \</span><br><span class="line">  z3 libz3-dev</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> ~/Desktop/SVF</span><br><span class="line">mkdir Release-build &amp;&amp; <span class="built_in">cd</span> Release-build</span><br><span class="line">cmake -DCMAKE_BUILD_TYPE=Release \</span><br><span class="line">      -DSVF_ENABLE_ASSERTIONS=ON \</span><br><span class="line">      -DBUILD_SHARED_LIBS=ON \</span><br><span class="line">      -DLLVM_DIR=/usr/lib/llvm-16/lib/cmake/llvm \</span><br><span class="line">      -DZ3_DIR=/usr/lib/x86_64-linux-gnu/cmake/z3 \</span><br><span class="line">      ../</span><br><span class="line">make -j$(nproc)</span><br><span class="line"><span class="built_in">source</span> ../setup.sh Release</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> ../</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/SVF-tools/SVF.git</span><br><span class="line"><span class="built_in">cd</span> SVF/</span><br><span class="line">bash build.sh</span><br></pre></td></tr></table></figure>

<p>docker 安装SVF</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Add Docker&#x27;s official GPG key:</span></span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install ca-certificates curl</span><br><span class="line">sudo install -m 0755 -d /etc/apt/keyrings</span><br><span class="line">sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc</span><br><span class="line">sudo chmod a+r /etc/apt/keyrings/docker.asc</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add the repository to Apt sources:</span></span><br><span class="line"><span class="built_in">echo</span> \</span><br><span class="line">  <span class="string">&quot;deb [arch=<span class="subst">$(dpkg --print-architecture)</span> signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \</span></span><br><span class="line"><span class="string">  <span class="subst">$(. /etc/os-release &amp;&amp; echo <span class="string">&quot;<span class="variable">$&#123;UBUNTU_CODENAME:-<span class="variable">$VERSION_CODENAME</span>&#125;</span>&quot;</span>)</span> stable&quot;</span> | \</span><br><span class="line">  sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br><span class="line">  </span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span><br><span class="line">sudo docker run hello-world</span><br><span class="line"></span><br><span class="line">sudo docker pull svftools/svf</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="Baselines"><a href="#Baselines" class="headerlink" title="Baselines"></a>Baselines</h1><p>MLTA:Leverage extra composite type information</p>
<h1 id="例程"><a href="#例程" class="headerlink" title="例程"></a>例程</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_LEN 10</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*<span class="keyword">fptr_t</span>)</span><span class="params">(<span class="keyword">char</span> *, <span class="keyword">char</span> *)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">A</span> &#123;</span> <span class="keyword">fptr_t</span> handler; &#125; A;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">B</span> &#123;</span> A a; &#125; B; <span class="comment">// B is an outer layer of A</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">C</span> &#123;</span> A a; &#125; C; <span class="comment">// C is an outer layer of A</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">copy_with_check</span><span class="params">(<span class="keyword">char</span> *dst, <span class="keyword">char</span> *src)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">strlen</span>(src) &lt; MAX_LEN) <span class="built_in">strcpy</span>(dst, src);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">copy_no_check</span><span class="params">(<span class="keyword">char</span> *dst, <span class="keyword">char</span> *src)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">strcpy</span>(dst, src);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">function_1</span><span class="params">(<span class="keyword">char</span> *dst, <span class="keyword">char</span> *src)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">strcpy</span>(dst, src);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">function_2</span><span class="params">(<span class="keyword">char</span>* dst, <span class="keyword">char</span>* src)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">B bbs[] = &#123;</span><br><span class="line">	&#123; &#123;(<span class="keyword">fptr_t</span>)function_1&#125; &#125;,</span><br><span class="line">	&#123; &#123;(<span class="keyword">fptr_t</span>)function_2&#125; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Store functions with initializers</span></span><br><span class="line">B b = &#123; .a = &#123; .handler = &amp;copy_with_check &#125; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Store function with store instruction</span></span><br><span class="line">C c;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handle_input</span><span class="params">(<span class="keyword">char</span> *user_input)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">char</span> buf[MAX_LEN];</span><br><span class="line">	b.a.<span class="built_in">handler</span>(buf, user_input); <span class="comment">// safe</span></span><br><span class="line">	c.a.<span class="built_in">handler</span>(buf, user_input); <span class="comment">// buffer overflow !!</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span></span>&#123;</span><br><span class="line">	<span class="comment">/* code */</span></span><br><span class="line">	<span class="keyword">if</span> (argc &lt; <span class="number">2</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Usage: %s &lt;input&gt;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	c.a.handler = &amp;copy_no_check;</span><br><span class="line">	<span class="built_in">handle_input</span>(argv[<span class="number">1</span>]);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>DeepType outputs the following information of the analyzed program:<strong>DeepType 输出所分析程序的以下信息：</strong></p>
<ol>
<li>A list of indirect calls along with their respective targets.<strong>间接调用及其各自目标的列表。</strong></li>
<li>Total number of indirect calls and indirect call targets.<strong>间接调用和间接调用目标的总数。</strong></li>
<li>Average number of indirect call targets (ANT).<strong>间接调用目标 （ANT） 的平均数量。</strong></li>
<li>Execution time.<strong>执行时间。</strong></li>
</ol>
<p>​    </p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/CFI/" rel="tag"># CFI</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2024/12/03/indirect-call/LLVM-CFI/" rel="next" title="LLVM-CFI">
                <i class="fa fa-chevron-left"></i> LLVM-CFI
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2025/02/11/%E7%8E%AF%E5%A2%83%20%E5%B7%A5%E5%85%B7/vscode%20cpp%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/" rel="prev" title="vscode c++环境配置">
                vscode c++环境配置 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="" />
          <p class="site-author-name" itemprop="name"></p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">107</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">15</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Virtual-Box%E5%AE%89%E8%A3%85"><span class="nav-number">1.</span> <span class="nav-text">Virtual Box安装</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#LLVMCFI"><span class="nav-number">2.</span> <span class="nav-text">LLVMCFI</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#gcc4-9-3%E5%AE%89%E8%A3%85%E6%B5%81%E7%A8%8B"><span class="nav-number">2.1.</span> <span class="nav-text">gcc4.9.3安装流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#gcc5%E5%AE%89%E8%A3%85%E6%B5%81%E7%A8%8B"><span class="nav-number">2.2.</span> <span class="nav-text">gcc5安装流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#gcc7-5-0%E5%AE%89%E8%A3%85%E6%B5%81%E7%A8%8B"><span class="nav-number">2.3.</span> <span class="nav-text">gcc7.5.0安装流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#glod-plugin%E5%AE%89%E8%A3%85%E6%B5%81%E7%A8%8B"><span class="nav-number">2.4.</span> <span class="nav-text">glod plugin安装流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD%E5%B9%B6%E6%9E%84%E5%BB%BA-Gold-%E9%93%BE%E6%8E%A5%E5%99%A8%E4%B8%8E%E6%8F%92%E4%BB%B6%E6%94%AF%E6%8C%81"><span class="nav-number">2.4.1.</span> <span class="nav-text">下载并构建 Gold 链接器与插件支持</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LLVM-gold"><span class="nav-number">2.5.</span> <span class="nav-text">LLVM+gold</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LLVM-15%E5%AE%89%E8%A3%85%E6%B5%81%E7%A8%8B"><span class="nav-number">2.6.</span> <span class="nav-text">LLVM 15安装流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LLVM-3-7-0%E5%AE%89%E8%A3%85%E6%B5%81%E7%A8%8B"><span class="nav-number">2.7.</span> <span class="nav-text">LLVM 3.7.0安装流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#gold%E6%B5%8B%E8%AF%95"><span class="nav-number">2.8.</span> <span class="nav-text">gold测试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8LTO%E7%BC%96%E8%AF%91%E6%94%AF%E6%8C%81autotool%E7%9A%84%E9%A1%B9%E7%9B%AE"><span class="nav-number">2.9.</span> <span class="nav-text">使用LTO编译支持autotool的项目</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LLVMCFI%E5%AE%89%E8%A3%85%E6%B5%81%E7%A8%8B"><span class="nav-number">2.10.</span> <span class="nav-text">LLVMCFI安装流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LLVMCFI%E6%B5%8B%E8%AF%95"><span class="nav-number">2.11.</span> <span class="nav-text">LLVMCFI测试</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ArduPilot-4-1"><span class="nav-number">3.</span> <span class="nav-text">ArduPilot 4.1</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%80%E6%96%B0%E7%89%88-clang10"><span class="nav-number">3.1.</span> <span class="nav-text">最新版+clang10</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Copter-4-4-LLVMCFI"><span class="nav-number">3.2.</span> <span class="nav-text">Copter-4.4 + LLVMCFI</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Copter-4-1-LLVMCFI"><span class="nav-number">3.3.</span> <span class="nav-text">Copter-4.1 + LLVMCFI</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Copter-3-6-12"><span class="nav-number">3.4.</span> <span class="nav-text">Copter 3.6.12</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Ubuntu18-%E5%AE%89%E8%A3%85pynmeagps%E6%9C%89%E9%97%AE%E9%A2%98"><span class="nav-number">3.4.1.</span> <span class="nav-text">Ubuntu18 安装pynmeagps有问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ubuntu20-%E5%AE%89%E8%A3%85python-2-7-1%E6%9C%89%E9%97%AE%E9%A2%98"><span class="nav-number">3.4.2.</span> <span class="nav-text">Ubuntu20 安装python-2.7.1有问题</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#BetaFlight-4-3-maintenance"><span class="nav-number">4.</span> <span class="nav-text">BetaFlight 4.3-maintenance</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MatrixPilot"><span class="nav-number">5.</span> <span class="nav-text">MatrixPilot</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#paparazzi"><span class="nav-number">6.</span> <span class="nav-text">paparazzi</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#PX4"><span class="nav-number">7.</span> <span class="nav-text">PX4</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#HPCFI"><span class="nav-number">8.</span> <span class="nav-text">HPCFI</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MLTA"><span class="nav-number">9.</span> <span class="nav-text">MLTA</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#DeepType"><span class="nav-number">10.</span> <span class="nav-text">DeepType</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#TFA"><span class="nav-number">11.</span> <span class="nav-text">TFA</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SVF-metadata"><span class="nav-number">12.</span> <span class="nav-text">SVF+metadata</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Baselines"><span class="nav-number">13.</span> <span class="nav-text">Baselines</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BE%8B%E7%A8%8B"><span class="nav-number">14.</span> <span class="nav-text">例程</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">hzlg</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" target="_blank" rel="noopener" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" target="_blank" rel="noopener" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

</body>
</html>
